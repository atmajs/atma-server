(function(e,n){"use strict";var t,r;"undefined"==typeof exports||e!==exports&&null!=e&&e!==global||(t=r=global),null==t&&(t="undefined"==typeof window?global:window),null==r&&(r=e||t),n(t,r)})(this,function(e,n){"use strict";function t(e,n){if(null==e&&(e={}),null==n)return e;for(var t in n)e[t]=n[t];return e}function r(e){return Array.isArray(e)}function i(){for(var e,n=process.argv,t=n.length,r=2,i={args:[]};t>r;r++)if(e=n[r],"-"!==e[0]){var o=e.indexOf("=");-1===o?i.args.push(e):i[e.substring(0,o)]=e.substring(o+1)}else i[e.replace(/^[\-]+/,"")]=!0;return i}var o,s,l,a,u={};e.include&&e.net&&e.net.Uri&&(s=e),null==s&&e.atma&&(s=e.atma),null==s&&(require("atma-libs/globals-dev"),s=e),e.logger&&(a=e.logger),null==a&&(require("atma-logger"),a=e.logger),e.io&&e.io.File&&(l=e.io),null==l&&(require("atma-io"),l=e.io);var c=s.net,f=s.Class,h=s.ruta,d=s.mask,g=s.include,v=h.Collection,a=e.logger,p=function(){function e(e,n){for(var t,r=e.handlers,i=0,o=r.length;o>i;i++)if(t=r[i],t.matcher.test(n))return t.handler;return null}function n(e,n){var t=e.services,r=t.get(n);return r}function t(e,n){if(47===e.charCodeAt(0))return e;var t=n&&n.location;if(null==t)return console.error("[Handler] Path is relative but no location. Set handler: {location: X} in config"),e;var r,i,o=e.split("/"),r=t.split(/[\{\}]/g);for(e=r[0],i=1;r.length>i;i++)if(0===i%2)e+=r[i];else{var s=r[i]<<0;if(s>o.length-1&&(s=o.length-1),e+=o[s],i===r.length-2)for(s++;o.length>s;s++)e+="/"+o[s]}return e}function r(e,n){return RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n)}return f({Construct:function(){this.handlers=[],this.services=new v,this.pages=new v},registerPages:function(e){var n,t;for(t in e)n=e[t],this.pages.add(n.path,n);return this},registerHandlers:function(e,n){for(var i in e)this.handlers.push({matcher:r(i),handler:t(e[i],n)});return this},registerServices:function(e,n){for(var r in e)this.services.add(r,t(e[r],n));return this},get:function(t,r){var i=e(this,t.url);if(i)return"string"==typeof i?(g.instance().js(i+"::Handler").done(function(e){r(new e.Handler)}),void 0):(r(i),void 0);var o=n(this,t.url);if(o){var s=o.value;return"string"==typeof s?(g.instance().js(s+"::Service").done(function(e){r(new e.Service)}),void 0):(r(s),void 0)}var o=this.pages.get(t.url);if(o){var l=o.value;return r(new u.HttpPage(l)),void 0}r(null)}})}();u.IHttpHandler=f({Extends:f.Deferred,process:function(){this.reject("Not Implemented",500)}}),u.HttpPage=function(){var e=function(){var e={getScripts:function(e){var t=n("scripts",e).slice();return this.data.controller&&t.push("/public/view/"+this.data.view+"/"+this.data.controller+".js"),t},getStyles:function(e){var t=n("styles",e);return t}},n=f.Fn.memoize(function(e,n){function t(e){if(null!=e)for(var n in e)i.register(n,e[n])}function r(e){null!=e&&i.each("js",e,function(e,n){o.push(n.path)})}var i=new includeLib.Routes,o=[];return t(n.client.routes),t(n.both.routes),r(n.client[e]),r(n.both[e]),o});return e}(),n=f({Extends:[f.Deferred,e],template:null,master:null,route:null,Construct:function(e){var n=app.config.page;this.template=n.getTemplate(e)+"::Template",this.master=n.getMaster(e)+"::Master",this.route=n.route,this.data=e},process:function(e,n){return this.onRenderStart&&this.onRenderStart(e,n),this.query=h.parse(this.route,e.url).params,this.cntx={req:e,res:n,page:this},this.load(this.response),this},load:function(){g.instance().load(this.master,this.template).done(this.response)},Self:{response:function(e){var n=e.load.Master,t=e.load.Template;if("master"===this.query.debug)return this.resolve(n),void 0;if("template"===this.query.debug)return this.resolve(t),void 0;this.query.breakOn&&(this.cntx.debug={breakOn:this.query.breakOn}),n&&d.render(d.parse(n));var r=d.render(t,this.model,this.cntx);return this.cntx.async?(this.cntx.done(this.resolve.bind(this)).fail(this.fail.bind(this)),void 0):(this.resolve(r),void 0)}}});return n}(),u.HttpService=function(){var e={Extends:f.Deferred,process:function(e,n){var t=e.url,r=this.routes.get(t);if(null==r)return this.reject("Service Endpoint not Found: "+t,404),this;var i=r.value;return i.call(this,e,n),this}};return function(n){var t,r,i=new h.Collection;for(t in n)r=t[0],("/"===r||"!"===r)&&i.add(t,n[t]);n.routes=i;for(t in e)n[t]=e[t];return f(n)}}(),function(){function n(e){return function(n,t,r){g.instance().js(e.config.env.server.scripts).js(e.config.env.both.scripts).done(function(){e.handlers.get(n,function(i){return e.autoreloadEnabled&&m.watch(n.url),null==i?(r(),void 0):(a(95).log("<request>",n.url),i.process(n,t).done(function(e,n,r,i){if(n&&(t.statusCode=n),"string"==typeof r&&t.setHeader("Content-Type",r),i)for(var o in i)t.setHeader(o,i[o]);t.end(e)}).fail(function(e,n){t.statusCode=n,t.end(e)}),void 0)})})}}function t(e){return function(){var n=e.config;a(90).log("<app.config>",n),e.handlers.registerHandlers(n.handlers,n.handler).registerServices(n.services,n.service).registerPages(n.pages),e.resolve(e)}}var s=function(){function n(e,n){var r={env:{client:{routes:null,scripts:null,styles:null},server:{routes:null,scripts:null},both:{routes:null,scripts:null}},page:{location:null,include:null},pages:null,handler:{location:null},handlers:null,service:{location:null},services:null,passport:{},app:{}};return t(r,e,n)}function t(e,n,t){return Array.isArray(n)===!1?(t("[Application.Config] should be an array of file names"),e):(n=n.map(function(e){return"/server/config/"+e+".yml::"+e.replace(/\//g,".")}),n.push("/public/build/stats.json::build"),g.instance().load(n).done(i(e,t)),e)}function i(e,n){function t(e,n,r){if(null!=r&&-1!==r.indexOf(".")){for(var i=r.split("."),o=i.length-1,s=0;o>s;s++)e=e[i[s]]||(e[i[s]]={});t(e,n)}else for(var l in n)e[l]=n[l]}return function(r){var i,o,l=r.load;for(i in l)o=l[i],null!=o&&t(e,o,i);e["compos-info"]&&d.compoDefinitions(e["compos-info"]),e.env.both.routes&&g.routes(e.env.both.routes),e.env.both.include&&g.cfg(e.env.both.include.cfg),e.env.server.include&&g.cfg(e.env.server.include.cfg),e.env.server.routes&&g.routes(e.env.server.routes),s.prepairIncludes(e.env.server.scripts),s.prepairIncludes(e.env.client.scripts);var a=e.pages;if(a){var c,f;for(c in a)f=a[c],f.path=c,null==f.id&&(f.id=c.substring(c.indexOf("/")+1)),""===f.id&&(f.id=f.view||"index"),null==f.view&&(f.view=f.id);for(c in a)f=a[c],a[f.id]=f,delete a[c]}u(e),n()}}var s=function(){function e(n,t){if(null!=n)for(var r in t)"object"!=typeof t[r]?"function"!=typeof t[r]||(n[r]=t[r]):e(n[r],t[r])}var n,t=function(){return{format:function(e,n){if(47===n.charCodeAt(0))return n;var t,r,i=n.split("/"),t=e.split(/[\{\}]/g);for(n=t[0],r=1;t.length>r;r++)if(0===r%2)n+=t[r];else{var o=t[r]<<0;if(o>i.length-1&&(o=i.length-1),n+=i[o],r===t.length-2)for(o++;i.length>o;o++)n+="/"+i[o]}return n}}}(),i=function(){function e(e,t){return null==t?e:"string"==typeof t?(e.src=t,e):(t.src&&(e.src=t.src),t.cfg&&(e.cfg=n(e.cfg,t.cfg,"loader"),t.cfg.loader&&(e.cfg.loader=n(e.cfg.loader,t.cfg.loader))),t.routes&&n(e.routes,t.routes),e)}function n(e,n,t){if(null==n)return e;null==e&&(e={});for(var r in n)r!==t&&(e[r]=n[r]);return e}var t={getScripts:f.Fn.memoize(function(e){var n=o.config,t=r("scripts",n.env).slice();return e&&(t=t.concat(this.getScriptsForPageOnly(e))),t}),getScriptsForPageOnly:f.Fn.memoize(function(e){var n=o.config,t=n.pages[e],i=[];if(null==t)return a.error("<page:scripts> Page not defined",e),null;if(t.scripts&&(i=i.concat(r("page",n.env,t.scripts,t.routes))),t.view&&t.view.controller){var s=n.formatPath(this.location.viewController,t.view.controller);i.push(s)}return i}),getStyles:function(e){var n=o.config,t=r("styles",n.env).slice(),i=n.pages[e];if(null==i)return e&&console.error("[404] Page is not defined",e),t;if(i.styles){var s=r("page",n.env,i.styles,i.routes);Array.prototype.push.apply(t,s)}return t},getStylesForPageOnly:function(e){var n=o.config,t=n.pages[e];return t&&t.styles?r("page",n.env,t.styles,t.routes).slice():[]},getInclude:function(){var n=o.config.env,t={src:"",routes:{},cfg:{}};return e(t,n.both.include),e(t,n.client.include),t.src||console.error('[FATAL ERROR] Include PATH is not specified, use in client.yml/json include: { src: "PATH" }'),e(t,{routes:n.both.routes}),e(t,{routes:n.client.routes}),t},getIncludeForPageOnly:function(n){var t=o.config.pages[n],r={};return t&&t.include?e(r,t.include):r},getTemplate:function(e){var n=e.template||this.index.template;return o.config.formatPath(this.location.template,n)},getMaster:function(e){var n=e.master||this.index.master;return o.config.formatPath(this.location.master,n)}},r=f.Fn.memoize(function(e,n,t,r){function i(e){if(null!=e)for(var n in e)s.register(n,e[n])}function o(e){null!=e&&s.each("js",e,function(e,n){l.push(n.path)})}var s=new includeLib.Routes,l=[];switch(i(n.client.routes),i(n.both.routes),e){case"page":i(r),o(t);break;case"debug":o(n.client.debug);break;default:o(n.client[e]),o(n.both[e])}return l});return t}(),s=function(){function e(o){if(null!=o)if(r(o)){for(var s,l=o,a=o.length,u=0;a>u;u++)if(s=l[u],null!=s&&"string"!=typeof s){var c=t(s);if(null!=c)if(i(c)){var f=n(l,u,c.value);a+=f,u+=f}else l.splice(u,1),u--,a--;else e(s)}}else if("object"==typeof o)for(var h in o)e(o[h])}function n(e,n,t){return r(t)?(Array.prototype.splice.apply(e,[n,1].concat(t)),t.length):(e.splice(n,1,t),1)}function t(e){for(var n in e)return"if#"!==n.substring(0,3)?null:{key:n.substring(3),value:e[n]};return null}function i(e){return o.args[e.key]}return{prepair:function(n){e(n)}}}(),l={page:i,formatPath:t.format};return{attach:function(t){n=t,e(t,l)},prepairIncludes:s.prepair}}(),u=s.attach;return n.getList=function(n){if(null==e.io||null==l.Directory)return console.error("atma-io seems to be not loaded"),null;var t=l.env.currentDir.combine(n),r=new l.Directory(t).readFiles("**.yml").files.map(function(e){return e.uri.toRelativeString(t).replace(".yml","")});return r},n}();u.Application=f({Extends:f.Deferred,Construct:function(e){if(null==e&&(e={}),this instanceof u.Application==!1)return new u.Application(e);o=this,this.handlers=new p;var n=e.configs||"server/config/",r=e.configs;return null==r&&(r=s.getList(n)),this.config=s(r,t(this)),this.args=i(),this},responder:function(){return n(this)},autoreload:function(e){this.autoreloadEnabled=!0,m.listen(e)},autoreloadEnabled:!1})}(),g.cfg({loader:{coffee:{process:function(e){return require("coffee").compile(e)}}}}),g.cfg({loader:{less:{process:function(e,n,t){var r=n.path_getFile(),i=n.path_getDir(),o=require("less"),s=new o.Parser({filename:r,paths:[i]});s.parse(e,function(e,n){var i;if(e)return a.error("<less:parse>",r,e),void 0;try{i=n.toCSS()}catch(e){a.error("<less:toCss>",r,e)}t(i)})}}}}),g.cfg({loader:{yml:{process:function(e){var n=require("yamljs");e=e.replace(/\t/g,"  ");try{return n.parse(e)}catch(t){return a.error("<yml parser>",t),null}}}}});var m=function(){var n={},t=function(){var e=c.Uri.combine(process.cwd(),"/"),n=f({Base:f.EventEmitter,Construct:function(e){this.active=!1,this.file=new l.File(e)},Self:{fileChanged:function(e){a.log("<watcher:changed>",e),this.trigger("fileChange",e)}},bind:function(e){this.on("fileChange",e),this.active||(l.File.watcher.watch(this.file,this.fileChanged),this.active=!0)},unbind:function(e){this.off("fileChange",e),0===this._listeners.length&&l.File.watcher.unwatch(this.file.uri.toLocalFile())}}),t={};return new new f({Base:f.EventEmitter,watch:function(e){var r=e.uri.toLocalFile();if(null==t[r]){var i;i=new n(r),i.bind(this.fileChanged),t[r]=i}},unwatch:function(e){var n=e.uri.toLocalFile();return null==t[n]?(a.log("<watcher> No watchers",n),void 0):(t[n].unbind(callback),delete t[n],void 0)},isWatching:function(e){var n=e.uri.toLocalFile();return null!=t[n]},Self:{fileChanged:function(n){n=n.replace(e,"");var t=this;g.bin_tryReload(n,function(){t.trigger("fileChange",n)})}},bind:function(e){return this.on("fileChange",e),this},unbind:function(e){return this.off("fileChange",e),this}})}();n["/browser"]=f({Construct:function(e){a.log("<socket> Connected"),this.socket=e,e.on("disconnect",this.disconnected),t.bind(this.fileChanged)},Self:{fileChanged:function(e){a.log("<autoreload> path",e),this.socket.emit("filechange",e)},disconnected:function(){t.unbind(this.fileChanged)}}});var r={listen:function(t){function r(e,n){return function(e){new n(e,o)}}a.log("<Autoreload> Socket opened".green.bold);var i=e.io;delete e.io;var o=require("socket.io").listen(t,{"log level":0});e.io=i;for(var s in n)o.of(s).on("connection",r(s,n[s]))},getConnectionHandler:function(e){return n[e]}},i=new c.Uri(process.cwd()+"/");return{watch:function(e){var n="/"===e[0]?1:0,r=e.indexOf("?"),o=-1===r?e.length:r;e=e.substring(n,o);var s=i.combine(e),a=new l.File(s);a.uri.file&&(t.isWatching(a)||a.exists()!==!1&&t.watch(a))},unwatch:function(e){t.unwatch(new l.File(e))},listen:function(e){r.listen(e)}}}();return null!=n.atma&&"object"==typeof n.atma?(t(n.atma,u),void 0):(n.atma={server:u},void 0)});