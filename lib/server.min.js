(function(e,t){"use strict";var n,r;"undefined"==typeof exports||e!==exports&&null!=e&&e!==global||(n=r=global),null==n&&(n="undefined"==typeof window?global:window),null==r&&(r=e||n),t(n,r)})(this,function(e,t){"use strict";function n(e,t){if(null==e&&(e={}),null==t)return e;for(var n in t)e[n]=t[n];return e}function r(e,t){return function(){return e.apply(t,arguments)}}function i(e){return Array.isArray(e)}function o(){for(var e,t=process.argv,n=t.length,r=2,i={args:[]};n>r;r++)if(e=t[r],"-"!==e[0]){var o=e.indexOf("=");-1===o?i.args.push(e):i[e.substring(0,o)]=e.substring(o+1)}else i[e.replace(/^[\-]+/,"")]=!0;return i}var s,l,a,c,u,f,h,g,d,v,p,m={};e.include&&e.net&&e.net.Uri&&(a=e),null==a&&e.atma&&(a=e.atma),null==a&&(require("atma-libs/globals-dev"),a=e),e.logger&&(p=e.logger),null==p&&(require("atma-logger"),p=e.logger),e.io&&e.io.File&&(c=e.io),null==c&&(require("atma-io"),c=e.io),u=a.net,f=a.Class,h=a.ruta,g=a.mask,d=a.include,v=h.Collection,p=e.logger;var y=function(){function e(e,t){for(var n,r=e.handlers,i=0,o=r.length;o>i;i++)if(n=r[i],n.matcher.test(t))return n.handler;return null}function t(e,t){var n=e.services,r=n.get(t);return r}function n(e,t){if(47===e.charCodeAt(0))return e;var n=t&&t.location;if(null==n)return console.error("[Handler] Path is relative but no location. Set handler: {location: X} in config"),e;var r,i,o=e.split("/"),r=n.split(/[\{\}]/g);for(e=r[0],i=1;r.length>i;i++)if(0===i%2)e+=r[i];else{var s=r[i]<<0;if(s>o.length-1&&(s=o.length-1),e+=o[s],i===r.length-2)for(s++;o.length>s;s++)e+="/"+o[s]}return e}function r(e,t){return RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),t)}return f({Construct:function(){this.handlers=[],this.services=new v,this.pages=new v},registerPages:function(e){var t,n;for(n in e)t=e[n],this.pages.add(t.path,t);return this},registerHandlers:function(e,t){for(var i in e)this.handlers.push({matcher:r(i),handler:n(e[i],t)});return this},registerServices:function(e,t){for(var r in e)this.services.add(r,n(e[r],t));return this},get:function(n,r){if(null!=r){var i=e(this,n);if(i)return"string"==typeof i?(d.instance().js(i+"::Handler").done(function(e){r(new e.Handler)}),void 0):(r(i),void 0);var o=t(this,n);if(o){var l=o.value;return"string"==typeof l?(d.instance().js(l+"::Service").done(function(e){r(new e.Service)}),void 0):(r(l),void 0)}var o=this.pages.get(n);if(o){var a=o.value,c=o.current.params,u=s.config.page.getController(a);return null==u?(r(new m.HttpPage(a,c)),void 0):(d.instance().js(u+"::Controller").done(function(e){r(new e.Controller(a,c))}),void 0)}r(null)}}})}();m.IHttpHandler=f({Extends:f.Deferred,process:function(){this.reject("Not Implemented",500)}}),m.HttpPage=function(){function e(e){for(var t=e;t.Base;)t=t.Base;return t.Base=i,f(e)}function t(e){var t=e.ctx;return null==t.rewriteCount&&(t.rewriteCount=1),++t.rewriteCount>5?(e.reject("Too much rewrites, last path: "+t.rewrite),void 0):function(n){return null==n?(e.reject("Rewritten Path is not valid",t.rewrite),void 0):(n.process(t.req,t.res).done(r(e.resolve,e)).fail(r(e.reject,e)),void 0)}}var n=function(){var e={getScripts:function(){return s.config.page.getScripts(this.data.id)},getStyles:function(){return s.config.page.getStyles(this.data.id)}};return e}(),i=f({Extends:[f.Deferred,n],template:null,master:null,route:null,Construct:function(t,n){if(this instanceof i==!1)return e(t);var r=s.config.page;this.template=r.getTemplate(t)+"::Template",this.master=r.getMaster(t)+"::Master",this.data=t,this.query=n},process:function(e,t){return this.ctx={req:e,res:t,page:this},this.load(),this},load:function(){d.instance().load(this.master,this.template).done(r(this.response,this))},response:function(e){var n=e.load.Master,i=e.load.Template;if("master"===this.query.debug)return this.resolve(n),void 0;if("template"===this.query.debug)return this.resolve(i),void 0;this.query.breakOn&&(this.ctx.debug={breakOn:this.query.breakOn}),n&&g.render(g.parse(n)),this.onRenderStart&&this.onRenderStart(this.ctx.req,this.ctx.res);var o=g.render(this.nodes||i,this.model,this.ctx);return this.ctx.rewrite?(s.handlers.get(this.ctx.rewrite,t(this)),void 0):this.ctx.async?(this.ctx.done(r(this.resolve,this)).fail(r(this.fail,this)),void 0):(this.resolve(o),void 0)}});return i}(),m.HttpService=function(){var e={Extends:f.Deferred,process:function(e,t){var n=e.url,r=this.routes.get(n);if(null==r)return this.reject("Service Endpoint not Found: "+n,404),this;var i=r.value;return i.call(this,e,t),this}};return function(t){var n,r,i=new h.Collection;for(n in t)r=n[0],("/"===r||"!"===r)&&i.add(n,t[n]);t.routes=i;for(n in e)t[n]=e[n];return f(t)}}(),function(){function t(e){return function(t,n,r){d.instance().js(e.config.env.server.scripts).js(e.config.env.both.scripts).done(function(){e.handlers.get(t.url,function(i){return e.autoreloadEnabled&&w.watch(t.url),null==i?(r(),void 0):(p(95).log("<request>",t.url),i.process(t,n).done(function(e,t,r,i){if(t&&(n.statusCode=t),"string"==typeof r&&n.setHeader("Content-Type",r),i)for(var o in i)n.setHeader(o,i[o]);n.end(e)}).fail(function(e,t){n.statusCode=t,n.end(e)}),void 0)})})}}function n(e){return function(){var t=e.config;p(90).log("<app.config>",t),e.handlers.registerHandlers(t.handlers,t.handler).registerServices(t.services,t.service).registerPages(t.pages),e.resolve(e)}}var r=function(){function t(e,t){var i={env:{client:{routes:null,scripts:null,styles:null},server:{routes:null,scripts:null},both:{routes:null,scripts:null}},page:{location:null,include:null},pages:null,handler:{location:null},handlers:null,service:{location:null},services:null,passport:{},app:{},build:{}};return n(i,l),r(i,e,t)}function n(e,t){if(Array.isArray(e)&&Array.isArray(t)){for(var r,i=0,o=t.length;o>i;i++)r=t[i],-1===e.indexOf(r)&&e.push(r);return e}if("object"!=typeof t&&"object"!=typeof e)return p.log("<cfg extend> not an object or type missmatch"),e;var s,l;for(s in t)if(l=t[s],null!=e[s])if(Array.isArray(l)){if(Array.isArray(e[s])===!1){p.log("<cfg extend> type missmatch",s,l,e[s]),e[s]=l;continue}n(e[s],l)}else e[s]="object"!=typeof l||"object"!=typeof e[s]?l:n(e[s],l);else e[s]=l;return e}function r(e,t,n){return Array.isArray(t)===!1?(n("[Application.Config] should be an array of file names"),e):(t=t.map(function(e){return""+h.combine(e+".yml")+"::"+e.replace(/\//g,".")}),t.push("/public/build/stats.json::build"),d.instance().load(t).done(o(e,n)),e)}function o(e,t){function r(e,t,n){if(null!=n&&-1!==n.indexOf(".")){for(var i=n.split("."),o=i.length-1,s=0;o>s;s++)e=e[i[s]]||(e[i[s]]={});r(e,t)}else for(var l in t)e[l]=t[l]}return function(i){var o,s,l=i.load,c={};for(o in l)s=l[o],null!=s&&r(c,s,o);n(e,c),e["compos-info"]&&g.compoDefinitions(e["compos-info"]),e.env.both.routes&&d.routes(e.env.both.routes),e.env.both.include&&d.cfg(e.env.both.include.cfg),e.env.server.include&&d.cfg(e.env.server.include.cfg),e.env.server.routes&&d.routes(e.env.server.routes),a.prepairIncludes(e.env.server.scripts),a.prepairIncludes(e.env.client.scripts);var f=e.pages;if(f){var h,v;for(h in f)v=f[h],v.path=h,null==v.id&&(v.id=h.substring(h.indexOf("/")+1)),""===v.id&&(v.id=v.view||"index"),null==v.view&&(v.view=v.id);for(h in f)v=f[h],f[v.id]=v,delete f[h]}u(e),t()}}var a=function(){function e(t,n){if(null!=t)for(var r in n)"object"!=typeof n[r]?"function"!=typeof n[r]||(t[r]=n[r]):e(t[r],n[r])}var t,n=function(){return{format:function(e,t){if(47===t.charCodeAt(0))return t;var n,r,i=t.split("/"),n=e.split(/[\{\}]/g);for(t=n[0],r=1;n.length>r;r++)if(0===r%2)t+=n[r];else{var o=n[r]<<0;if(o>i.length-1&&(o=i.length-1),t+=i[o],r===n.length-2)for(o++;i.length>o;o++)t+="/"+i[o]}return t}}}(),r=function(){function e(e,n){return null==n?e:"string"==typeof n?(e.src=n,e):(n.src&&(e.src=n.src),n.cfg&&(e.cfg=t(e.cfg,n.cfg,"loader"),n.cfg.loader&&(e.cfg.loader=t(e.cfg.loader,n.cfg.loader))),n.routes&&t(e.routes,n.routes),e)}function t(e,t,n){if(null==t)return e;null==e&&(e={});for(var r in t)r!==n&&(e[r]=t[r]);return e}var n={getScripts:f.Fn.memoize(function(e){var t=s.config,n=r("scripts",t.env).slice();return e&&(n=n.concat(this.getScriptsForPageOnly(e))),n}),getScriptsForPageOnly:f.Fn.memoize(function(e){var t=s.config,n=t.pages[e],i=[];if(null==n)return p.error("<page:scripts> Page not defined",e),null;if(n.scripts&&(i=i.concat(r("page",t.env,n.scripts,n.routes))),n.view&&n.view.controller){var o=t.formatPath(this.location.viewController,n.view.controller);i.push(o)}return i}),getStyles:function(e){var t=s.config,n=r("styles",t.env).slice();return e&&(n=n.concat(this.getStylesForPageOnly(e))),n},getStylesForPageOnly:function(e){var t=s.config,n=t.pages[e],i=[];if(null==n)return p.error("<page:styles> Page not defined",e),null;if(n.styles&&(i=i.concat(r("page",t.env,n.styles,n.routes))),n.view&&n.view.style){var o=t.formatPath(this.location.viewStyle,n.view.style);i.push(o)}return i},getInclude:function(){var t=s.config.env,n={src:"",routes:{},cfg:{}};return e(n,t.both.include),e(n,t.client.include),n.src||console.error('[FATAL ERROR] Include PATH is not specified, use in client.yml/json include: { src: "PATH" }'),e(n,{routes:t.both.routes}),e(n,{routes:t.client.routes}),n},getIncludeForPageOnly:function(t){var n=s.config.pages[t],r={};return n&&n.include?e(r,n.include):r},getTemplate:function(e){var t=e.template||e.id||this.index.template;return s.config.formatPath(this.location.template,t)},getMaster:function(e){var t=e.master||this.index.master;return s.config.formatPath(this.location.master,t)},getController:function(e){var t=e.controller||this.index.controller;return t?s.config.formatPath(this.location.controller,t):null}},r=f.Fn.memoize(function(e,t,n,r){function i(e){if(null!=e)for(var t in e)s.register(t,e[t])}function o(e){null!=e&&s.each("js",e,function(e,t){l.push(t.path)})}var s=new includeLib.Routes,l=[];switch(i(t.client.routes),i(t.both.routes),e){case"page":i(r),o(n);break;case"debug":o(t.client.debug);break;default:o(t.client[e]),o(t.both[e])}return l});return n}(),o=function(){function e(o){if(null!=o)if(i(o)){for(var s,l=o,a=o.length,c=0;a>c;c++)if(s=l[c],null!=s&&"string"!=typeof s){var u=n(s);if(null!=u)if(r(u)){var f=t(l,c,u.value);a+=f,c+=f}else l.splice(c,1),c--,a--;else e(s)}}else if("object"==typeof o)for(var h in o)e(o[h])}function t(e,t,n){return i(n)?(Array.prototype.splice.apply(e,[t,1].concat(n)),n.length):(e.splice(t,1,n),1)}function n(e){for(var t in e)return"if#"!==t.substring(0,3)?null:{key:t.substring(3),value:e[t]};return null}function r(e){return s.args[e.key]}return{prepair:function(t){e(t)}}}(),l={page:r,formatPath:n.format};return{attach:function(n){t=n,e(n,l)},prepairIncludes:o.prepair}}(),u=a.attach,h=new c.Directory("server/config/");return t.getList=function(t){if(null==e.io||null==c.Directory)return console.error("atma-io seems to be not loaded"),null;h=c.env.currentDir.combine(t);var n=new c.Directory(h).readFiles("**.yml").files.map(function(e){return e.uri.toRelativeString(h).replace(".yml","")});return n},t}();m.Application=f({Extends:f.Deferred,Construct:function(e){if(null==e&&(e={}),this instanceof m.Application==!1)return new m.Application(e);s=this,this.handlers=new y;var t=e.configs||"server/config/",i=e.configs;return null==i&&(i=r.getList(t)),this.config=r(i,n(this)),this.args=o(),this.args.debug!==!0&&p.cfg("color","none"),this},responder:function(){return t(this)},autoreload:function(e){this.autoreloadEnabled=!0,w.listen(e),d.cfg("autoreload",w)},autoreloadEnabled:!1})}(),d.cfg({loader:{coffee:{process:function(e){return require("coffee").compile(e)}}}}),d.cfg({loader:{less:{process:function(e,t,n){var r=t.path_getFile(),i=t.path_getDir(),o=require("less"),s=new o.Parser({filename:r,paths:[i]});s.parse(e,function(e,t){var i;if(e)return p.error("<less:parse>",r,e),void 0;try{i=t.toCSS()}catch(e){p.error("<less:toCss>",r,e)}n(i)})}}}}),d.cfg({loader:{yml:{process:function(e){var t=require("yamljs");e=e.replace(/\t/g,"  ");try{return t.parse(e)}catch(n){return p.error("<yml parser>",n),null}}}}});var w=function(){var t={},n=function(){var e=u.Uri.combine(process.cwd(),"/").replace(/\\/g,"/"),t=f({Base:f.EventEmitter,Construct:function(e){this.active=!1,this.file=new c.File(e)},Self:{fileChanged:function(e){p.log("<watcher:changed>",e),this.trigger("fileChange",e,"filewatcher")}},bind:function(e){this.on("fileChange",e),this.active||(c.File.watcher.watch(this.file,this.fileChanged),this.active=!0)},unbind:function(e){this.off("fileChange",e),0===this._listeners.length&&c.File.watcher.unwatch(this.file.uri.toLocalFile())}}),n={};return new new f({Base:f.EventEmitter,watch:function(e){var r=e.uri.toLocalFile();if(null==n[r]){var i;i=new t(r),i.bind(this.fileChanged),n[r]=i}},unwatch:function(e){var t=e.uri.toLocalFile();return null==n[t]?(p.log("<watcher> No watchers",t),void 0):(n[t].unbind(callback),delete n[t],void 0)},isWatching:function(e){var t=e.uri.toLocalFile();return null!=n[t]},Self:{fileChanged:function(t){"include"!==t&&(t=t.replace(e,"")),this.trigger("fileChange",t)}},bind:function(e){return this.on("fileChange",e),this},unbind:function(e){return this.off("fileChange",e),this}})}();t["/browser"]=f({Construct:function(e){p.log("<socket> Connected"),this.socket=e,e.on("disconnect",this.disconnected),n.bind(this.fileChanged)},Self:{fileChanged:function(e){p.log("<autoreload> path",e),this.socket.emit("filechange",e)},disconnected:function(){n.unbind(this.fileChanged)}}});var r={listen:function(n){function r(e,t){return function(e){new t(e,o)}}p.log("<Autoreload> Socket opened".green.bold);var i=e.io;delete e.io;var o=require("socket.io").listen(n,{"log level":0});e.io=i;for(var s in t)o.of(s).on("connection",r(s,t[s]))},getConnectionHandler:function(e){return t[e]}},i=new u.Uri(process.cwd()+"/");return{watch:function(e){var t="/"===e[0]?1:0,r=e.indexOf("?"),o=-1===r?e.length:r;e=e.substring(t,o);var s=i.combine(e),l=new c.File(s);l.uri.file&&(n.isWatching(l)||l.exists()!==!1&&n.watch(l))},unwatch:function(e){n.unwatch(new c.File(e))},listen:function(e){r.listen(e)},fileChanged:function(e){n.fileChanged(e)},isWatching:function(e){return"string"==typeof e&&(e=new c.File(e)),n.isWatching(e)}}}();return l=[{handler:{location:"/server/http/handler/{0}.js"},page:{location:{controller:"/server/http/page/{0}/{1}.js",template:"/server/http/page/{0}/{1}.mask",master:"/server/http/master/{0}.mask",viewTemplate:"/public/view/{0}/{1}.mask",viewController:"/public/view/{0}/{1}.js",viewStyle:"/public/view/{0}/{1}.less"},extension:{javascript:"js",style:"less",template:"mask"},index:{template:"index",master:"default"}},pages:{"!/":{id:"index",title:"Default Title"}},service:{location:"/server/http/service/{0}.js"},view:{location:{template:"/public/view/{0}/{1}.mask",controller:"/public/view/{0}/{1}.js",style:"/public/view/{0}/{1}.less"}}}][0],null!=t.atma&&"object"==typeof t.atma?(n(t.atma,m),void 0):(t.atma={server:m},void 0)});