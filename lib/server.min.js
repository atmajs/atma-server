!function(e,t){"use strict";var n,r;"undefined"==typeof exports||e!==exports&&null!=e&&e!==global||(n=r=global),null==n&&(n="undefined"==typeof window?global:window),null==r&&(r=e||n),t(n,r)}(this,function(e,t){"use strict";function n(e,t){if(null==e&&(e={}),null==t)return e;for(var n in t)e[n]=t[n];return e}function r(e){return Array.isArray(e)}function i(){for(var e,t=process.argv,n=t.length,r=2,i={args:[]};n>r;r++)if(e=t[r],"-"!==e[0]){var o=e.indexOf("=");-1===o?i.args.push(e):i[e.substring(0,o)]=e.substring(o+1)}else i[e.replace(/^[\-]+/,"")]=!0;return i}function o(e){o=function(){},function(){function t(e,t){var n=["/public/build/styles.css"],r=t.page.data,i=r.id,o=t.config.build[i];return o.styles&&n.push("/public/build/"+i+"/styles.css"),n}var n=e.config.debug||e.config.$get("app.debug"),r="each (.) > link type='text/css' rel='stylesheet' href='~[.]';";p.registerHandler("atma:styles",f({mode:"server:all",nodes:p.parse(r),cache:{byProperty:n&&"ctx.page.id"},renderStart:function(r,i){this.model=n?i.page.getStyles():t(e,i)}}))}(),function(){var t;!function(){var e="/public/build/",n=["			\n\n			if (load) >\n\n				:html > '~[load]'\n\n			\n\n					\n\n					\n\n			script\n\n				src='/public/build/scripts.js?v=~[buildVersion]'\n\n				type='text/javascript'\n\n				;\n\n			\n\n			if (pageId) >\n\n				script\n\n					src='/public/build/~[pageId]/scripts.js?v=~[buildVersion]'\n\n					type='text/javascript'\n\n					;\n\n			\n\n			\n\n			\n\n			script type='text/javascript' > :html > '''\n\n				\n\n					include\n\n						.allDone(function(){\n\n							var App = Compo({ compos: {} });\n\n								\n\n							window.app = new App;\n\n							\n\n							mask.Compo.bootstrap(document.body, app);\n\n						})\n\n						;\n\n			'''"][0];t=Compo({mode:"server:all",template:n,cache:{byProperty:"ctx.page.id"},onRenderStart:function(t,n){if(null==n.config.build)return void v.error("<Application is not built>").warn("To execute the DEV version use `--debug` flag: `node index --debug`".bold).warn("To build the application run `atma custom node_modules/atma-server/tools/build`");var r=n.page.data,i=r.id,o=n.config.build[i],s=this;if(this.model={buildVersion:n.config.buildVersion},null==o)return void v.error("<atma:scripts> No page info",i,"Build could be faily");Compo.pause(this,n);var a=n.config.base,l=[c.Uri.combine(a,e,"load.html::app")];i&&o.load&&l.push(c.Uri.combine(a,e,i,"load.html::page")),h.instance().load(l).done(function(e){var t=e.load.app;e.load.page&&(t+=e.load.page),s.model.load=t,Compo.resume(s,n)})}})}();var n;!function(){var e=["		\n\n		<script type='text/javascript' src='%INCLUDE%'></script>\n\n		<script type='text/javascript'>\n\n			window.DEBUG = true;\n\n			\n\n			include\n\n				.cfg(%CFG%)\n\n				.routes(%ROUTES%)\n\n				.js(%SCRIPTS%)\n\n				.done(function(){\n\n					\n\n					var start = new Date(),\n\n						App = Compo({\n\n							compos: {}\n\n						});\n\n						\n\n						\n\n					window.app = new App;\n\n					\n\n					\n\n					mask.Compo.bootstrap(document.body, app);\n\n					\n\n					console.log('Render - ', new Date() - start);\n\n				});\n\n			\n\n		</script>"][0];n=Compo({mode:"server:all",scripts:null,renderStart:function(e,t){this.include=t.config.$getInclude(),this.scripts=t.config.$getScripts(t.page.data.id).map(function(e){return"'"+e+"'"}).join(",\n")},toHtml:function(){return e.replace("%CFG%",JSON.stringify(this.include.cfg,null,4)).replace("%ROUTES%",JSON.stringify(this.include.routes,null,4)).replace("%INCLUDE%",this.include.src).replace("%SCRIPTS%",this.scripts)}})}();var r=e.config.debug||e.config.$get("app.debug")?n:t;p.registerHandler("atma:scripts",r)}()}var s,a,l,u,c,f,d,p,h,g,v,m={},b=Array.prototype.slice;e.include&&e.net&&e.net.Uri&&(l=e),null==l&&e.atma&&(l=e.atma),null==l&&(require("atma-libs/globals-dev"),l=e),e.logger&&(v=e.logger),null==v&&(require("atma-logger"),v=e.logger),e.io&&e.io.File&&(u=e.io),null==u&&(require("atma-io"),u=e.io),c=l.net,f=l.Class,d=l.ruta,p=l.mask,h=l.include,g=d.Collection,v=e.logger;var y,w,C;!function(){var e=";charset=utf-8";y="application/json"+e,w="text/html"+e,C="text/plain"+e}();var S,x,j,_,P;!function(){S=function(e){return"string"==typeof e},x=function(e){return"function"==typeof e},j=function(e){return void 0!==e&&"object"==typeof e},_=Array.isArray,P=function(){var e;return function(){return null==e&&(e=Boolean(s.args.debug||s.config.debug)),e}}()}();var E,A;!function(){E=function(e,t){return function(){return e.apply(t,arguments)}},A=function(e){var t=b.call(arguments,1);return function(){e.apply(null,t.concat(b.call(arguments)))}}}();var H,$,k;!function(){var e=Object.prototype.toString;H=function(e,t,n){try{var r=JSON.stringify(t)}catch(i){return $(e,T("Json Serialization"))}k(e,r,200,y,n)},$=function(t,n,r){var i=JSON.stringify({error:n.toString!==e?n.toString():n,stack:n.stack});k(t,i,n.statusCode||500,y,r)},k=function(e,t,n,r,i){if("string"!=typeof t&&t instanceof Buffer==0)return j(t)?void H(e,t,i):t instanceof Error?void $(e,t,i):void $(e,T("Unexpected content response"));if(e.setHeader("Content-Type",r||w),e.statusCode=n||200,null!=i)for(var o in i)e.setHeader(o,i[o]);e.end(t)}}(),RegExp.prototype.toJSON=RegExp.prototype.toString;var D,F,R,O,T;!function(){function e(e,t,n){var r=m[e]=f({Base:D,Construct:function(){if(this instanceof r==0){var e=[null].concat(b.call(arguments));return new(r.bind.apply(r,e))}},statusCode:n,name:t});return r}m.HttpError=D=f({Construct:function(e,t){return this instanceof D==0?new D(e,t):(this.error_=new Error,this.message=e,void(null!=t&&(this.statusCode=t)))},name:"HttpError",statusCode:500,get stack(){for(var e=this.error_.stack.split("\n"),t=e.length,n=1,r=1,i=/\[as \w+Error\]/;++r<t&&!i.test(e[r]););return e.splice(1,r-n+1),e.join("\n")},toString:function(){return this.message?this.name+": "+this.message:this.name}}),R=e("RequestError","Bad Request",400),O=e("SecurityError","Forbidden",403),F=e("NotFoundError","Not Found",404),T=e("RuntimeError","Internal Server Error",500)}();var q=function(){function e(e,n,r,i,o,s){var a=n.get(r,i);if(null==a)return!1;var l=a.value.controller||a.value;if(null==l)return v.error("<routing> no controller",r),!1;if(x(l))return s(new l(a)),!0;if(S(l)){var u=c.Uri.combine(o,l);return t(e,u,a,s),!0}return x(l.process)?(s(l),!0):(v.error("<routing> invalid controller",l),!1)}function t(e,t,n,r){e.app.resources.js(t+"::Handler").done(function(e){return null==e.Handler?(v.error("<handler> invalid route",t),void r(new o)):x(e.Handler.prototype.process)?(P()===!1&&(n.value.controller=e.Handler),j(e.Handler)&&x(e.Handler.process)?void r(e.Handler):void r(new e.Handler(n))):(v.error("<handler> invalid interface - process function not implemented"),void r(new o))})}function n(e,t){if(47===e.charCodeAt(0))return e;if(-1!==e.indexOf("://"))return e;var n=t&&t.location;if(null==n)return v.error("<Handler> Path is relative but no location. Set handler: {location: X} in config").error(e,t),e;var r,i,o=e.split("/"),r=n.split(/[\{\}]/g);for(e=r[0],i=1;i<r.length;i++)if(i%2===0)e+=r[i];else{var s=r[i]<<0;if(s>o.length-1&&(s=o.length-1),e+=o[s],i===r.length-2)for(s++;s<o.length;s++)e+="/"+o[s]}return e}var r=["subapps","handlers","services","pages"],i=f({Construct:function(e){this.app=e;for(var t=r.length;--t>-1;)this[r[t]]=new g},registerPages:function(e){var t,n;for(n in e)t=e[n],null==t.controller?t.controller=m.HttpPage:S(t.controller)&&(t.controller=s.config.$getController(t)),this.pages.add(t.route,t);return this},registerHandlers:function(e,t){for(var n in e)this.registerHandler(n,e[n],t);return this},registerHandler:function(e,t,r){S(t)&&(t={controller:n(t,r)}),this.handlers.add(e,t)},registerSubApps:function(e,t){for(var n in e)this.registerSubApp(n,e[n],t);return this},registerSubApp:function(e,t){var n=e;"^"!==n[0]&&("/"!==n[0]&&(n="/"+n),n="^"+n),this.subapps.add(n,new m.HttpSubApplication(e,t))},registerServices:function(e,t){for(var n in e)this.registerService(n,e[n],t);return this},registerService:function(e,t,r){x(t)?t={controller:t}:S(t)&&(t={controller:t}),S(t.controller)&&(t.controller=n(t.controller,r)),this.services.add(e,t)},registerWebsockets:function(e){for(var t in e)this.registerWebsocket(t,e[t]);return this},registerWebsocket:function(e,t){return S(t)?void h.instance().js(t+"::Handler").done(function(t){U.registerHandler(e,t.Handler)}):void U.registerHandler(e,t)},get:function(t,n,i){var o=n.url,a=n.method,l=t.config.base;"POST"===a&&n.body&&n.body._method&&(a=n.body._method);for(var u,c=r.length,f=-1;++f<c;)if(u=r[f],e(this,this[u],o,a,l,i))return;if(this.app!==s){var d=s.handlers,p=s.config,h=e(d,d.handlers,o,a,p.base||l,i);if(h)return}i(null)},has:function(e,t){for(var n=r.length,i=-1;++i<n;)if(null!=this[r[i]].get(e,t))return!0;return!1}}),o=f({Base:f.Deferred,process:function(){return this.reject("Invalid Routing")}});return i}();m.IHttpHandler=f({Extends:f.Deferred,process:function(){this.reject("Not Implemented",500)}}),m.HttpPage=function(){function e(e,t,n,r){this.config=t,this.page=e,this.req=n,this.res=r,this._rewrite=null,this._redirect=null}var t,n,r,i,o,a,l,u;!function(){t=function(e){return e.middleware&&(e.middleware=new MiddlewareRunner(e.middleware)),null==e.Base?e.Base=g:null==e.Extends?e.Extends=g:Array.isArray(e)?e.Extends.push(g):e.Extends=[g,e.Extends],f(e)},n=function(e){var t=e.ctx;return null==t.rewriteCount&&(t.rewriteCount=1),++t.rewriteCount>5?void e.reject("Too much rewrites, last path: "+t._rewrite):function(n){return null==n?void e.reject("Rewritten Path is not valid: "+t._rewrite):void n.process(t.req,t.res).done(e.resolveDelegate()).fail(e.rejectDelegate())}},i=function(e,t,n,i){return function(o){return o?void e.reject(o):void r(e,t,n,i)}},r=function(t,n,r,i){if(t.route){var o=d.parse(t.route,n.url).params;for(var a in o)null==t.query[a]&&(t.query[a]=o[a])}if(t.ctx=new e(t,i,n,r),"secure"in t.data){var l=n.user,u=t.data.secure,c=u&&u.role;if(null==l||(c&&l.isInRole(c))===!1)return t.ctx.redirect(s.config.page.urls.login),t}return t._load()},o=function(e,t){null==e.ctx._redirect&&e.resolve(t)},a=function(e,t){if(null==e||""===e)return null;var n=e.indexOf("::");return-1!==n&&(e=e.slice(0,-n)),e+"::"+t},l=function(e,t){return function(n){k(e,n,t.statusCode||500,w)}},u=function(e,t){return function(n){var r=j(n)?JSON.stringify(n):n;r+="\nError: "+t.message,k(e,"ErrorPage Failed: "+r,500,C)}}}();var c=function(){var e={getScripts:function(){return s.config.$getScripts(this.data.id)},getStyles:function(){return s.config.$getStyles(this.data.id)}};return e}();e.prototype={redirect:function(e,t){null==t&&(t=302),this.res.statusCode=t,this.res.setHeader("Location",e),this.res.setHeader("Content-Length","0"),this.res.end(),this._redirect=e},rewrite:function(e){this._rewrite=e}};var g=f({Extends:[f.Deferred,c],template:null,master:null,ctx:null,middleware:null,templatePath:null,masterPath:null,compoPath:null,route:null,model:null,send:null,Construct:function(e){if(this instanceof g==0)return t(e);var n=s.config;this.route=n.page.route;var r=e;if(!r||!r.value)return void v.error("<httppage> current route value is unedefined");var i=this.data=r.value;this.query=r.current&&r.current.params,i.masterPath&&(this.masterPath=i.masterPath),i.templatePath&&(this.templatePath=i.templatePath),i.master&&(this.masterPath=n.$getMaster(i)),i.template&&(this.templatePath=n.$getTemplate(i)),i.compo&&(this.compoPath=n.$getCompo(i)),null==this.template&&null==this.compoPath&&null==this.templatePath&&(this.templatePath=n.$getTemplate(i)),null==this.master&&null==this.masterPath&&(this.masterPath=n.$getMaster(i))},process:function(e,t,n){return null==this.middleware?r(this,e,t,n):(this.middleware.process(e,t,i(this,e,t,n),n),this)},sendError:function(e,t,n){var r,i=s.config.page,o=i.errors,a=i.error;t instanceof Error?r=t:S(t)?r=new D(t,n):j(t)&&(r=new D(JSON.stringify(t),n));var c=o&&o[r.statusCode]||a;return null==c?void u(e,r)("No Error Page in Configuration"):(this.masterPath=s.config.$getMaster(c)+"::Master",this.templatePath=c.template+"::Template",this.compoPath=null,this.model=r,void this.defer().done(l(e,r)).fail(u(e,r))._load())},_load:function(){return this.resource=h.instance().load(a(this.masterPath,"Master"),a(this.templatePath,"Template")).js(a(this.compoPath,"Compo")).done(E(this._response,this)),this},_response:function(e){var t=e.load.Master||this.master,r=e.load.Template||this.template,i=e.Compo;if(null==t)return void this.reject(D("Page: Masterpage not found"));if(null==r&&null==i)return void this.reject(D("Page: Template not found"));if("master"===this.query.debug)return void this.resolve(t);if("template"===this.query.debug)return void this.resolve(r);this.query.breakOn&&(this.ctx.debug={breakOn:this.query.breakOn}),t&&p.render(p.parse(t)),null!=i&&(r&&null==i.template&&(i.template=r),null==i.mode&&(i.mode="server"),this.nodes=new p.Dom.Component("",null,i)),x(this.onRenderStart)&&this.onRenderStart(this.model,this.ctx);var a=p.render(this.nodes||r,this.model,this.ctx,null,this);return null!=this.ctx._rewrite?void s.handlers.get(this.ctx._rewrite,n(this)):this.ctx.async?void this.ctx.done(A(o,this)).fail(this.rejectDelegate()):void o(this,a)}});return g}(),m.HttpService=function(){function e(e){var n,r;"string"==typeof e?(n=e,r=b.call(arguments,1)):r=b.call(arguments);var s,a,l,u=t(r),c=new d.Collection,p=u.ruta||u;for(s in p)l=p[s],a=null,x(l)&&(a={process:l}),null==a&&_(l)&&(a={process:new i(l)}),null==a&&j(l)&&(a=l),null!=a&&_(a.process)&&(a.process=new i(a.process)),null!=a&&x(a.process)!==!1?c.add(s,a):v.warn("<HttpService> `process` is not a function"+s+typeof a.process);return u.routes=c,null!=n&&(u.name=n),null==u.Extends?u.Extends=o:Array.isArray(u.Extends)?u.Extends.push(o):u.Extends=[o,u.Extends],f(u)}function t(e){if(1===e.length)return e[0];for(var t,n,r=e[0],i=r.ruta||r,o=e.length,s=0;++s<o;){t=e[s],n=t.ruta||t;for(var a in n)null!=n[a]&&(i[a]=n[a]);if(null!=t.ruta)for(var a in t)"ruta"!==a&&null!=t[a]&&(r[a]=t[a])}return r}var n,r;!function(){n=function(e,t){if(null==t)return!0;if(t===!0||null==t.role)return null!=e.session||null!=e.user;var n=e.user,r=t.role;return null!=n&&(null==r||n.isInRole(r))},r=function(e,t){var n=e.body;return null==n?"Message Body is not defined":f.validate(n,t)}}();var i=function(){function e(e,r,i,o,s,a){if(!(a>=e.length)){var l,u=e[a];l=u.call(r,i,o,s,t(e,r,i,o,s,a)),l&&n(r,l)}}function t(t,r,i,o,s,a){return function(l){return l?n(r,l):void e(t,r,i,o,s,++a)}}function n(e,t){"string"==typeof t&&(t=D(t)),e.reject(t)}var r=f.Collection(Function,{Base:f.Serializable,process:function(t,n,r,i){e(this,t,n,r,i,0)}});return function(e){var t,n=new r(e);return function(e,r,i){t=this,n.process(t,e,r,i)}}}();!function(){function e(e,t){t.done(e.resolveDelegate()).fail(e.rejectDelegate())}m.HttpCrudEndpoints={Single:function(t,n){var r={},i=t,o=m.HttpService.classParser(t,n),s=m.HttpService.classPatchParser(t,n),a=f.properties(n);return Object.keys(a).forEach(function(e){a["?"+e]=a[e],delete a[e]}),r["$get /"+t+"/:id"]={meta:{response:a},process:function(t,r,i){e(this,n.fetch({_id:i.id}))}},r["$put /"+t+"/:id"]={meta:{description:"Update existed entity",arguments:a,response:a},process:[o,function(t,n,r){var i=t[a];i._id=r.id,e(this,i.save())}]},r["$post /"+t]={meta:{description:"Create new entity",arguments:a,response:a},process:[o,function(t){var n=t[i];delete n._id,e(this,n.save())}]},r["$delete /"+t+"/:id"]={meta:{description:"Remove entity"},process:function(t,r,i){var o=new n({_id:i.id});e(this,o.del())}},r["$patch /"+t+"/:id"]={meta:{description:"Modify existed entity. `patch object` syntax is similar to MongoDB's"},process:[s,function(t,r,i){var o=t.body,s=new n({_id:i.id}).patch(o);e(this,s)}]},r},Collection:function(t,n){var r={},i=t,o=m.HttpService.collectionParser(i,n),s=f.properties(n.prototype._ctor);r["$get /"+t]={meta:{response:[s]},process:function(){e(this,n.fetch({}))}};var a={meta:{description:"Create or update(if _id is present) entries",arguments:[s]},process:[o,function(t){e(this,t[i].save())}]};return r["$put /"+t]=a,r["$post /"+t]=a,r["$delete /"+t]={meta:{arguments:[{_id:"string"}]},process:[function(e,t,r,o){if(Array.isArray(e.body)===!1)return void o("Invalid arguments. Array expected");for(var s=e.body.length,a=-1;++a<s;)if(!e.body[a]._id)return void o("`_id` property expected at "+a);e[i]=new n(e.body)},function(t){e(this,t[i].del())}]},r["$patch /"+t]={meta:{description:"<is not supported>"},process:function(){this.reject(HttError("`PATCH` is not supported for collections"))}},r}}}(),function(){function t(e,t){var n,r;for(r in e){if(void 0===t[r])return"Unexpected property "+r;if(n=typeof e[r],"undefined"!==n&&n!==t[r])return"Type mismatch "+n+"/"+t[r]}return null}var n="<service> Model deserialization: ";e.classParser=function(e,r){var i=f.properties(r);return function(o,s,a,l){if(null==o.body)return void l("Body is not defined");var u=t(o.body,i);return null!=u?void l(n+u):(o[e]=new r(o.body),u=f.validate(o[e]),null!=u&&(u=n+u),void l(u))}},e.collectionParser=function(e,r){var i=f.properties(r.prototype._ctor);return function(o,s,a,l){if(Array.isArray(o.body)===!1)return void l("Array expected");for(var u,u,c=o.body.length,d=-1;++d<c;)if(u=t(o.body[d],i),null!=u)return void l(n+u);for(o[e]=new r(o.body),d=-1;++d<c;)if(u=f.validate(o[e][d]),null!=u)return void l(n+u);l()}},e.classPatchParser=function(e,t){var n=f.properties(t);return function(e,t,r,i){if(null==e.body)return i("Body is not defined");var o=e.body.$set;if(o){var s,a,l;for(a in o){if(l=a.indexOf("."),-1!==l&&(a=a.substring(0,l)),void 0===n[a])return i("Unexpected property "+a);if(s=typeof e.body[a],"undefined"!==s&&s!==n[a])return i("Type mismatch "+s+"/"+n[a])}}i()}}}();var o=f({Extends:f.Deferred,secure:null,Construct:function(e){if(null!=e){for(var t=e.path,n=0,r=t.length,i=0;r>n&&"string"==typeof t[n];n++)i+=t[n].length+1;this.rootCharCount=i,"secure"in e.value&&(this.secure=e.value.secure||{})}},help:function(){for(var e,t,n,r=this.routes.routes,i=[],o=-1,s=r.length;++o<s;)e=r[o],t={method:e.method||"*",path:e.definition},n=e.value.meta,n&&(t.description=n.description,t.arguments=n.arguments,t.response=n.response,"secure"in e.value&&(t.secure=e.value.secure||!0)),i.push(t);return i},process:function(e,t){var i=e.url.indexOf("?");if(-1!==i&&/\bhelp\b/.test(e.url.substring(i)))return this.resolve(this.help());if(n(e,this.secure)===!1)return this.reject(O("Access Denied"));var o=e.url.substring(this.rootCharCount),s=this.routes.get(o,e.method);if(null==s){var a=this.name||"<service>",l=o||"/";return this.reject(F(a+": endpoint not Found: <"+e.method+"> "+l))}var u=s.value,c=u.meta,f=c&&c.arguments;if(null!=c&&n(e,c.secure)===!1)return this.reject(O("Access Denied"));if(null!=f){var d=r(e,f);if(d)return this.reject(R(d))}return u.process.call(this,e,t,s.current.params),this}});return e.Barricade=i,e}();var U=function(){function t(e,t){return function(e){new t(e,n)}}var n,r={},i=function(){},o={listen:function(o){this.listen=i,v.log("Web socket opened".green.bold);var s=e.io;delete e.io,n=require("socket.io").listen(o,{"log level":2}),e.io=s;for(var a in r)n.of(a).on("connection",t(a,r[a]))},getHandler:function(e){return r[e]},registerHandler:function(e,i){r[e]=i,null!=n&&n.of(e).on("connection",t(e,i))}};return o}();!function(){function e(e){return function(n,r,i){e.autoreloadEnabled&&B.watch(n.url);var o=e.middleware?t(e.middleware):d;null==i&&(i=A(y,null,n,r)),l(e,n,r,i,o)}}function t(e){return function(t,n,r,i){e.process(r,i,function(e){return e?void $(i,e):void d(t,n,r,i)})}}function l(e,t,n,r,i){b(e,function(){e.handlers.get(e,t,function(o){return null==o?r():void i(e,o,t,n)})})}function d(e,t,n,r){v(95).log("<request>",n.url),t.process(n,r,e.config),null!=t.done&&t.done(function(e,n,i,o){var s=t.send||k;s(r,e,n,i,o)}).fail(function(e,n){var i=t.sendError||$;i(r,e,n||500)})}function g(e){return function(){var t=e.config;return v(90).log("<app.config>",t),o(e),e.handlers.registerSubApps(t.subapps,t.subapp).registerHandlers(t.handlers,t.handler).registerServices(t.services,t.service).registerPages(t.pages),P()?void e.resolve(e):null!=e.resources?(v.error("<unreachable mark>"),void e.resolve(e)):void b(e,function(){e.resolve(e)})}}function b(e,t){if(P()&&null!=e.resources)return void t();var n=e.config,r=n.base,i=n.env;e.resources=h.instance(r).setBase(r).js(i.server.scripts).js(i.both.scripts),e.resources.done(function(r){n.projects&&n.projects.forEach(function(t){var n=r[t];null!=n&&"function"==typeof n.attach&&n.attach(e)}),t()})}function y(e,t,n){return e?void $(n,e):void k(n,D("Request not processed "+t.url,422))}var w,C=function(){function e(e,r){e=e||{};var s,p,h=e.base,g=e.configs;if(null!=h){"/"===h[0]&&(h=h.substring(1));var v=new c.Uri(h);h=v.isRelative()?u.env.currentDir.combine(v).toString():v.toString()}null==h&&(h=u.env.currentDir.toString()),void 0===g&&(//! not a `null`-check, as `null` is also acceptable
g=h+l),g&&(s=h+(e.buildDirectory||d)),e.config&&(p={config:e.config});var y=[{config:JSON.parse(a)},{config:{base:h}},g?{path:g}:null,s?{path:s,optional:!0}:null,{config:m},{path:"package.json",getterProperty:"atma",optional:!0},{config:b},p];return Array.isArray(e.sources)&&($source=y.concat(e.sources)),require("appcfg").fetch(y).fail(function(e){throw new Error("<app:configuration>",e)}).done(function(){var e=this;e.defer(),new f.Await(n(e),t(e),i(e,r),o(e,r)).always(function(){e.resolve()})})}var t,n,i,o,l="server/config/**.yml",d="public/build/stats.json",g=function(){return{format:function(e,t){if(47===t.charCodeAt(0))return t;var n,r,i=t.split("/"),n=e.split(/[\{\}]/g);for(t=n[0],r=1;r<n.length;r++)if(r%2===0)t+=n[r];else{var o=n[r]<<0;if(o>i.length-1&&(o=i.length-1),t+=i[o],r===n.length-2)for(o++;o<i.length;o++)t+="/"+i[o]}return t}}}(),m={$formatPath:g.format};!function(){t=function(e){e.env.both.routes&&h.routes(e.env.both.routes),e.env.both.include&&h.cfg(e.env.both.include.cfg),e.env.server.include&&h.cfg(e.env.server.include.cfg),e.env.server.routes&&h.routes(e.env.server.routes),y.prepair(e.env.server.scripts),y.prepair(e.env.client.scripts)},n=function(e){var t=e.mask;null!=t&&p.compoDefinitions(t.compos,t.utils,t.attributes)},i=function(e){var t=e.pages;if(null!=t){var n,r;for(r in t)n=t[r],null==n.id&&(n.id=r.replace(/[^\w_-]/g,"_").replace(/[_]{2,}/g,"_")),null==n.route&&(n.route=r),t[n.id]&&t[n.id]!==n&&v.error("<page:register> overwrite existed ID",r.bold,t[n.id]===n),t[n.id]=n,delete t[r]}},o=function(e,t){if(null==e.plugins)return null;if(t.isRoot===!1)return null;var n=new f.Await,r=e.plugins.map(function(t){for(var n,r=new c.Uri(e.base),i="node_modules/"+t+"/index.js";;){if(n=r.combine(i),u.File.exists(n))return n.toString();if(r=r.combine("../"),""===r.path||"/"===r.path)return i}});return h.instance(e.base).js(r).done(function(e){for(var r in e)e[r]&&"function"==typeof e[r].attach&&e[r].attach(t);n.resolve()}),n}}();var b=function(){function e(e,n){return null==n?e:"string"==typeof n?(e.src=n,e):(n.src&&(e.src=n.src),n.cfg&&(e.cfg=t(e.cfg,n.cfg,"loader"),n.cfg.loader&&(e.cfg.loader=t(e.cfg.loader,n.cfg.loader))),n.routes&&t(e.routes,n.routes),e)}function t(e,t,n){if(null==t)return e;null==e&&(e={});for(var r in t)r!==n&&(e[r]=t[r]);return e}var n={$getScripts:f.Fn.memoize(function(e){var t=r("scripts",this.env).slice();return e&&(t=t.concat(this.$getScriptsForPageOnly(e))),t}),$getScriptsForPageOnly:f.Fn.memoize(function(e){var t=this.pages[e],n=[];if(null==t)return v.error("<page:scripts> Page not defined",e),null;if(t.scripts&&(n=n.concat(r("page",this.env,t.scripts,t.routes))),t.view&&t.view.controller){var i=this.$formatPath(this.page.location.viewController,t.view.controller);n.push(i)}return n}),$getStyles:function(e){var t=this,n=r("styles",t.env).slice();return e&&(n=n.concat(this.$getStylesForPageOnly(e))),n},$getStylesForPageOnly:function(e){var t=this,n=t.pages[e],i=[];if(null==n)return v.error("<page:styles> Page not defined",e),null;if(n.styles&&(i=i.concat(r("page",t.env,n.styles,n.routes))),n.compo){var o=this.$getCompo(n),s=h.getResource(o);null!=s?s.includes.forEach(function(e){"css"===e.resource.type&&i.push(e.resource.url)}):v.error("<page:styles> compo resource is undefined",o)}if(n.view&&n.view.style){var o=this.$formatPath(this.page.location.viewStyle,n.view.style);i.push(o)}return i},$getInclude:function(){var t=this.env,n={src:"",routes:{},cfg:{}};return e(n,t.both.include),e(n,t.client.include),n.src||console.error('[FATAL ERROR] Include PATH is not specified, use in client.yml/json include: { src: "PATH" }'),e(n,{routes:t.both.routes}),e(n,{routes:t.client.routes}),n},$getIncludeForPageOnly:function(t){var n=this.pages[t],r={};return n&&n.include?e(r,n.include):r},$getTemplate:function(e){var t=e.template||this.page.index.template,n=this.page.location.template,r=this.$formatPath(n,t);return c.Uri.combine(this.base,r)},$getMaster:function(e){var t=e.master||this.page.index.master,n=this.page.location.master,r=this.$formatPath(n,t);return c.Uri.combine(this.base,r)},$getController:function(e){var t=e.controller||this.page.index.controller;if(null==t)return null;var n=this.page.location.controller,r=this.$formatPath(n,t);return c.Uri.combine(this.base,r)},$getCompo:function(e){var t=e.compo;if(null==t)return null;var n=this.page.location.compo||this.page.location.controller,r=this.$formatPath(n,t);return c.Uri.combine(this.base,r)}},r=f.Fn.memoize(function(e,t,n,r){function i(e){if(null!=e)for(var t in e)s.register(t,e[t])}function o(e){null!=e&&s.each("js",e,function(e,t){a.push(t.path)})}var s=new includeLib.Routes,a=[];switch(i(t.client.routes),i(t.both.routes),e){case"page":i(r),o(n);break;case"debug":o(t.client.debug);break;default:o(t.client[e]),o(t.both[e])}return a});return n}(),y=function(){function e(o){if(null!=o)if(r(o)){for(var s,a=o,l=o.length,u=0;l>u;u++)if(s=a[u],null!=s&&"string"!=typeof s){var c=n(s);if(null!=c)if(i(c)){var f=t(a,u,c.value);l+=f,u+=f}else a.splice(u,1),u--,l--;else e(s)}}else if("object"==typeof o)for(var d in o)e(o[d])}function t(e,t,n){return r(n)?(Array.prototype.splice.apply(e,[t,1].concat(n)),n.length):(e.splice(t,1,n),1)}function n(e){for(var t in e)return"if#"!==t.substring(0,3)?null:{key:t.substring(3),value:e[t]};return null}function i(e){return s.args[e.key]}return{prepair:function(t){e(t)}}}();return e}();!function(){function e(n,r,i,o,s,a){if(a>=n.length)return o(null,r,i);var l=n[a];return null==l?e(n,r,i,o,s,++a):void l(r,i,t(n,r,i,o,s,a),s)}function t(t,n,r,i,o,s){return function(a){return a?(v.debug("<app:middleware:nextDelegate>".red,a),void i(a,n,r)):void e(t,n,r,i,o,++s)}}w=f.Collection(Function,{Base:f.Serializable,process:function(t,n,r,i){e(this,t,n,r,i,0)}})}(),m.HttpSubApplication=function(){var e="",t="loading",n="loaded",r="error";return f({status:e,app_:null,Construct:function(e,i){if("/"!==e[0]&&(e="/"+e),"/"!==e[e.length-1]&&(e+="/"),this.path_=e,this.dfr=new f.Deferred,i instanceof m.Application)return this.app_=i,void(this.status=n);var o=i.controller||i,s=this;if(S(o))return this.status=t,void h.instance().js(o+"::App").done(function(e){return e.App instanceof m.Application?void e.App.done(function(e){s.app_=e,s.process=s.pipe,s.status=n,s.dfr.resolve()}):void(s.status=r)});var a=i.configs,l=i.config;null==l&&null==a&&(a=e),this.status=t,m.Application({configs:a,config:l}).done(function(e){s.app_=e,s.process=s.pipe,s.status=n,s.dfr.resolve()})},process:function(e,r){return this.status===t?void this.dfr.done(this.pipe.bind(this,e,r)):this.status===n?void this.pipe(e,r):(r.writeHead(500,{"Content-Type":"text/plain"}),void r.end("<Sub Application Errored> "+this.path_))},pipe:function(e,t){return e.url.length<this.path_.length?(t.writeHead(301,{Location:this.path_}),void t.end()):(e.url=e.url.replace(this.path_,"/"),void this.app_.process(e,t))}})}(),m.Application=f({Extends:f.Deferred,_responder:null,_responders:null,middleware:null,resources:null,Construct:function(e){return null==e&&(e={}),this instanceof m.Application==0?new m.Application(e):(null==s&&(s=this),this.isRoot=this===s,this.handlers=new q(this),this.args=n(e.args,i()),this._baseConfig=e,this._loadConfig(),this.isRoot&&P()!==!0&&v.cfg("color","none"),this)},respond:function(e,t,n){null==this._responder&&this.responder(),this._responder(e,t,n)},responder:function(t){return this.middleware=new w(t&&t.middleware),this._responder=e(this)},responders:function(e){this._responders=new w(e)},process:function(e,t,n){null==this._responders&&this.responders([this.responder()]),this._responders.process(e,t,n||y,this.config)},webSockets:U,autoreload:function(e){return U.listen(e),B.enableForApp(this)},autoreloadEnabled:!1,getSubApp:function(e){var t=this.handlers.subapps.get(e);return t&&t.value&&t.value.app_},Self:{_loadConfig:function(){var e=this._baseConfig;return this.config=C(e,this),this.config.done(g(this)).fail(function(e){v.warn("Configuration Error").error(e)}),this}}})}(),h.cfg({loader:{coffee:{process:function(e){return require("coffee").compile(e)}}}}),h.cfg({loader:{less:{process:function(e,t,n){var r=t.path_getFile(),i=t.path_getDir(),o=require("less"),s=new o.Parser({filename:r,paths:[i]});s.parse(e,function(e,t){var i;if(e)return void v.error("<less:parse>",r,e);try{i=t.toCSS()}catch(e){v.error("<less:toCss>",r,e)}n(i)})}}}}),h.cfg({loader:{yml:{process:function(e){var t=require("yamljs");e=e.replace(/\t/g,"  ");try{return t.parse(e)}catch(n){return v.error("<yml parser>",n),null}}}}}),h.cfg({loader:{jsnext:{process:function(e,t){var n=require("traceur"),r=new n.syntax.SourceFile(t.url,content),i=new n.util.ErrorReporter,o=n.codegeneration.Compiler.compileFile(i,r),s=n.outputgeneration.TreeWriter.write(o);return s}}}});var B=function(){function e(e){return function(n){e.defer()._loadConfig().done(function(){t.fileChanged(n)})}}var t,n=function(){var e=c.Uri.combine(process.cwd(),"/").replace(/\\/g,"/"),t=f({Base:f.EventEmitter,Construct:function(e){this.active=!1,this.file=new u.File(e)},Self:{fileChanged:function(e){v.log("<watcher:changed>",e),this.trigger("fileChange",e,"filewatcher")}},bind:function(e){this.on("fileChange",e),this.active||(u.watcher.watch(this.file.uri.toLocalFile(),this.fileChanged),this.active=!0)},unbind:function(e){this.off("fileChange",e),0===this._listeners.length&&u.watcher.unwatch(this.file.uri.toLocalFile())}}),n={};return new new f({Base:f.EventEmitter,watch:function(e){var r=e.uri.toString();if(null==n[r]){var i;i=new t(r),i.bind(this.fileChanged),n[r]=i}},unwatch:function(e){var t=e.uri.toString();return null==n[t]?void v.log("<watcher> No watchers",t):(n[t].unbind(callback),void delete n[t])},isWatching:function(e){var t=e.uri.toString();return null!=n[t]},Self:{fileChanged:function(t,n){return"filewatcher"===n?(t="/"+t.replace(e,""),void(null==h.getResource(t)&&this.trigger("fileChange",t))):void this.trigger("fileChange",t)}},bind:function(e){return this.on("fileChange",e)},unbind:function(e){return this.off("fileChange",e)}})}(),r=f({Construct:function(e){v.log("<autoreload> Socket connected"),this.socket=e,e.on("disconnect",this.disconnected),n.bind(this.fileChanged)},Self:{fileChanged:function(e){v.log("<autoreload> path",e),this.socket.emit("filechange",e)},disconnected:function(){n.unbind(this.fileChanged)}}}),i=new c.Uri(process.cwd()+"/");return t={watch:function(e){var t="/"===e[0]?1:0,r=e.indexOf("?"),o=-1===r?e.length:r;e=e.substring(t,o);var s=i.combine(e),a=new u.File(s);a.uri&&a.uri.file&&(n.isWatching(a)||a.exists()!==!1&&n.watch(a))},unwatch:function(e){n.unwatch(new u.File(e))},fileChanged:function(e,t){n.fileChanged(e,t)},isWatching:function(e){return"string"==typeof e&&(e=new u.File(e)),n.isWatching(e)},listenDirectory:function(e,t){new u.Directory(e).watch(t)},enableForApp:function(t){U.registerHandler("/browser",r),t.autoreloadEnabled=!0;var n=new u.Directory("server/config/");return n.exists()&&n.watch(e(t)),h.cfg("autoreload",this),this},getWatcher:function(){return n}}}();return a=['{"env":{"both":{"include":{"cfg":null		},"routes":{"public":"/public/script/{0}.js","public_compo":"/public/compo/{0}/{1}.js","atma":"/.reference/atma/{0}/lib/{1}.js","atma_compo":"/.reference/atma/compos/{0}/lib/{1}.js","view":"/public/view/{0}/{1}.js"},"scripts":null		},"client":{"include":{"src":"/.reference/atma/include/lib/include.js"},"scripts":null		,"styles":null		,"routes":null		},"server":{"routes":{"server":"/server/{0}.js","server_lib":"/server/lib/{0}.js","server_compo":"/server/compo/{0}/{1}.js"},"scripts":null		}},"handler":{"location":"/server/http/handler/{0}.js"},"handlers":null		,"mask":{"compos":{":scripts":{"mode":"server:all"},":styles":{"mode":"server:all"},":template":{"mode":"server"},"layout:master":{"mode":"server"},"layout:view":{"mode":"server"},":animation":{"mode":"client"}},"attributes":null		},"page":{"location":{"controller":"/server/http/page/{0}/{1}.js","template":"/server/http/page/{0}/{1}.mask","master":"/server/http/master/{0}.mask","viewTemplate":"/public/view/{0}/{1}.mask","viewController":"/public/view/{0}/{1}.js","viewStyle":"/public/view/{0}/{1}.less"},"extension":{"javascript":"js","style":"less","template":"mask"},"index":{"template":"index","master":"default"},"urls":{"login":"/login"}},"pages":{"/":{"id":"index","title":"Default Title"}},"service":{"location":"/server/http/service/{0}.js"},"services":null		,"view":{"location":{"template":"/public/view/{0}/{1}.mask","controller":"/public/view/{0}/{1}.js","style":"/public/view/{0}/{1}.less"}}}'][0],null!=t.atma&&"object"==typeof t.atma?t.atma.server?void n(t.atma.server,m):void(t.atma.server=m):void(t.atma={server:m})});