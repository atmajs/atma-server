(function(e,t){"use strict";var r,n;"undefined"==typeof exports||e!==exports&&null!=e&&e!==global||(r=n=global),null==r&&(r="undefined"==typeof window?global:window),null==n&&(n=e||r),t(r,n)})(this,function(e,t){"use strict";function r(e,t){if(null==e&&(e={}),null==t)return e;for(var r in t)e[r]=t[r];return e}function n(e,t){return function(){return e.apply(t,arguments)}}function i(e){return Array.isArray(e)}function o(){for(var e,t=process.argv,r=t.length,n=2,i={args:[]};r>n;n++)if(e=t[n],"-"!==e[0]){var o=e.indexOf("=");-1===o?i.args.push(e):i[e.substring(0,o)]=e.substring(o+1)}else i[e.replace(/^[\-]+/,"")]=!0;return i}var s,l,a,u,c,f,h,d,g,p,v,m={};e.include&&e.net&&e.net.Uri&&(a=e),null==a&&e.atma&&(a=e.atma),null==a&&(require("atma-libs/globals-dev"),a=e),e.logger&&(v=e.logger),null==v&&(require("atma-logger"),v=e.logger),e.io&&e.io.File&&(u=e.io),null==u&&(require("atma-io"),u=e.io),c=a.net,f=a.Class,h=a.ruta,d=a.mask,g=a.include,p=h.Collection,v=e.logger;var y=function(){function e(e,r,n,i){var o=e.get(r,n);if(null==o)return!1;var s=o.value.controller;return"string"==typeof s?(t(s,o,i),!0):(i(new s(o)),!0)}function t(e,t,r){g.instance().js(e+"::Handler").done(function(n){return null==n.Handler?(v.error("<handler> invalid route",e),r(new o)):"function"!=typeof n.Handler.prototype.process?(v.error("<handler> invalid interface - process function not implemented"),r(new o)):(r(new n.Handler(t)),void 0)})}function r(e,t){if(47===e.charCodeAt(0))return e;var r=t&&t.location;if(null==r)return console.error("[Handler] Path is relative but no location. Set handler: {location: X} in config"),e;var n,i,o=e.split("/"),n=r.split(/[\{\}]/g);for(e=n[0],i=1;n.length>i;i++)if(0===i%2)e+=n[i];else{var s=n[i]<<0;if(s>o.length-1&&(s=o.length-1),e+=o[s],i===n.length-2)for(s++;o.length>s;s++)e+="/"+o[s]}return e}var n=["handlers","services","pages"],i=f({Construct:function(){this.handlers=new p,this.services=new p,this.pages=new p},registerPages:function(e){var t,r;for(r in e)t=e[r],t.controller=null!=t.controller?s.config.page.getController(t):m.HttpPage,this.pages.add(r,t);return this},registerHandlers:function(e,t){for(var n in e)this.handlers.add(n,{controller:r(e[n],t)});return this},registerServices:function(e,t){var n,i,o;for(var i in e)n="string"==typeof e[i]?{controller:e[i]}:e[i],o=n.controller,o||v.error("<handler factory> service path not defined",e[i]),n.controller=r(o,t),this.services.add(i,n);return this},get:function(t,r){var i=t.url,o=t.method;"POST"===o&&t.body&&t.body._method&&(o=t.body._method);for(var s,l=0,a=n.length;a>l;l++)if(s=n[l],e(this[s],i,o,r))return;r(null)}}),o=f({Base:f.Deferred,process:function(){return this.reject("Invalid Routing"),this}});return i}();m.IHttpHandler=f({Extends:f.Deferred,process:function(){this.reject("Not Implemented",500)}}),m.HttpPage=function(){function e(e,t,r){this.page=e,this.req=t,this.res=r,this._rewrite=null,this._redirect=null}function t(e){return null==e.Base?e.Base=o:null==e.Extends?e.Extends=o:Array.isArray(e)?e.Extends.push(o):e.Extends=[o,e.Extends],f(e)}function r(e){var t=e.ctx;return null==t.rewriteCount&&(t.rewriteCount=1),++t.rewriteCount>5?(e.reject("Too much rewrites, last path: "+t.rewrite),void 0):function(r){return null==r?(e.reject("Rewritten Path is not valid",t.rewrite),void 0):(r.process(t.req,t.res).done(n(e.resolve,e)).fail(n(e.reject,e)),void 0)}}var i=function(){var e={getScripts:function(){return s.config.page.getScripts(this.data.id)},getStyles:function(){return s.config.page.getStyles(this.data.id)}};return e}();e.prototype={redirect:function(e,t){null==t&&(t=302),this.res.statusCode=t,this.res.setHeader("Location",e),this.res.setHeader("Content-Length","0"),this.res.end(),this._redirect=e},rewrite:function(e){this._rewrite=e}};var o=f({Extends:[f.Deferred,i],template:null,master:null,route:null,Construct:function(e){if(this instanceof o==!1)return t(e);var r=s.config.page;this.route=r.route;var n=e;return n&&n.value?(this.data=n.value,this.query=n.current&&n.current.params,this.master=r.getMaster(this.data)+"::Master",this.data.template&&(this.template=r.getTemplate(this.data)+"::Template"),this.data.compo&&(this.compo=r.getCompo(this.data)+"::Compo"),null==this.compo&&null==this.template&&(this.template=r.getTemplate(this.data)+"::Template"),void 0):(v.error("<httppage> current route value is unedefined"),void 0)},process:function(t,r){if(this.route){var n=h.parse(this.route,t.url).params;for(var i in n)null==this.query[i]&&(this.query[i]=n[i])}if(this.ctx=new e(this,t,r),"secure"in this.data){var o=t.user,l=this.data.secure,a=l&&l.role;if(null==o||(a&&o.isInRole(a))===!1)return this.ctx.redirect(s.config.page.urls.login),this}return this.load(),this},load:function(){this.resource=g.instance().load(this.master,this.template).js(this.compo).done(n(this.response,this))},response:function(e){var t=e.load.Master,i=e.load.Template,o=e.Compo;if("master"===this.query.debug)return this.resolve(t),void 0;if("template"===this.query.debug)return this.resolve(i),void 0;this.query.breakOn&&(this.ctx.debug={breakOn:this.query.breakOn}),t&&d.render(d.parse(t)),null!=o&&(i&&null==o.template&&(o.template=i),null==o.mode&&(o.mode="server"),this.nodes=new d.Dom.Component("",null,o)),this.onRenderStart&&this.onRenderStart(this.model,this.ctx);var l=d.render(this.nodes||i,this.model,this.ctx);return null!=this.ctx._rewrite?(s.handlers.get(this.ctx._rewrite,r(this)),void 0):this.ctx.async?(this.ctx.done(n(this.doResolve,this)).fail(n(this.fail,this)),void 0):(this.doResolve(l),void 0)},doResolve:function(e){null==this.ctx._redirect&&this.resolve(e)}});return o}(),m.HttpService=function(){function e(e,t){if(null==t)return!0;var r=e.user,n=t.role;return null!=r&&(null==n||r.isInRole(n))}var t=f({Extends:f.Deferred,secure:null,Construct:function(e){for(var t=0,r=e.parts.length,n=0;r>t&&"string"==typeof e.parts[t];t++)n+=e.parts[t].length+1;this.rootCharCount=n,"secure"in e.value&&(this.secure=e.value.secure||{})},process:function(t,r){if(e(t,this.secure)===!1)return this.reject({error:"Access Denied"},401);var n=t.url.substring(this.rootCharCount),i=this.routes.get(n,t.method);return null==i?this.reject("Service method not Found: "+n,404):(i.value.call(this,t,r,i.current.params),this)}});return function(e){var r=new h.Collection,n=e.ruta||e;for(var i in n)r.add(i,n[i]);return e.routes=r,null==e.Extends?e.Extends=t:Array.isArray(e.Extends)?e.Extends.push(t):e.Extends=[t,e.Extends],f(e)}}(),function(){function e(e,r,n,i){if(i>=e.length)return e.callback(r,n),e.callback=null,void 0;var o=e[i];o(r,n,t(e,r,n,i))}function t(t,r,n,i){return function(o){o&&v.error(o),e(t,r,n,++i)}}function n(e){return function(t,r,n){e.autoreloadEnabled&&w.watch(t.url);var i=e.middleware?a(e.middleware):p;h(e,t,r,n,i)}}function a(e){return function(t,r,n){new S(e).process(r,n,function(){p(t,r,n)})}}function h(e,t,r,n,i){C(e,function(){e.handlers.get(t,function(e){return null==e?n():(i(e,t,r),void 0)})})}function p(e,t,r){v(95).log("<request>",t.url),e.process(t,r).done(function(e,t,n,i){j(r,e,t,n,i)}).fail(function(e,t){r.statusCode=t||500,j(r,e,t||500,"text/plain")})}function b(e){return function(t){t&&v.error(t);var r=e.config;return v(90).log("<app.config>",r),e.handlers.registerHandlers(r.handlers,r.handler).registerServices(r.services,r.service).registerPages(r.pages),e.args.debug?(e.resolve(e),void 0):(C(e,function(){resource_load=x,e.resolve(e)}),void 0)}}function C(e,t){return g.instance().js(e.config.env.server.scripts).js(e.config.env.both.scripts).done(t)}function x(e,t){t()}function j(e,t,r,n,i){if("string"!=typeof t&&t instanceof Buffer==!1)try{t=JSON.stringify(t),n="application/json"}catch(o){v.error("<responder> invalid json object",o),t='{ error: "invalid json object" }'}if(i)for(var s in i)e.setHeader(s,i[s]);e.setHeader("Content-Type",n||"text/html"),e.statusCode=r||200,e.end(t)}var A=function(){function e(n,i){n.buildDirectory&&(p=n.buildDirectory),n.configs&&(m=n.configs);var o={env:{client:{routes:null,scripts:null,styles:null},server:{routes:null,scripts:null},both:{routes:null,scripts:null}},page:{location:null,include:null},pages:null,handler:{location:null},handlers:null,service:{location:null},services:null,passport:{},app:{},build:{}};return t(o,l),r(o,e.getList(m),i)}function t(e,r){if(Array.isArray(e)&&Array.isArray(r)){for(var n,i=0,o=r.length;o>i;i++)n=r[i],-1===e.indexOf(n)&&e.push(n);return e}if("object"!=typeof r&&"object"!=typeof e)return v.log("<cfg extend> not an object or type missmatch"),e;var s,l;for(s in r)if(l=r[s],null!=e[s])if(Array.isArray(l)){if(Array.isArray(e[s])===!1){v.log("<cfg extend> type missmatch",s,l,e[s]),e[s]=l;continue}t(e[s],l)}else e[s]="object"!=typeof l||"object"!=typeof e[s]?l:t(e[s],l);else e[s]=l;return e}function r(e,t,r){if(Array.isArray(t)===!1)return process.nextTick(function(){r("<server.config> should be an array of filenames")}),e;t=t.map(function(e){return""+h.uri.combine(e+".yml")+"::"+e.replace(/\//g,".")});var i=new u.File(c.Uri.combine(p,"stats.json"));return i.exists()?t.push(""+i.uri+"::build"):s.args.degub||v.warn("<config> %s/stats.json . App is not built",p),g.instance().load(t).done(n(e,r)),e}function n(e,r){function n(e,t,r){if(null!=r&&-1!==r.indexOf(".")){for(var i=r.split("."),o=i.length-1,s=0;o>s;s++)e=e[i[s]]||(e[i[s]]={});n(e,t)}else for(var l in t)e[l]=t[l]}return function(i){var s,l,u=i.load,c={};for(s in u)l=u[s],null!=l&&n(c,l,s);t(e,c);var f=e.mask;f.compos&&d.compoDefinitions(f.compos,f.utils,f.attributes),e.env.both.routes&&g.routes(e.env.both.routes),e.env.both.include&&g.cfg(e.env.both.include.cfg),e.env.server.include&&g.cfg(e.env.server.include.cfg),e.env.server.routes&&g.routes(e.env.server.routes),o.prepairIncludes(e.env.server.scripts),o.prepairIncludes(e.env.client.scripts);var h=e.pages;if(h)for(var s in h)h[s].id=s;a(e),r()}}var o=function(){function e(t,r){if(null!=t)for(var n in r)"object"!=typeof r[n]?"function"!=typeof r[n]||(t[n]=r[n]):e(t[n],r[n])}var t,r=function(){return{format:function(e,t){if(47===t.charCodeAt(0))return t;var r,n,i=t.split("/"),r=e.split(/[\{\}]/g);for(t=r[0],n=1;r.length>n;n++)if(0===n%2)t+=r[n];else{var o=r[n]<<0;if(o>i.length-1&&(o=i.length-1),t+=i[o],n===r.length-2)for(o++;i.length>o;o++)t+="/"+i[o]}return t}}}(),n=function(){function e(e,r){return null==r?e:"string"==typeof r?(e.src=r,e):(r.src&&(e.src=r.src),r.cfg&&(e.cfg=t(e.cfg,r.cfg,"loader"),r.cfg.loader&&(e.cfg.loader=t(e.cfg.loader,r.cfg.loader))),r.routes&&t(e.routes,r.routes),e)}function t(e,t,r){if(null==t)return e;null==e&&(e={});for(var n in t)n!==r&&(e[n]=t[n]);return e}var r={getScripts:f.Fn.memoize(function(e){var t=s.config,r=n("scripts",t.env).slice();return e&&(r=r.concat(this.getScriptsForPageOnly(e))),r}),getScriptsForPageOnly:f.Fn.memoize(function(e){var t=s.config,r=t.pages[e],i=[];if(null==r)return v.error("<page:scripts> Page not defined",e),null;if(r.scripts&&(i=i.concat(n("page",t.env,r.scripts,r.routes))),r.view&&r.view.controller){var o=t.formatPath(this.location.viewController,r.view.controller);i.push(o)}return i}),getStyles:function(e){var t=s.config,r=n("styles",t.env).slice();return e&&(r=r.concat(this.getStylesForPageOnly(e))),r},getStylesForPageOnly:function(e){var t=s.config,r=t.pages[e],i=[];if(null==r)return v.error("<page:styles> Page not defined",e),null;if(r.styles&&(i=i.concat(n("page",t.env,r.styles,r.routes))),r.compo){var o=this.getCompo(r),l=g.getResource(o);if(null!=l)for(var a,u=0,c=l.includes.length;c>u;u++)a=l.includes[u],"css"===a.resource.type&&i.push(a.resource.url);else v.error("<page:styles> compo resource is undefined",o)}if(r.view&&r.view.style){var o=t.formatPath(this.location.viewStyle,r.view.style);i.push(o)}return i},getInclude:function(){var t=s.config.env,r={src:"",routes:{},cfg:{}};return e(r,t.both.include),e(r,t.client.include),r.src||console.error('[FATAL ERROR] Include PATH is not specified, use in client.yml/json include: { src: "PATH" }'),e(r,{routes:t.both.routes}),e(r,{routes:t.client.routes}),r},getIncludeForPageOnly:function(t){var r=s.config.pages[t],n={};return r&&r.include?e(n,r.include):n},getTemplate:function(e){var t=e.template||this.index.template;return s.config.formatPath(this.location.template,t)},getMaster:function(e){var t=e.master||this.index.master;return s.config.formatPath(this.location.master,t)},getController:function(e){var t=e.controller||this.index.controller;return t?s.config.formatPath(this.location.controller,t):null},getCompo:function(e){var t=e.compo,r=this.location.compo||this.location.controller;return t?s.config.formatPath(r,t):null}},n=f.Fn.memoize(function(e,t,r,n){function i(e){if(null!=e)for(var t in e)s.register(t,e[t])}function o(e){null!=e&&s.each("js",e,function(e,t){l.push(t.path)})}var s=new includeLib.Routes,l=[];switch(i(t.client.routes),i(t.both.routes),e){case"page":i(n),o(r);break;case"debug":o(t.client.debug);break;default:o(t.client[e]),o(t.both[e])}return l});return r}(),o=function(){function e(o){if(null!=o)if(i(o)){for(var s,l=o,a=o.length,u=0;a>u;u++)if(s=l[u],null!=s&&"string"!=typeof s){var c=r(s);if(null!=c)if(n(c)){var f=t(l,u,c.value);a+=f,u+=f}else l.splice(u,1),u--,a--;else e(s)}}else if("object"==typeof o)for(var h in o)e(o[h])}function t(e,t,r){return i(r)?(Array.prototype.splice.apply(e,[t,1].concat(r)),r.length):(e.splice(t,1,r),1)}function r(e){for(var t in e)return"if#"!==t.substring(0,3)?null:{key:t.substring(3),value:e[t]};return null}function n(e){return s.args[e.key]}return{prepair:function(t){e(t)}}}(),l={page:n,formatPath:r.format};return{attach:function(r){t=r,e(r,l)},prepairIncludes:o.prepair}}(),a=o.attach,h=new u.Directory("server/config/"),p="public/build/",m="server/config/";return e.getList=function(e){h=new u.Directory(c.Uri.combine(process.cwd(),e));var t=h.readFiles("**.yml").files.map(function(e){return e.uri.toRelativeString(h.uri).replace(".yml","")});return 0===t.length&&v.error("<server> No configuration files in",""+h.uri),t},e}(),S=f.Collection(Function,{Construct:function(e){for(var t=0,r=e.length;r>t;t++)this[this.length++]=e[t]},callback:null,process:function(t,r,n){this.callback=n,this.index=0,e(this,t,r,0)}});m.Application=f({Extends:f.Deferred,middleware:null,Construct:function(e){return null==e&&(e={}),this instanceof m.Application==!1?new m.Application(e):(s=this,this.handlers=new y,this.args=r(e.args,o()),this.config=A({buildDirectory:e.buildDirectory,configs:e.configs},b(this)),this.args.debug!==!0&&v.cfg("color","none"),this)},responder:function(e){return e&&(this.middleware=e.middleware),n(this)},autoreload:function(e){this.autoreloadEnabled=!0,w.listen(e),w.listenDirectory("server/config/"),g.cfg("autoreload",w)},autoreloadEnabled:!1})}(),g.cfg({loader:{coffee:{process:function(e){return require("coffee").compile(e)}}}}),g.cfg({loader:{less:{process:function(e,t,r){var n=t.path_getFile(),i=t.path_getDir(),o=require("less"),s=new o.Parser({filename:n,paths:[i]});s.parse(e,function(e,t){var i;if(e)return v.error("<less:parse>",n,e),void 0;try{i=t.toCSS()}catch(e){v.error("<less:toCss>",n,e)}r(i)})}}}}),g.cfg({loader:{yml:{process:function(e){var t=require("yamljs");e=e.replace(/\t/g,"  ");try{return t.parse(e)}catch(r){return v.error("<yml parser>",r),null}}}}});var w=function(){var t={},r=function(){var e=c.Uri.combine(process.cwd(),"/").replace(/\\/g,"/"),t=f({Base:f.EventEmitter,Construct:function(e){this.active=!1,this.file=new u.File(e)},Self:{fileChanged:function(e){v.log("<watcher:changed>",e),this.trigger("fileChange",e,"filewatcher")}},bind:function(e){this.on("fileChange",e),this.active||(u.File.watcher.watch(this.file,this.fileChanged),this.active=!0)},unbind:function(e){this.off("fileChange",e),0===this._listeners.length&&u.File.watcher.unwatch(this.file.uri.toLocalFile())}}),r={};return new new f({Base:f.EventEmitter,watch:function(e){var n=e.uri.toLocalFile();if(null==r[n]){var i;i=new t(n),i.bind(this.fileChanged),r[n]=i}},unwatch:function(e){var t=e.uri.toLocalFile();return null==r[t]?(v.log("<watcher> No watchers",t),void 0):(r[t].unbind(callback),delete r[t],void 0)},isWatching:function(e){var t=e.uri.toLocalFile();return null!=r[t]},Self:{fileChanged:function(t,r){return"filewatcher"===r?(t="/"+t.replace(e,""),null==g.getResource(t)&&this.trigger("fileChanged",t),void 0):(this.trigger("fileChange",t),void 0)}},bind:function(e){return this.on("fileChange",e),this},unbind:function(e){return this.off("fileChange",e),this}})}();t["/browser"]=f({Construct:function(e){v.log("<socket> Connected"),this.socket=e,e.on("disconnect",this.disconnected),r.bind(this.fileChanged)},Self:{fileChanged:function(e){v.log("<autoreload> path",e),this.socket.emit("filechange",e)},disconnected:function(){r.unbind(this.fileChanged)}}});var n={listen:function(r){function n(e,t){return function(e){new t(e,o)}}v.log("<Autoreload> Socket opened".green.bold);var i=e.io;delete e.io;var o=require("socket.io").listen(r,{"log level":0});e.io=i;for(var s in t)o.of(s).on("connection",n(s,t[s]))},getConnectionHandler:function(e){return t[e]}},i=new c.Uri(process.cwd()+"/");return{watch:function(e){var t="/"===e[0]?1:0,n=e.indexOf("?"),o=-1===n?e.length:n;e=e.substring(t,o);var s=i.combine(e),l=new u.File(s);l.uri.file&&(r.isWatching(l)||l.exists()!==!1&&r.watch(l))},unwatch:function(e){r.unwatch(new u.File(e))},listen:function(e){n.listen(e)},fileChanged:function(e,t){r.fileChanged(e,t)},isWatching:function(e){return"string"==typeof e&&(e=new u.File(e)),r.isWatching(e)},listenDirectory:function(e){var t=this;new u.Directory(e).readFiles().files.forEach(function(e){t.watch(""+e.uri)})}}}();return l=[{handler:{location:"/server/http/handler/{0}.js"},mask:{compos:{":scripts":{mode:"server:all"},":styles":{mode:"server:all"},":template":{mode:"server"},"layout:master":{mode:"server"},"layout:view":{mode:"server"},":animation":{mode:"client"}},attributes:null},page:{location:{controller:"/server/http/page/{0}/{1}.js",template:"/server/http/page/{0}/{1}.mask",master:"/server/http/master/{0}.mask",viewTemplate:"/public/view/{0}/{1}.mask",viewController:"/public/view/{0}/{1}.js",viewStyle:"/public/view/{0}/{1}.less"},extension:{javascript:"js",style:"less",template:"mask"},index:{template:"index",master:"default"},urls:{login:"/login"}},pages:{"/":{id:"index",title:"Default Title"}},service:{location:"/server/http/service/{0}.js"},view:{location:{template:"/public/view/{0}/{1}.mask",controller:"/public/view/{0}/{1}.js",style:"/public/view/{0}/{1}.less"}}}][0],null!=t.atma&&"object"==typeof t.atma?(r(t.atma,m),void 0):(t.atma={server:m},void 0)});