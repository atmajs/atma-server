!function(e,t){"use strict";t(global,global),module.exports=global.atma.server}(this,function(e,t){"use strict";function n(e){return Array.isArray(e)}function r(){for(var e,t=process.argv,n=t.length,r=2,i={args:[]};n>r;r++)if(e=t[r],"-"!==e[0]){var s=e.indexOf("=");-1===s?i.args.push(e):i[e.substring(0,s)]=e.substring(s+1)}else i[e.replace(/^[\-]+/,"")]=!0;return i}function i(e){i=function(){};var t=e.config.$is("debug"),n="/public/build/";!function(){var r,i;!function(){function e(e){var t=e.data&&e.data.id;return null==t&&m.error("<page-resources> PageData and the ID is not defined"),t}function s(e,t){if(null==t.build)return m.error("<Application is not built>").warn("To execute the DEV version use `--debug` flag: `node index --debug`".bold).warn("To build the application run `atma custom node_modules/atma-server/tools/build`"),null;var n=t.build[e];return null==n?(m.error("<page-resources> No page info",e,"Build could be faily"),null):n}function o(e,t){return e=a(n,e),t.buildVersion&&(e+="?v="+t.buildVersion),e}i=function(n,r,i){var a=e(n);if(t)return i!==!0?r.$getStyles(a):r.$getStylesForPageOnly(a);var u=i!==!0?[o("styles.css",r)]:[],l=s(a,r);return null==l?u:(l.styles&&u.push(o(a+"/styles.css",r)),u)},r=function(r,i,u,l){var c=e(r),f={scripts:[],templates:"",include:{src:"",cfg:null,routes:null},buildVersion:i.buildVersion};if(t){var h=i.$getInclude();return h&&(f.include=h),f.scripts=u!==!0?i.$getScripts(c):i.$getScriptsForPageOnly(c),l&&l(f),f}var d=i["static"]||i.base,v=[];u!==!0&&(f.scripts.push(o("scripts.js",i)),v.push(a(d,n,"load.html::App")));var g=s(c,i);return null!=g&&(g.load===!0&&v.push(a(d,g,c,"load.html::Page")),g.scripts&&f.scripts.push(o(c+"/scripts.js",i))),p.instance().load(v).done(function(e){f.templates=(e.load.App||"")+(e.load.Page||""),l&&l(f)}),f};var a=F.combine}();var s=h({mode:"server:all",nodes:c.parse("each (.) > link type='text/css' rel='stylesheet' href='~[.]';"),cache:t?{byProperty:"ctx.page.id"}:null,renderStart:function(e,t){this.model=i(t.page,t.config,!1)}});s.getModel=i,c.registerHandler("atma:styles",s),function(){var t=h({template:["		if (templates) {\n\n			:html > '~[templates]'\n\n		}\n\n		\n\n		each(scripts){\n\n			script type='text/javascript' src='~[.]';\n\n		}\n\n		\n\n		script {	\n\n			include.allDone(function(){\n\n				window.app = Compo.bootstrap(document.body);\n\n			});\n\n		}"][0],mode:"server:all",cache:{byProperty:"ctx.page.id"},onRenderStart:function(e,t){var n=h.pause(this,t),i=this;r(t.page,t.config,!1,function(e){i.model=e,n()})}});t.getModel=r;var n=h({template:["		script type='text/javascript' src='~[include.src]';\n\n		script type='text/javascript' > :html > '''\n\n			window.DEBUG = true;\n\n			\n\n			include\n\n				.cfg(~[include.config])\n\n				.routes(~[include.routes])\n\n				.js(~[scripts])\n\n				.done(function(){\n\n					window.app =  mask.Compo.bootstrap(document.body);\n\n				});\n\n		'''"][0],meta:{mode:"server"},onRenderStart:function(e,t){e=r(t.page,t.config),this.model={include:{src:e.include.src,routes:JSON.stringify(e.include.routes,null,4),config:JSON.stringify(e.include.cfg,null,4)},scripts:e.scripts.map(function(e){return"'"+e+"'"}).join(",\n")}}});n.getModel=r;var i=e.config.$is("debug")?n:t;c.registerHandler("atma:scripts",i)}()}()}var s,o,a,u,l,c,f,h,p,d,v,g,m,b={};!function(){var t;!function(){function e(e,r,i,s){t[e]=n===!0?i||"/lib/"+r+".js":s||"/lib/"+r+".min.js"}t={},e("atma-io","io"),e("maskjs","mask"),e("includejs","include"),e("atma-class","class"),e("atma-logger","","/lib/logger-dev.js","/lib/logger.js");var n=!1}(),m=require("atma-logger"),a=e.io&&e.io.File?e.io:require("atma-io"),u=e.Class||require("atma-class"),l=e.ruta||require("ruta"),c=e.mask||require("maskjs"),f=c.jmask,h=c.Compo,v=l.Collection,g=m("atma-server"),null==e.include&&require("includejs"),p=e.include,d=e.includeLib}();var y,w,P,C,x;!function(){y=function(e){return"string"==typeof e},w=function(e){return"function"==typeof e},P=function(e){return void 0!==e&&"object"==typeof e},C=Array.isArray,x=function(){var e;return function(){return m.warn("@obsolete: is_Debug for app_isDebug"),null==e&&(e=Boolean(s.args.debug||s.config.debug)),e}}()}();var _,j,S;!function(){_=function(e,t){if(null==e&&(e={}),null==t)return e;for(var n in t)e[n]=t[n];return e},j=function(e,t){if(null==e&&(e={}),null==t)return e;for(var n in t)null==e[n]&&(e[n]=t[n]);return e},S=function(e,t,n){for(var r,i=t.split("."),s=i.length-1,o=-1;++o<s;)r=i[o],null==e[r]&&(e[r]={}),e=e[r];r=i[s],Object.defineProperty(e,r,{enumerable:!0,configurable:!0,get:function(){var t=n();return Object.defineProperty(e,r,{enumerable:!0,writable:!0,value:t}),t},set:function(t){Object.defineProperty(e,r,{enumerable:!0,writable:!0,value:t})}})}}();var E,$;!function(){E=function(e,t){return function(){return e.apply(t,arguments)}},$=function(e){var t=I.call(arguments,1);return function(){e.apply(null,t.concat(I.call(arguments)))}}}();var k,A,H;!function(){function e(){n="file://"+A(process.cwd()+"/")}function t(e){return"/"===e[0]?!0:/^[A-Za-z]:[\/\\]/.test(e)}k=function(e){return/^(file|https?):/.test(e)},A=function(e){return e.replace(/\\/g,"/").replace(/([^:\/])\/{2,}/g,"$1/")},H=function(r,i){return r=A(r),k(r)?r:("."===r[0]&&"/"===r[1]&&(r=r.substring(2)),t(r)?"file://"+r:(null==n&&e(),F.combine(i||n,r)))};var n}();var O;!function(){O=function(){if(null==s)return!1;var e=Boolean(s.args.debug||s.config.debug);if(e!==!0){var t=process.env.NODE_ENV||process.env.ENV;t&&(e=/^(test|debug)$/i.test(t))}return O=function(){return e},e}}();var D,T,q;!function(){D=function(e,t,n,r){var i;try{i=JSON.stringify(t)}catch(s){return T(e,G("Json Serialization"))}q(e,i,n||200,M,r)},T=function(e,t,n){t instanceof W==!1&&(t=W.create(t)),q(e,JSON.stringify(t),t.statusCode||500,M,n)},q=function(e,t,n,r,i){if("string"!=typeof t&&t instanceof Buffer==!1)return P(t)?void D(e,t,n,i):t instanceof Error?void T(e,t,i):void T(e,G("Unexpected content response"));if(e.setHeader("Content-Type",r||N),e.statusCode=n||200,null!=i)for(var s in i)e.setHeader(s,i[s]);e.end(t)}}(),RegExp.prototype.toJSON=RegExp.prototype.toString;var F;!function(){function e(e){return e&&"object"==typeof e&&"function"==typeof e.combine}function t(){for(var e,t="",n=0,r=arguments.length;r>n;n++)e=arguments[n],e&&(t?("/"!==t[t.length-1]&&(t+="/"),t+="/"===e[0]?e.substring(1):e):t=e);return t}function n(e){return"/"===e[e.length-1]?e.substring(0,e.length-1):e}function r(e){var t,n=new F;for(t in e)"string"==typeof e[t]&&(n[t]=e[t]);return n}function i(e){return e.replace(/\\/g,"/").replace(/^\.\//,"").replace(/^(\w+):\/([^\/])/,"/$1:/$2")}function s(e){return p.test(e)&&"/"===e[0]?e.substring(1):e}function o(e){var t=f.exec(e.value);null==t&&"/"===e.value[0]&&(e.protocol="file"),null!=t&&(e.protocol=t[1],e.value=e.value.substring(t[0].length))}function a(e){if(null!=e.protocol){if("file"===e.protocol){var t=p.exec(e.value);return void(t&&(e.host=t[1],e.value=e.value.substring(e.host.length)))}var n=e.value.indexOf("/",2);e.host=~n?e.value.substring(0,n):e.value,e.value=e.value.replace(e.host,"")}}function u(e){var t=e.value.indexOf("?");-1!==t&&(e.search=e.value.substring(t),e.value=e.value.substring(0,t))}function l(e){var t=d.exec(e.value),r=null==t?null:t[1];null!=r&&(e.file=r,e.value=e.value.substring(0,e.value.length-r.length),e.value=n(e.value),t=h.exec(r),e.extension=null==t?null:t[1])}F=c["class"].create({protocol:null,value:null,path:null,file:null,extension:null,constructor:function(t){return null==t?this:e(t)?t.combine(""):(t=i(t),this.value=t,o(this),a(this),u(this),l(this),this.path=n(this.value),/^[\w]+:\//.test(this.path)&&(this.path="/"+this.path),this)},cdUp:function(){var e=this.path;return null==e||""===e||"/"===e?this:/^\/?[a-zA-Z]+:\/?$/.test(e)?this:(this.path=e.replace(/\/?[^\/]+\/?$/i,""),this)},combine:function(i){if(e(i)&&(i=i.toString()),!i)return r(this);if(p.test(i))return new F(i);var s=r(this);if(s.value=i,u(s),l(s),!s.value)return s;if(i=s.value.replace(/^\.\//i,""),"/"===i[0])return s.path=i,s;for(;/^(\.\.\/?)/gi.test(i);)s.cdUp(),i=i.substring(3);return s.path=n(t(s.path,i)),s},toString:function(){var e=this.protocol?this.protocol+"://":"",n=t(this.host,this.path,this.file)+(this.search||""),r=e+n;return this.file||this.search||(r+="/"),r},toPathAndQuery:function(){return t(this.path,this.file)+(this.search||"")},toRelativeString:function(e){if("string"==typeof e&&(e=new F(e)),0===this.path.indexOf(e.path)){var n=this.path?this.path.replace(e.path,""):"";return"/"===n[0]&&(n=n.substring(1)),t(n,this.file)+(this.search||"")}for(var r=this.path.split("/"),i=e.path.split("/"),s="",o=0,a=Math.min(r.length,i.length);a>o&&r[o]===i[o];o++);if(o>0&&(s=r.splice(0,o).join("/")),s){for(var u,l="",c=e.path;c;){if(0===this.path.indexOf(c)){u=this.path.replace(c,"");break}c=c.replace(/\/?[^\/]+\/?$/i,""),l+="../"}return t(l,u,this.file)}return this.toString()},toLocalFile:function(){var e=t(this.host,this.path,this.file);return s(e)},toLocalDir:function(){var e=t(this.host,this.path,"/");return s(e)},toDir:function(){var e=this.protocol?this.protocol+"://":"";return e+t(this.host,this.path,"/")},isRelative:function(){return!(this.protocol||this.host)},getName:function(){return this.file.replace("."+this.extension,"")}});var f=/^([a-zA-Z]+):\/\//,h=/\.([\w\d]+)$/i,p=/(^\/?\w{1}:)(\/|$)/,d=/([^\/]+(\.[\w\d]+)?)$/i;F.combinePathes=t,F.combine=t}();var R;!function(){function e(e,n,i,s,o){null==i.route&&(i.route=n),null==i.id&&(i.id=n);var a=i.pattern||o.pattern,u=r(a),l=t(i,u);l.forEach(function(t){e[t.route]=t})}function t(e,r,i){if(0===r.length)return[e];var s=r.shift(),o=e[s];if(null==o)return[e];var a=[];for(var u in o){var l=n(e,u,o[u],i,s),c=t(l,r.slice(),s);c&&(a=a.concat(c))}return a}function n(e,t,n,r,i){var s=Object.create(e),o=t;"/"!==o[0]&&(o=e.route+"/"+o),s[i]=n.view,s.route=s.id=o;for(var a in n)"view"!==a&&"route"!==a&&"id"!==a&&(s[a]=n[a]);return s}function r(e){return e.split("/").filter(function(e){return""!==e}).map(function(e){return e.replace(":","")}).slice(1)}R=function(t,n){var r,i,s={};for(r in t)i=t[r],e(s,r,i,t,n);return s}}();var M,N,B,I=Array.prototype.slice,U=new F("file://"+__dirname+"/");!function(){var e=";charset=utf-8";M="application/json"+e,N="text/html"+e,B="text/plain"+e}();var L;!function(){function e(n,r,i,s,o,a){if(a>=n.arr.length)return s(null,r,i);var u=n.arr[a];return null==u?e(n,r,i,s,o,++a):void u(r,i,t(n,r,i,s,o,a),o)}function t(t,n,r,i,s,o){return function(a){return a?(m.debug("<app:middleware:nextDelegate>".red,a),void i(a,n,r)):void e(t,n,r,i,s,++o)}}L=u({Construct:function(e){this.arr=e},process:function(t,n,r,i){e(this,t,n,r,i,0)},add:function(e){return null==e?this:"function"==typeof e?(this.arr.push(e),this):C(e)?(this.arr=this.arr.concat(e),this):this},Static:{create:function(e){return null==e?null:new L(e)}}})}();var W,z,J,V,G;!function(){function e(e,t){var n=b[e]=u({Base:W,Construct:function(){if(this instanceof n==!1){var e=[null].concat(I.call(arguments));return new(n.bind.apply(n,e))}},statusCode:t,name:e});return n}b.HttpError=W=u({Base:Error,_error:null,_json:null,Construct:function(e,t){return this instanceof W==!1?new W(e,t):(this._error=Error(e),this.message=String(e),void(null!=t&&(this.statusCode=t)))},name:"HttpError",statusCode:500,get stack(){if(null!=this._error){for(var e=this._error.stack.split("\n"),t=e.length,n=1,r=1,i=/\[as \w+Error\]/;++r<t&&!i.test(e[r]););return e.splice(1,r-n+1),e.join("\n")}},toString:function(){return this.message?this.name+": "+this.message:this.name},toJSON:function(){return null!=this._json?this._json:{name:this.name,error:this.message,code:this.statusCode}},Static:{create:function(e,n){if(y(e))return W(e,n);if(null!=e._error)return e;if(e instanceof Error){var r=W(e.message,n||500);return r._error=e,r}if(P(e)){if(e.toString!==t)return W(e.toString(),n||e.statusCode||e.status);var r,i=e.message,s=n||e.statusCode||e.status;return r=W(i,s),r._json=e,r}return G("Invalid error object: "+e)}}}),J=e("RequestError",400),V=e("SecurityError",403),z=e("NotFoundError",404),G=e("RuntimeError",500);var t=Object.prototype.toString}();var Z=function(){function t(e,t,r,i,s,o){var a=t.get(r,i);if(null==a)return!1;var u=a.value.controller||a.value;if(null==u)return m.error("<routing> no controller",r),!1;if(w(u))return o(new u(a,e.app)),!0;if(y(u)){var l=k(u)?u:F.combine(s,u);return n(e,l,a,o),!0}return w(u.process)?(o(u),!0):(m.error("<routing> invalid controller",u),!1)}function n(e,t,n,r){return i(t)?void o(e,t,n,r):void e.app.resources.js(t+"::Handler").done(function(i){var s=i.Handler;return null==s?(m.error("<handler> invalid route",t),void r(new f("Invalid route: "+t))):w(s.prototype.process)?(O()===!1&&(n.value.controller=s),P(s)&&w(s.process)?void r(s):void r(new s(n,e.app))):(m.error("<handler> invalid interface - process function not implemented"),void r(new f("Invalid interface")))})}function r(e,t){if(47===e.charCodeAt(0))return e;if(-1!==e.indexOf("://"))return e;var n=t&&t.location;if(null==n)return m.error("<Handler> Path is relative but no location. Set handler: {location: X} in config").error(e,t),e;var r,i,s=e.split("/"),r=n.split(/[\{\}]/g);for(e=r[0],i=1;i<r.length;i++)if(i%2===0)e+=r[i];else{var o=r[i]<<0;if(o>s.length-1&&(o=s.length-1),e+=s[o],i===r.length-2)for(o++;o<s.length;o++)e+="/"+s[o]}return e}var i,o,a=["subapps","handlers","services","pages"],l=u({Construct:function(e){this.app=e;for(var t=a.length;--t>-1;)this[a[t]]=new v},registerPages:function(e,t){var n,r,i=R(e,t);for(n in i)r=i[n],null==r.controller?r.controller=b.HttpPage:y(r.controller)&&(r.controller=this.app.config.$getController(r)),this.pages.add(r.route,r);return this},registerHandlers:function(e,t){for(var n in e)this.registerHandler(n,e[n],t);return this},registerHandler:function(e,t,n){y(t)&&(t={controller:r(t,n)}),this.handlers.add(e,t)},registerSubApps:function(e,t){for(var n in e)this.registerSubApp(n,e[n],t);return this},registerSubApp:function(e,t,n){var r=e;"^"!==r[0]&&("/"!==r[0]&&(r="/"+r),r="^"+r),this.subapps.add(r,new b.HttpSubApplication(e,t,this.app))},registerServices:function(e,t){for(var n in e)this.registerService(n,e[n],t);return this},registerService:function(e,t,n){w(t)?t={controller:t}:y(t)&&(t={controller:t}),y(t.controller)&&(t.controller=r(t.controller,n)),this.services.add(e,t)},registerWebsockets:function(e){for(var t in e)this.registerWebsocket(t,e[t]);return this},registerWebsocket:function(e,t,n){var i=this.app.webSockets;if(y(t)){r(t,n);return void p.instance().js(t+"::Handler").done(function(t){i.registerHandler(e,t.Handler)})}i.registerHandler(e,t)},get:function(e,n,r){var i=n.url,o=n.method,u=e.config.base;"POST"===o&&n.body&&n.body._method&&(o=n.body._method);for(var l,c=a.length,f=-1;++f<c;)if(l=a[f],t(this,this[l],i,o,u,r))return;if(this.app!==s){var h=s.handlers,p=s.config,d=t(h,h.handlers,i,o,p.base||u,r);if(d)return}r(null)},has:function(e,t){for(var n=a.length,r=-1;++r<n;)if(null!=this[a[r]].get(e,t))return!0;return!1},Static:{Handlers:{}}});!function(){function t(t){switch(t.toLowerCase()){case"self":return l.Handlers;case"global":return e}return null}var n=/\/\{(self|global)\}.?/;i=function(e){return n.test(e)},o=function(e,r,i,s){var o=n.exec(r),a=(o[0],o[1]),u=r.substring(o.index+o[0].length),l=t(a),h=c.obj.get(l,u);return null==h?(m.error("<handler> invalid route",r),void s(new f("Invalid route: "+r))):P(h)?void s(h):void s(new h(i,e.app))}}();var f=u({Base:u.Deferred,process:function(){return this.reject("Invalid Routing")}});return l}();b.IHttpHandler=u({Extends:u.Deferred,process:function(e,t){this.reject("Not Implemented",500)}}),b.HttpPage=function(){function e(e,t,n,r){this.config=t,this.page=e,this.req=n,this.res=r,this._rewrite=null,this._redirect=null}var t,n,r,i,o,a,h,d,v,g;!function(){t=function(e){return e.middleware&&(e.middleware=new L(e.middleware)),null==e.Base?e.Base=x:null==e.Extends?e.Extends=x:Array.isArray(e)?e.Extends.push(x):e.Extends=[x,e.Extends],u(e)},n=function(e){var t=e.ctx;return null==t.rewriteCount&&(t.rewriteCount=1),++t.rewriteCount>5?void e.reject("Too much rewrites, last path: "+t._rewrite):function(n){return null==n?void e.reject("Rewritten Path is not valid: "+t._rewrite):void n.process(t.req,t.res,t.config).done(e.resolveDelegate()).fail(e.rejectDelegate())}},i=function(e,t,n,i){return function(s){return s?void e.reject(s):void r(e,t,n,i)}},r=function(t,r,i,o){if(t.pattern){var a=l.parse(t.pattern,r.url).params;for(var u in a)null==t.query[u]&&(t.query[u]=a[u])}if(t.ctx=new e(t,o,r,i),"redirect"in t.data)return t.ctx.redirect(t.data.redirect),t;if("rewrite"in t.data)return r.url=t.data.rewrite,t.app.handlers.get(t.app,r,n(t)),t;if("secure"in t.data){var c=r.user,f=t.data.secure,h=f&&f.role;if(null==c||(h&&c.isInRole(h))===!1)return t.ctx.redirect(s.config.page.urls.login),t}return t._load()},o=function(e,t){null==e.ctx._redirect&&e.resolve(t)},a=function(e,t){if(null==e||""===e)return null;var n=e.indexOf("::");return-1!==n&&(e=e.slice(0,-n)),e+"::"+t},h=function(e,t,r){c.renderAsync(t,e.model,e.ctx,null,e).done(function(t){return null!=e.ctx._rewrite?void s.handlers.get(e.ctx._rewrite,n(e)):void r(t)}).fail(e.rejectDelegate())},function(){function e(e,t,n){for(var r,i=[],s=n.split(";"),o=s.length,a=-1;++a<o;)n=s[a],""!==n&&(r=f(t).find(n),null!=r?i.push(r):m.warn("<HttpPage.partial> Not found `%s`",s[a]));return i}function t(e,t,i){null==n&&(n=c.getHandler("atma:scripts")),null==r&&(r=c.getHandler("atma:styles"));var s=r.getModel(e,t,!0);n.getModel(e,t,!0,function(e){i({scripts:e.scripts,styles:s})})}d=function(n,r,i){r=e(n,r,i),t(n,n.ctx.config,function(e){if(e.templates){var t=f(":html").text(e.templates);r.push(t)}h(n,r,function(t){var r={type:"partial",html:t,scripts:e.scripts,styles:e.styles};o(n,r,"application/json",200)})})};var n,r}(),v=function(e,t){return function(n){q(e,n,t.statusCode||500,N)}},g=function(e,t){return function(n){var r=P(n)?JSON.stringify(n):n;r+="\nError: "+t.message,q(e,"ErrorPage Failed: "+r,500,B)}}}();var y=function(){var e={getScripts:function(e){return e.$getScripts(this.data.id)},getStyles:function(e){return e.$getStyles(this.data.id)}};return e}();e.prototype={redirect:function(e,t){null==t&&(t=302),this.res.statusCode=t,this.res.setHeader("Location",e),this.res.setHeader("Content-Length","0"),this.res.end(),this._redirect=e},rewrite:function(e){this._rewrite=e}};var C=b.HttpErrorPage=u({Extends:[u.Deferred,y],template:null,master:null,ctx:null,templatePath:null,masterPath:null,route:null,query:null,model:null,Construct:function(e,t,n){this._setPageData(t,n),this.model=e},_setPageData:function(e,t){this.data=e,null!=e.masterPath&&(this.masterPath=e.masterPath),null!=e.templatePath&&(this.templatePath=e.templatePath),e.master&&(this.masterPath=t.$getMaster(e)),e.template&&(this.templatePath=t.$getTemplate(e)),e.compo&&(this.compoPath=t.$getCompo(e)),null==this.template&&null==this.compoPath&&null==this.templatePath&&(this.templatePath=t.$getTemplate(e)),null==this.master&&null==this.masterPath&&(this.masterPath=t.$getMaster(e))},Static:{send:function(e,t,n,r){var i=r.page,s=i.errors,o=i.error,a=s&&s[e.statusCode]||o;return null==a&&(a={masterPath:"",templatePath:U.combine("../pages/error/error.mask").toString()}),new C(e,a,r).process(t,n,r)}},process:function(e,t,n){this.done(v(t,this.model)).fail(g(t,this.model)),r(this,e,t,n)},_load:function(){return this.resource=p.instance().load(a(this.masterPath,"Master"),a(this.templatePath,"Template")).js(a(this.compoPath,"Compo")).done(E(this._response,this)),this},_response:function(e){var t=e.load.Master||this.master,n=e.load.Template||this.template,r=this.nodes||n;return null==t&&""!==this.masterPath?void this.reject(W("Page: Masterpage not found")):null==r?void this.reject(W("Page: Template not found")):(t&&c.render(c.parse(t)),void h(this,r,$(o,this)))}}),x=u({Extends:[u.Deferred,y],template:null,master:null,app:null,ctx:null,middleware:null,templatePath:null,masterPath:null,compoPath:null,route:null,query:null,model:null,send:null,data:{id:null},Construct:function(e,n){if(this instanceof x==!1)return t(e);if(null==e)return this;var r=e;if(null==r.value)return m.error("<HttpPage> Route value is undefined"),this;var i=n.config,s=r.value;return this.app=n,this.route=i.page.route,this.query=r.current&&r.current.params,this._setPageData(s,i),this},_setPageData:function(e,t){this.data=e,null!=e.masterPath&&(this.masterPath=e.masterPath),null!=e.templatePath&&(this.templatePath=e.templatePath),e.master&&(this.masterPath=t.$getMaster(e)),e.template&&(this.templatePath=t.$getTemplate(e)),e.compo&&(this.compoPath=t.$getCompo(e)),null==this.template&&null==this.compoPath&&null==this.templatePath&&(this.templatePath=t.$getTemplate(e))},process:function(e,t,n){return null==this.middleware?r(this,e,t,n):(this.middleware.process(e,t,i(this,e,t,n),n),this)},sendError:function(e,t,n,r){C.send(e,t,n,r)},_load:function(){var e,t,n=this.data.env;null!=n&&(t=n.both,e=n.server);var r=this.ctx.config.base,i=this.app.resources;return this.resource=p.instance(r,i).setBase(r).load(a(this.masterPath,"Master"),a(this.templatePath,"Template")).js(a(this.compoPath,"Compo")).js(t).js(e).done(E(this._response,this)),this},_response:function(e){var t=e.load.Master||this.master,n=e.load.Template||this.template,r=e.Compo;if(null==t&&this.masterPath)return void this.reject(W("Page: Masterpage not found"));if(null==n&&null==r)return void this.reject(W("Page: Template not found"));if("master"===this.query.debug)return void this.resolve(t);if("template"===this.query.debug)return void this.resolve(n);this.query.breakOn&&(this.ctx.debug={breakOn:this.query.breakOn}),t&&c.render(c.parse(t)),null!=r&&(n&&null==r.template&&(r.template=n),null==r.mode&&(r.mode="server"),this.nodes=new c.Dom.Component("",null,r)),w(this.onRenderStart)&&this.onRenderStart(this.model,this.ctx);var i=this.nodes||n;return this.query.partial?void d(this,i,this.query.partial):void h(this,i,$(o,this))}});return x}(),b.HttpService=function(){function e(e){var n,r;"string"==typeof e?(n=e,r=I.call(arguments,1)):r=I.call(arguments);var o,a,c,f=t(r),h=new l.Collection,p=f.ruta||f;for(o in p)c=p[o],a=null,w(c)&&(a={process:c}),null==a&&C(c)&&(a={process:new i(c)}),null==a&&P(c)&&(a=c),null!=a&&C(a.process)&&(a.process=new i(a.process)),null!=a&&w(a.process)!==!1?h.add(o,a):m.warn("<HttpService> `process` is not a function"+o+typeof a.process);return f.routes=h,null!=n&&(f.name=n),null==f.Extends?f.Extends=s:Array.isArray(f.Extends)?f.Extends.push(s):f.Extends=[s,f.Extends],u(f)}function t(e){if(1===e.length)return e[0];for(var t,n,r=e[0],i=r.ruta||r,s=e.length,o=0;++o<s;){t=e[o],n=t.ruta||t;for(var a in n)null!=n[a]&&(i[a]=n[a]);if(null!=t.ruta)for(var a in t)"ruta"!==a&&null!=t[a]&&(r[a]=t[a])}return r}var n,r;!function(){n=function(e,t){if(null==t)return!0;if(t===!0||null==t.role)return null!=e.session||null!=e.user;var n=e.user,r=t.role;return null!=n&&(null==r||n.isInRole(r))},r=function(e,t,n){return null==e?"Message Body is not defined":u.validate(e,t,n)}}();var i=function(){function e(e,r,i,s,o,a){if(!(a>=e.length)){var u,l=e[a];u=l.call(r,i,s,o,t(e,r,i,s,o,a)),u&&n(r,u)}}function t(t,r,i,s,o,a){return function(u){return u?n(r,u):void e(t,r,i,s,o,++a)}}function n(e,t){"string"==typeof t&&(t=W(t)),e.reject(t)}var r=u.Collection(Function,{Base:u.Serializable,process:function(t,n,r,i){e(this,t,n,r,i,0)}});return function(e){var t,n=new r(e);return function(e,r,i){t=this,n.process(t,e,r,i)}}}();!function(){function e(e,t){t.done(e.resolveDelegate()).fail(e.rejectDelegate())}b.HttpCrudEndpoints={Single:function(t,n){var r={},i=t,s=b.HttpService.classParser(t,n),o=b.HttpService.classPatchParser(t,n),a=u.properties(n);return Object.keys(a).forEach(function(e){a["?"+e]=a[e],delete a[e]}),r["$get /"+t+"/:id"]={meta:{response:a},process:function(t,r,i){e(this,n.fetch({_id:i.id}))}},r["$put /"+t+"/:id"]={meta:{description:"Update existed entity",arguments:a,response:a},process:[s,function(t,n,r){var i=t[a];i._id=r.id,e(this,i.save())}]},r["$post /"+t]={meta:{description:"Create new entity",arguments:a,response:a},process:[s,function(t){var n=t[i];delete n._id,e(this,n.save())}]},r["$delete /"+t+"/:id"]={meta:{description:"Remove entity"},process:function(t,r,i){var s=new n({_id:i.id});e(this,s.del())}},r["$patch /"+t+"/:id"]={meta:{description:"Modify existed entity. `patch object` syntax is similar to MongoDB's"},process:[o,function(t,r,i){var s=t.body,o=new n({_id:i.id}).patch(s);e(this,o)}]},r},Collection:function(t,n){var r={},i=t,s=b.HttpService.collectionParser(i,n),o=u.properties(n.prototype._ctor);r["$get /"+t]={meta:{response:[o]},process:function(){e(this,n.fetch({}))}};var a={meta:{description:"Create or update(if _id is present) entries",arguments:[o]},process:[s,function(t){e(this,t[i].save())}]};return r["$put /"+t]=a,r["$post /"+t]=a,r["$delete /"+t]={meta:{arguments:[{_id:"string"}]},process:[function(e,t,r,s){if(Array.isArray(e.body)===!1)return void s("Invalid arguments. Array expected");for(var o=e.body.length,a=-1;++a<o;)if(!e.body[a]._id)return void s("`_id` property expected at "+a);e[i]=new n(e.body)},function(t){e(this,t[i].del())}]},r["$patch /"+t]={meta:{description:"<is not supported>"},process:function(){this.reject(W("`PATCH` is not supported for collections"))}},r}}}(),function(){function t(e,t){var n,r;for(r in e){if(void 0===t[r])return"Unexpected property "+r;if(n=typeof e[r],"undefined"!==n&&n!==t[r])return"Type mismatch "+n+"/"+t[r]}return null}var n="<service> Model deserialization: ";e.classParser=function(e,r){var i=u.properties(r);return function(s,o,a,l){if(null==s.body)return void l("Body is not defined");var c=t(s.body,i);return null!=c?void l(n+c):(s[e]=new r(s.body),c=u.validate(s[e]),null!=c&&(c=n+c),void l(c))}},e.collectionParser=function(e,r){var i=u.properties(r.prototype._ctor);return function(s,o,a,l){if(Array.isArray(s.body)===!1)return void l("Array expected");for(var c,c,f=s.body.length,h=-1;++h<f;)if(c=t(s.body[h],i),null!=c)return void l(n+c);for(s[e]=new r(s.body),h=-1;++h<f;)if(c=u.validate(s[e][h]),null!=c)return void l(n+c);l()}},e.classPatchParser=function(e,t){var n=u.properties(t);return function(e,t,r,i){if(null==e.body)return i("Body is not defined");var s=e.body.$set;if(s){var o,a,u;for(a in s){if(u=a.indexOf("."),-1!==u&&(a=a.substring(0,u)),void 0===n[a])return i("Unexpected property "+a);if(o=typeof e.body[a],"undefined"!==o&&o!==n[a])return i("Type mismatch "+o+"/"+n[a])}}i()}}}();var s=u({Extends:u.Deferred,secure:null,Construct:function(e){if(null!=e){for(var t=e.path,n=0,r=t.length,i=0;r>n&&"string"==typeof t[n];n++)i+=t[n].length+1;this.rootCharCount=i,"secure"in e.value&&(this.secure=e.value.secure||{})}},help:function(){for(var e,t,n,r=this.routes.routes,i=[],s=-1,o=r.length;++s<o;)e=r[s],t={method:e.method||"*",path:e.definition},n=e.value.meta,n&&(t.description=n.description,t.arguments=n.arguments,t.response=n.response,"secure"in e.value&&(t.secure=e.value.secure||!0)),i.push(t);return i},process:function(e,t){var i=e.url.indexOf("?");if(-1!==i&&/\bhelp\b/.test(e.url.substring(i)))return this.resolve(this.help());if(n(e,this.secure)===!1)return this.reject(V("Access Denied"));var s=e.url.substring(this.rootCharCount),o=this.routes.get(s,e.method);if(null==o&&"OPTIONS"===e.method){var a=this.getOptions(s,e,t);if(a)return t.writeHead(200,a),void t.end()}if(null==o){var u=this.name||"<service>",l=s||"/";return this.reject(z(u+": endpoint not Found: <"+e.method+"> "+l))}var c=o.value,f=c.meta,h=f&&f.arguments;if(null!=f&&n(e,f.secure)===!1)return this.reject(V("Access Denied"));if(null!=h){var p="GET"===e.method,d=p===!1&&f.strict,v=p?o.current.params:e.body,g=r(v,h,d);if(g)return this.reject(J(g))}return c.process.call(this,e,t,o.current.params),this},getOptions:function(){var e=["GET","POST","PUT","PATCH","HEAD","DELETE"];return function(t,n,r){for(var i=null,s=[],o=e.length;--o>-1;){var a=e[o],u=this.routes.get(t,a);null!=u&&(s.push(a),u.meta&&u.meta.headers&&(i=_(i,u.meta.headers)))}if(0===s.length)return null;this.meta&&this.meta.headers&&(i=_(i,this.meta.headers));var l=s.join(",");return i.Allow=l,i["Access-Control-Allow-Methods"]=l,void 0===i["Content-Type"]&&(i["Content-Type"]="application/json;charset=utf-8"),i}}()});return e.Barricade=i,e}();var Q;!function(){function e(){}Q=function(n){var s,o={};return{listen:function(n){this.listen=e,m.log("Web socket opened".green.bold),s=t(n,o)},hasHandlers:function(){return 0!==Object.keys(o).length},getHandler:function(e){return o[e]},registerHandler:function(e,t){return o[e]=t,null==s?void(null!=n&&n._server&&this.listen(n._server)):void r(s,e,t)},clients:function(e){if(null==s)return[];var t=s.of(e),n=[];for(var r in t.connected)n.push(t.connected[r]);return n},of:function(e){return null==s?null:s.of(e)},emit:function(e){var t=I.call(arguments,1),n=t[t.length-1];if(null==s)return console.error("Emitting to the websockets (%s), but server is not started",e),void(n&&n({message:"Server is not started"}));if(null==o[e])return console.error("No handlers are bound to the namespace",e),void(n&&n({message:"No handlers"}));if("function"==typeof n)return t.pop(),void i(this.clients(e),t,n);var r=s.of(e);r.emit.apply(r,t)}}};var t,n,r,i;!function(){t=function(e,t){var n=require("socket.io")(e,{"log level":2});for(var i in t)r(n,i,t[i]);return n},r=function(e,t,r){e.of(t).on("connection",n(e,t,r))},n=function(e,t,n){return function(t){new n(t,e)}},i=function(e,t,n){function r(e){s.push(e),--i<1&&n(null,s)}var i=e.length,s=[];if(0===i)return void n(null,s);var o,a=-1;for(t.push(r);++a<i;)o=e[a],o.emit.apply(o,t)}}()}(),function(){function e(e){return function(t,n,r){X.enabled&&X.watch(t.url,e.config);var i=null!=e._innerPipe?l(e._innerPipe):h;null==r&&(r=e._404),f(e,t,n,r,i)}}function t(e,t,n){f(e,t,n,function(){n.writeHead(500),n.end("Not Found")},g)}function l(e){return function(t,n,r,i){function s(e){return e?void T(i,e):void h(t,n,r,i)}e.process(r,i,s,t.config)}}function f(e,t,n,r,i){e.handlers.get(e,t,function(s){return null==s?void r():void x(e,function(){i(e,s,t,n)})})}function h(e,t,n,r){if(m(95).log("<request>",n.url),t.process(n,r,e.config),null!=t.done){var i=v(e,t);t.done(function(e,n,s,o){var a=t.send||q;null!=i&&(o=j(o,i)),a(r,e,n,s,o)}).fail(function(s,o){return s=W.create(s,o),t.sendError?void t.sendError(s,n,r,e.config):void T(r,s,i)})}}function v(e,t){var n=t.meta&&t.meta.headers,r=e.config.headers;if(null==n&&null==r)return null;var i;return i=n?Object.create(n):null,i=j(i,r)}function g(e,t,n,r){return t instanceof b.HttpSubApplication?void t.execute(n,r):(t.process(n,r,e.config),void(null!=t.done&&t.pipe(r)))}function P(e){return function(){E.trigger("configurate",e),i(e);var t=e.config;e.handlers.registerPages(t.pages,t.page).registerSubApps(t.subapps,t.subapp).registerHandlers(t.handlers,t.handler).registerServices(t.services,t.service).registerWebsockets(t.websockets,t.websocket),O()&&p.cfg("autoreload",!0),x(e,function(){e.resolve(e)})}}function x(e,t){if(O()!==!0&&null!=e.resources)return void t();var n=e.config,r=n.base,i=n.env;e.resources=p.instance(r).setBase(r).js(i.server.scripts).js(i.both.scripts),e.resources.done(function(r){e.lib=r;var i=n.projects;if(i)for(var s in i){var o=r[s];null!=o&&"function"==typeof o.attach&&o.attach(e)}t()})}var S,E=new u.EventEmitter;!function(){var e,t="server/config/**.yml",r="public/build/stats.json";!function(){e={format:function(e,t){if(47===t.charCodeAt(0))return/\.\w{1,7}$/.test(t)===!1&&(t+=".mask"),t;var n,r,i=t.split("/"),n=e.split(/[\{\}]/g);for(t=n[0],r=1;r<n.length;r++)if(r%2===0)t+=n[r];else{var s=n[r]<<0;if(s>i.length-1&&(s=i.length-1),t+=i[s],r===n.length-2)for(s++;s<i.length;s++)t+="/"+i[s]}return t}}}();var i,l,f,h,v,g,b={$formatPath:e.format};!function(){i=function(e,t,n){function r(t){if("string"!=typeof t)return{config:t};var n=k(t)?t:F.combine(e,t);return{path:n}}return null==t&&void 0!==t?null:void 0===t?[r(n)]:"string"==typeof t?[r(t)]:t.map(r)},l=function(e){
var t=p.instance(e.base);e.env.both.routes&&t.routes(e.env.both.routes),e.env.both.include&&t.cfg(e.env.both.include.cfg),e.env.server.include&&t.cfg(e.env.server.include.cfg),e.env.server.routes&&t.routes(e.env.server.routes),P.prepair(e.env.server.scripts),P.prepair(e.env.client.scripts)},f=function(e){var t=e.mask;null!=t&&c.compoDefinitions(t.compos,t.utils,t.attributes)},h=function(e){var t=e.pages;if(null!=t){var n,r;for(r in t)n=t[r],null==n.id&&(n.id=r),null==n.route&&(n.route=r)}},v=function(e,t){if(null==e.plugins)return null;if(t.isRoot===!1)return null;var n=new u.Await,r=e.plugins.map(function(t){for(var n,r=new F(e.base),i="node_modules/"+t+"/index.js";;){if(n=r.combine(i),a.File.exists(n)){i=n.toString();break}if(r=r.combine("../"),""===r.path||"/"===r.path)break}return i+"::"+t});return p.instance(e.base).js(r).done(function(e){for(var r in e)e[r]&&"function"==typeof e[r].attach&&e[r].attach(t);n.resolve()}),n},function(){function e(e,n){return new u.Await(t(e,n,"scripts"),t(e,n,"styles"))}function t(e,t,r){return new u.Await(n(e,t,r,"client"),n(e,t,r,"server"),n(e,t,r,"both"))}function n(e,t,n,i){var s=e.env[i],o=s[n],a=o&&o[t];if(null==a)return null;var l=new u.Deferred;return r(e,n,t,a,function(e){for(var n,r=o[t],i=r.length,s=-1;++s<i;)n=e[r[s]],y(n)?r[s]=n:C(n)?(r.splice.apply(r,[s,1].concat(n)),s+=n.length-1,i+=n.length-1):m.error("Module path mapping is not defined",r[s]);l.resolve()}),l}function r(e,t,n,r,l){var h=new F(e.base),p={},d=c[n];if(null==d)throw Error("Support:"+Object.keys(c)+" Got:"+n);var v=new u.Await,g=d.dir,b=d["package"];r.forEach(function(e){if(null!=e){var n=e,r=e.indexOf("::"),u="";if(-1!==r&&(u=e.substring(r),e=e.substring(0,r)),-1!==e.indexOf("/"))return/\.\w+$/.test(e)===!1&&(e+="."+f[t]),void(p[n]="/"+g+"/"+e+u);var l=o(h,g+"/"+e+"/"+b);return null==l&&(d.alternate&&(l=o(h,g+"/"+e+"/"+d.alternate)),null==l)?void m.error("<Module is not resolved>",e):void a.File.readAsync(l).done(function(r){var o="/"+g+"/"+e+"/",a=r.main;return null==a&&(a="index.js"),y(a)?void s(p,n,a,o,u):C(a)?void i(p,n,a,o,u,t):void m.error("Main is not defined",l)}).fail(m.error).always(v.delegate(e,!1))}}),v.always(function(){l(p)})}function i(e,t,n,r,i,s){for(var o,a=n.length,u=-1,c=[];++u<a;)o=l(n[u]),h[o]===s&&c.push(r+n[u]+i);e[t]=c}function s(e,t,n,r,i){e[t]=r+n+i}function o(e,t){for(var n;;){if(n=e.combine(t),a.File.exists(n)){t=n.toString();break}if(e=e.combine("../"),""===e.path||"/"===e.path)return null}return t}function l(e){var t=e.lastIndexOf(".");return-1===t?"":e.substring(t+1)}g=function(t,n){return new u.Await(e(t,"npm"),e(t,"bower"))};var c={bower:{dir:"bower_components","package":"bower.json",alternate:"component.json"},npm:{dir:"node_modules","package":"package.json"}},f={scripts:"js",styles:"css"},h={js:"scripts",css:"styles"}}()}();var w=function(){function e(e,n){return null==n?e:"string"==typeof n?(e.src=n,e):(n.src&&(e.src=n.src),n.cfg&&(e.cfg=t(e.cfg,n.cfg,"loader"),n.cfg.loader&&(e.cfg.loader=t(e.cfg.loader,n.cfg.loader))),n.routes&&t(e.routes,n.routes),e)}function t(e,t,n){if(null==t)return e;null==e&&(e={});for(var r in t)r!==n&&(e[r]=t[r]);return e}var n={$getScripts:u.Fn.memoize(function(e){var t=r("scripts",this.env).slice();return e&&(t=t.concat(this.$getScriptsForPageOnly(e))),t}),$getScriptsForPageOnly:u.Fn.memoize(function(e){var t=this.pages[e],n=[];if(null==t)return m.error("<page:scripts> Page not defined",e),null;if(null!=t.scripts&&(n=n.concat(r("page",this.env,t.scripts,t.routes))),null!=t.env&&(n=n.concat(r("scripts",this.env,t.env))),t.view&&t.view.controller){var i=this.$formatPath(this.page.location.viewController,t.view.controller);n.push(i)}return n}),$getStyles:function(e){var t=this,n=r("styles",t.env).slice();return e&&(n=n.concat(this.$getStylesForPageOnly(e))),n},$getStylesForPageOnly:function(e){var t=this,n=t.pages[e],i=[];if(null==n)return m.error("<page:styles> Page not defined",e),null;if(n.styles&&(i=i.concat(r("page",t.env,n.styles,n.routes))),n.env&&(i=i.concat(r("styles",t.env,n.env))),n.compo){var s=this.$getCompo(n),o=p.getResource(s);null!=o?o.includes.forEach(function(e){"css"===e.resource.type&&i.push(e.resource.url)}):m.error("<page:styles> compo resource is undefined",s)}if(n.view&&n.view.style){var s=this.$formatPath(this.page.location.viewStyle,n.view.style);i.push(s)}return i},$getInclude:function(){var t=this.env,n={src:"",routes:{},cfg:{}};return e(n,t.both.include),e(n,t.client.include),n.src||(console.error("[CLIENT CONFIGURATION ERROR]"),console.error("- Include PATH is not specified in `env:client:include:src`")),e(n,{routes:t.both.routes}),e(n,{routes:t.client.routes}),n},$getIncludeForPageOnly:function(t){var n=this.pages[t],r={};return n&&n.include?e(r,n.include):r},$getTemplate:function(e){var t=e.template||this.page.index.template,n=this.page.location.template,r=this.$formatPath(n,t);return F.combine(this.base,r)},$getMaster:function(e){var t=e.master||this.page.index.master,n=this.page.location.master,r=this.$formatPath(n,t);return F.combine(this.base,r)},$getController:function(e){var t=e.controller||this.page.index.controller;if(null==t)return null;var n=this.page.location.controller,r=this.$formatPath(n,t);return F.combine(this.base,r)},$getCompo:function(e){var t=e.compo;if(null==t)return null;var n=this.page.location.compo||this.page.location.controller,r=this.$formatPath(n,t);return F.combine(this.base,r)}},r=u.Fn.memoize(function(e,t,n,r){function i(e){if(null!=e)for(var t in e)o.register(t,e[t])}function s(e){null!=e&&o.each("js",e,function(e,t){a.push(t.path)})}var o=new d.Routes,a=[];switch(i(t.client&&t.client.routes),i(t.both&&t.both.routes),i(r),e){case"page":s(n);break;case"debug":s(t.client.debug);break;case"scripts":case"styles":var u=n||t;s(u.client&&u.client[e]),s(u.both&&u.both[e]);break;default:m.error("Unsupported type",e)}return a});return n}(),P=function(){function e(s){if(null!=s)if(n(s)){for(var o,a=s,u=s.length,l=0;u>l;l++)if(o=a[l],null!=o&&"string"!=typeof o){var c=r(o);if(null!=c)if(i(c)){var f=t(a,l,c.value);u+=f,l+=f}else a.splice(l,1),l--,u--;else e(o)}}else if("object"==typeof s)for(var h in s)e(s[h])}function t(e,t,r){return n(r)?(Array.prototype.splice.apply(e,[t,1].concat(r)),r.length):(e.splice(t,1,r),1)}function r(e){for(var t in e)return"if#"!==t.substring(0,3)?null:{key:t.substring(3),value:e[t]};return null}function i(e){return s.args[e.key]}return{prepair:function(t){e(t)}}}();S=function(e,n,s,a){e=e||{};var c,p,d=e.base,m=e.configs;d=null==d?"file://"+A(process.cwd())+"/":H(d+"/"),m=i(d,m,t),m&&(c=d+(e.buildDirectory||r)),e.config&&(p={config:e.config});var y=[{config:JSON.parse(o)},c?{path:c,optional:!0}:null,{config:b},{path:d+"package.json",getterProperty:"atma",optional:!0},{config:w},p];return m&&(y=y.concat(m)),Array.isArray(e.sources)&&(y=y.concat(e.sources)),y.push({config:{base:d}}),require("appcfg").fetch(y).fail(function(e){throw new Error("<app:configuration>",e)}).done(function(){var e=this;new u.Await(f(e),l(e),h(e,n),v(e,n),g(e,n)).always(function(){process.nextTick(s)})})}}(),b.HttpSubApplication=function(){function e(e,t){e.url=e.url.replace(t.path_,"/")}var n="",r="loading",i="loaded",s="error";return u({status:n,app_:null,Construct:function(e,t,n){if("/"!==e[0]&&(e="/"+e),"/"!==e[e.length-1]&&(e+="/"),this.path_=e,this.dfr=new u.Deferred,t instanceof b.Application)return this.app_=t,void(this.status=i);var o=t.controller||t,a=this;if(y(o)){this.status=r;var l=n.config.base||n.base||"/";return void p.instance(l).setBase(l).js(o+"::App").done(function(e){return e.App instanceof b.Application?void e.App.done(function(e){a.app_=e,a.process=a.pipe,a.status=i,a.dfr.resolve()}):void(a.status=s)})}var c=t.configs,f=t.config;null==f&&null==c&&(c=e),this.status=r,b.Application({configs:c,config:f}).done(function(e){a.app_=e,a.process=a.pipe,a.status=i,a.dfr.resolve()})},process:function(e,t){return this.status===r?void this.dfr.done(this.pipe.bind(this,e,t)):this.status===i?void this.pipe(e,t):(t.writeHead(500,{"Content-Type":"text/plain"}),void t.end("<Sub Application Errored> "+this.path_))},pipe:function(t,n){return t.url.length<this.path_.length?(n.writeHead(301,{Location:this.path_}),void n.end()):(e(t,this),void this.app_.process(t,n))},execute:function(n,r){e(n,this),t(this.app_,n,r)}})}();var $={};!function(){$.Request=u({Construct:function(e,t,n,r){this.url=e,this.method=(t||"GET").toUpperCase(),this.body=n,this.headers=r}}),$.Response=u({Extends:[u.EventEmitter,u.Deferred],writable:!0,finished:!1,statusCode:null,Construct:function(){this.body="",this.headers={}},Override:{resolve:function(e,t,n,r){this["super"](e||this.body,t||this.statusCode||200,n,r||this.headers)},reject:function(e,t){this["super"](e||this.body,t||e.statusCode||this.statusCode||500)}},writeHead:function(e){if(this.writable!==!1){var t,n;3===arguments.length&&(t=arguments[1],n=arguments[2]),2===arguments.length&&(n=arguments[1]),this.statusCode=e,_(this.headers,n)}},setHeader:function(){},end:function(e){this.finished!==!0&&(this.write(e),this.finished=!0,this.writable=!1,this.resolve(this.body,this.statusCode,null,this.headers))},write:function(e){return this.writable!==!1&&null!=e?null==this.body?void(this.body=e):w(this.body.concat)?void(this.body=this.body.concat(e)):void(this.body=[this.body,e]):void 0}})}(),b.Application=u({Extends:u.Deferred,isRoot:!1,handlers:null,_server:null,_innerPipe:null,_outerPipe:null,_responder:null,_responders:null,middleware:null,resources:null,lib:null,webSockets:null,Construct:function(e){return null==e&&(e={}),this instanceof b.Application==!1?new b.Application(e):(null==s&&(s=this),this.isRoot=this===s,this.handlers=new Z(this),this.webSockets=Q(this),this.args=_(e.args,r()),this._baseConfig=e,this._loadConfig(),this.isRoot&&O()!==!0&&m.cfg("color","none"),this.process=this.process.bind(this),this)},respond:function(e,t,n){this.process(e,t,n)},responder:function(t){return this._innerPipe=L.create(t&&t.middleware),e(this)},responders:function(e){this._outerPipe=new L(e)},processor:function(t){t=t||{};var n=t.before,r=t.after,i=t.middleware;return this._outerPipe=L.create(n||[]),this._innerPipe=L.create(i),this._outerPipe.add(e(this)),this._outerPipe.add(r),this},process:function(e,t,n){null==this._outerPipe&&this.processor(),this._outerPipe.process(e,t,n||this._404,this.config)},execute:function(e,n,r,i){var s=new $.Request(e,n,r,i),o=new $.Response;return t(this,s,o),o},autoreload:function(e){this._server=this._server||e,null!=this._server&&X.enable(this)},listen:function(){for(var e,t,n,r=arguments.length;--r>-1;)if(n=arguments[r],null!=n)switch(typeof n){case"number":case"string":e=n;break;default:n.listen&&(t=n)}if(null==e&&(e=this.config.$get("port")),null==e)throw Error("Port number is not defined");return null==t&&(t=require("http").createServer()),this._server=t.on("request",this.process).listen(e),this.webSockets.hasHandlers()&&this.webSockets.listen(this._server),O()&&this.autoreload(),E.trigger("listen",this),this._server},getSubApp:function(e){var t=this.handlers.subapps.get(e);return t&&t.value&&t.value.app_},Self:{_loadConfig:function(){var e=this._baseConfig;return this.config=S(e,this,P(this),function(e){m.warn("Configuration Error").error(e)}),this},_404:function(e,t,n){e=null==e?W("Endpoint not found: "+t.url,404):W.create(e);var r=t.headers.accept;return null==r||-1!==r.indexOf("text/html")?void b.HttpErrorPage.send(e,t,n,this.config):void T(n,e)}},Static:{on:E.on.bind(E),off:E.off.bind(E),once:E.once.bind(E),trigger:E.trigger.bind(E)}})}(),p.cfg({loader:{coffee:{process:function(e,t){return require("coffee").compile(e)}}}}),p.cfg({loader:{less:{process:function(e,t,n){var r=t.path_getFile(),i=t.path_getDir(),s=require("less"),o=new s.Parser({filename:r,paths:[i]});o.parse(e,function(e,t){var i;if(e)return void m.error("<less:parse>",r,e);try{i=t.toCSS()}catch(e){m.error("<less:toCss>",r,e)}n(i)})}}}}),p.cfg({loader:{yml:{process:function(e,t){var n=require("yamljs");e=e.replace(/\t/g,"  ");try{return n.parse(e)}catch(r){return m.error("<yml parser>",r),null}}}}});var X;!function(){function e(e){return function(t){e.defer()._loadConfig().done(function(){X.fileChanged(t)})}}X={enabled:!1,enable:function(t){this.enabled=!0,t.webSockets.registerHandler("/browser",n);var r=new a.Directory("server/config/");return r.exists()&&r.watch(e(t)),p.cfg("autoreload",this),this.base=t.config.base,this},watch:function(e,t){if(/\.[\w]+$/.test(e)!==!1){var n=e.indexOf("?");-1!==n&&(e=e.substring(0,n));var r=t["static"]||t.base||"/",i=F.combine(r,e),s=new a.File(i);s.requestedUrl=e,this.watchFile(s)}},watchFile:function(e){e.uri&&e.uri.file&&(/\.map$/.test(e.uri.file)||t.isWatching(e)||a.File.prototype.exists.call(e)!==!1&&t.watch(e))},unwatch:function(e){t.unwatch(new a.File(e))},fileChanged:function(e,n){t.fileChanged(e,n,null,this.base)},isWatching:function(e){return"string"==typeof e&&(e=new a.File(e)),t.isWatching(e)},listenDirectory:function(e,t){new a.Directory(e).watch(t)},getWatcher:function(){return t}};var t;!function(){t=new(u({Base:u.EventEmitter,watch:function(e){var t=e.uri.toString();if(null==r[t]){var i;i=new n(e),i.bind(this.fileChanged),r[t]=i}},unwatch:function(e,t){var n=e.uri.toString();return null==r[n]?void m.log("<watcher> No watchers",n):(r[n].unbind(t),void delete r[n])},isWatching:function(e){var t=e.uri.toString();return null!=r[t]},Self:{fileChanged:function(t,n,r,i){if("filewatcher"===n){var s=r||"/"+t.replace(e,"");return void(null==p.getResource(s)&&this.trigger("fileChange",s,t))}this.isWatching(new a.File(t))||(i&&(i=new F(i).toLocalFile(),t=t.replace(i,"")),this.trigger("fileChange",t))}},bind:function(e){return this.on("fileChange",e)},unbind:function(e){return this.off("fileChange",e)}}));var e=A(process.cwd()+"/"),n=u({Base:u.EventEmitter,Construct:function(e){this.active=!1,this.file=e},Self:{fileChanged:function(e){m.log("<watcher:changed>",e),this.trigger("fileChange",e,"filewatcher",this.file.requestedUrl)}},bind:function(e){this.on("fileChange",e),this.active||(a.watcher.watch(this.file.uri.toLocalFile(),this.fileChanged),this.active=!0)},unbind:function(e){this.off("fileChange",e),0===this._listeners.length&&a.watcher.unwatch(this.file.uri.toLocalFile())}}),r={}}();var n=u({Construct:function(e){m.log("<autoreload> Socket connected"),this.socket=e,e.on("disconnect",this.disconnected),t.on("fileChange",this.fileChanged)},Self:{fileChanged:function(e){var t=this.socket;setTimeout(function(){m.log("<autoreload sockets> path",e),t.emit("filechange",e)},50)},disconnected:function(){t.off("fileChange",this.fileChanged)}}});H("/")}();return function(){!function(){function e(){return t=require("static-content"),O()&&t.on("file",function(e){X.watchFile(e)}),t}S(b,"StaticContent",function(){return e()});var t;X.getWatcher().on("fileChange",function(e,n){null!=t&&t.Cache.remove(n)})}()}(),b.middleware={},function(){b.middleware.query=function(t,n,r){var i=t.url,s=i.indexOf("?");t.query=-1===s?{}:e(i.substring(s+1)),r()};var e=l.$utils.query.deserialize}(),function(){function e(e,n,r,i){null==t&&(t=b.StaticContent.respond),t(e,n,r,i)}b.middleware["static"]=e,e.config=function(e){return t=b.StaticContent.create(e)};var t=null}(),function(){Z.Handlers.MaskRunner=u({Extends:b.IHttpHandler,app:null,Construct:function(e,t){this.app=t,this.route=e},process:function(e,t,n){var r=e.url.replace(/\.\w+$/,""),i={current:this.route.current,value:{template:r,master:null}},s=new b.HttpPage(i,this.app);return s.process(e,t,n).pipe(this),this}})}(),o=['{"env":{"both":{"include":{"cfg":null},"routes":null,"scripts":null},"client":{"include":{"cfg":null,"src":"/bower_components/includejs/lib/include.js"},"scripts":null,"styles":null,"routes":null},"server":{"routes":null,"scripts":null}},"handler":{"location":"/server/http/handler/{0}.js"},"handlers":{"(\\\\.mr$|\\\\.mr\\\\?.+)":"/{self}.MaskRunner"},"mask":{"compos":{":scripts":{"mode":"server:all"},":styles":{"mode":"server:all"},":template":{"mode":"server"},"layout:master":{"mode":"server"},"layout:view":{"mode":"server"},":animation":{"mode":"client"}},"attributes":null},"page":{"location":{"controller":"/server/http/page/{0}/{1}.js","template":"/server/http/page/{0}/{1}.mask","master":"/server/http/master/{0}.mask","viewTemplate":"/public/view/{0}/{1}.mask","viewController":"/public/view/{0}/{1}.js","viewStyle":"/public/view/{0}/{1}.less"},"extension":{"javascript":"js","style":"less","template":"mask"},"index":{"template":"index","master":"default"},"urls":{"login":"/login"},"pattern":"/:view/:category/:section"},"pages":{"/":{"id":"index","title":"Default Title"}},"service":{"location":"/server/http/service/{0}.js"},"services":null,"view":{"location":{"template":"/public/view/{0}/{1}.mask","controller":"/public/view/{0}/{1}.js","style":"/public/view/{0}/{1}.less"}},"websocket":{"location":"/server/http/websocket/{0}.js"},"websockets":null}'][0],null!=t.atma&&"object"==typeof t.atma?t.atma.server?void _(t.atma.server,b):void(t.atma.server=b):void(t.atma={server:b})});
//# sourceMappingURL=server.min.js.map