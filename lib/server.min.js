!function(e,t){"use strict";var r,n;"undefined"==typeof exports||e!==exports&&null!=e&&e!==global||(r=n=global),null==r&&(r="undefined"==typeof window?global:window),null==n&&(n=e||r),t(r,n)}(this,function(e,t){"use strict";function r(e,t){if(null==e&&(e={}),null==t)return e;for(var r in t)e[r]=t[r];return e}function n(e,t){return function(){return e.apply(t,arguments)}}function i(e){return Array.isArray(e)}function o(){for(var e,t=process.argv,r=t.length,n=2,i={args:[]};r>n;n++)if(e=t[n],"-"!==e[0]){var o=e.indexOf("=");-1===o?i.args.push(e):i[e.substring(0,o)]=e.substring(o+1)}else i[e.replace(/^[\-]+/,"")]=!0;return i}var s,a,l,u,c,f,d,p,h,g,v,m={},y=Array.prototype.slice;e.include&&e.net&&e.net.Uri&&(l=e),null==l&&e.atma&&(l=e.atma),null==l&&(require("atma-libs/globals-dev"),l=e),e.logger&&(v=e.logger),null==v&&(require("atma-logger"),v=e.logger),e.io&&e.io.File&&(u=e.io),null==u&&(require("atma-io"),u=e.io),c=l.net,f=l.Class,d=l.ruta,p=l.mask,h=l.include,g=d.Collection,v=e.logger;var b,w,C,_,P="application/json",x="text/html",S="text/plain";!function(){b=function(e){return"string"==typeof e},w=function(e){return"function"==typeof e},C=function(e){return void 0!==e&&"object"==typeof e},_=Array.isArray}();var A,E,H;!function(){A=function(e,t,r){try{var n=JSON.stringify(t)}catch(i){return E(e,R("Json Serialization"))}H(e,n,200,P,r)},E=function(e,t,r){var n=JSON.stringify({error:t.toString(),stack:t.stack});H(e,n,t.statusCode||500,P,r)},H=function(e,t,r,n,i){if("string"!=typeof t&&t instanceof Buffer==0)return C(t)?void A(e,t,i):t instanceof Error?void E(e,t,i):void E(e,R("Unexpected content response"));if(e.setHeader("Content-Type",n||x),e.statusCode=r||200,null!=i)for(var o in i)e.setHeader(o,i[o]);e.end(t)}}();var j,$,F,k,R;!function(){function e(e,t,r){var n=m[e]=f({Base:j,Construct:function(){if(this instanceof n==0){var e=[null].concat(y.call(arguments));return new(n.bind.apply(n,e))}},statusCode:r,name:t});return n}m.HttpError=j=f({Construct:function(e,t){return this instanceof j==0?new j(e,t):(this.error_=new Error,this.message=e,void(null!=t&&(this.statusCode=t)))},name:"HttpError",statusCode:500,get stack(){for(var e=this.error_.stack.split("\n"),t=e.length,r=1,n=1,i=/\[as \w+Error\]/;++n<t&&!i.test(e[n]););return e.splice(1,n-r+1),e.join("\n")},toString:function(){return this.message?this.name+": "+this.message:this.name}}),F=e("RequestError","Bad Request",400),k=e("SecurityError","Forbidden",403),$=e("NotFoundError","Not Found",404),R=e("RuntimeError","Internal Server Error",500)}();var q=function(){function e(e,r,n,i,o){var s=e.get(r,n);if(null==s)return!1;var a=s.value.controller||s.value;if(null==a)return v.error("<routing> no controller",r),!1;if(w(a))return o(new a(s)),!0;if(b(a)){var l=c.Uri.combine(i,a);return t(l,s,o),!0}return w(a.process)?(o(a),!0):(v.error("<routing> invalid controller",a),!1)}function t(e,t,r){h.instance().js(e+"::Handler").done(function(n){return null==n.Handler?(v.error("<handler> invalid route",e),r(new o)):w(n.Handler.prototype.process)?(s.args.debug!==!0&&(t.value.controller=n.Handler),C(n.Handler)&&w(n.Handler.process)?r(n.Handler):void r(new n.Handler(t))):(v.error("<handler> invalid interface - process function not implemented"),r(new o))})}function r(e,t){if(47===e.charCodeAt(0))return e;if(-1!==e.indexOf("://"))return e;var r=t&&t.location;if(null==r)return v.error("<Handler> Path is relative but no location. Set handler: {location: X} in config").error(e,t),e;var n,i,o=e.split("/"),n=r.split(/[\{\}]/g);for(e=n[0],i=1;i<n.length;i++)if(i%2===0)e+=n[i];else{var s=n[i]<<0;if(s>o.length-1&&(s=o.length-1),e+=o[s],i===n.length-2)for(s++;s<o.length;s++)e+="/"+o[s]}return e}var n=["subapps","handlers","services","pages"],i=f({Construct:function(e){this.app=e;for(var t=n.length;--t>-1;)this[n[t]]=new g},registerPages:function(e){var t,r;for(r in e)t=e[r],null==t.controller?t.controller=m.HttpPage:b(t.controller)&&(t.controller=s.config.$getController(t)),this.pages.add(t.route,t);return this},registerHandlers:function(e,t){for(var r in e)this.registerHandler(r,e[r],t);return this},registerHandler:function(e,t,n){b(t)&&(t={controller:r(t,n)}),this.handlers.add(e,t)},registerSubApps:function(e,t){for(var r in e)this.registerSubApp(r,e[r],t);return this},registerSubApp:function(e,t){var r=e;"^"!==r[0]&&("/"!==r[0]&&(r="/"+r),r="^"+r),this.subapps.add(r,new m.HttpSubApplication(e,t))},registerServices:function(e,t){for(var r in e)this.registerService(r,e[r],t);return this},registerService:function(e,t,n){w(t)?t={controller:t}:b(t)&&(t={controller:t}),b(t.controller)&&(t.controller=r(t.controller,n)),this.services.add(e,t)},registerWebsockets:function(e){for(var t in e)this.registerWebsocket(t,e[t]);return this},registerWebsocket:function(e,t){return b(t)?void h.instance().js(t+"::Handler").done(function(t){D.registerHandler(e,t.Handler)}):void D.registerHandler(e,t)},get:function(t,r,i){var o=r.url,s=r.method,a=t.config.base;"POST"===s&&r.body&&r.body._method&&(s=r.body._method);for(var l,u=n.length,c=-1;++c<u;)if(l=n[c],e(this[l],o,s,a,i))return;i(null)},has:function(e,t){for(var r=n.length,i=-1;++i<r;)if(null!=this[n[i]].get(e,t))return!0;return!1}}),o=f({Base:f.Deferred,process:function(){return this.reject("Invalid Routing")}});return i}();m.IHttpHandler=f({Extends:f.Deferred,process:function(){this.reject("Not Implemented",500)}}),m.HttpPage=function(){function e(e,t,r){this.page=e,this.req=t,this.res=r,this._rewrite=null,this._redirect=null}function t(e){return null==e.Base?e.Base=l:null==e.Extends?e.Extends=l:Array.isArray(e)?e.Extends.push(l):e.Extends=[l,e.Extends],f(e)}function r(e){var t=e.ctx;return null==t.rewriteCount&&(t.rewriteCount=1),++t.rewriteCount>5?void e.reject("Too much rewrites, last path: "+t._rewrite):function(r){return null==r?void e.reject("Rewritten Path is not valid: "+t._rewrite):void r.process(t.req,t.res).done(e.resolveDelegate()).fail(e.rejectDelegate())}}function i(e,t){return function(r){H(e,r,t.statusCode||500,x)}}function o(e,t){return function(r){var n=C(r)?JSON.stringify(r):r;n+="\nError: "+t.message,H(e,"ErrorPage Failed: "+n,500,S)}}var a=function(){var e={getScripts:function(){return s.config.$getScripts(this.data.id)},getStyles:function(){return s.config.$getStyles(this.data.id)}};return e}();e.prototype={redirect:function(e,t){null==t&&(t=302),this.res.statusCode=t,this.res.setHeader("Location",e),this.res.setHeader("Content-Length","0"),this.res.end(),this._redirect=e},rewrite:function(e){this._rewrite=e}};var l=f({Extends:[f.Deferred,a],template:null,master:null,templatePath:null,masterPath:null,compoPath:null,route:null,model:null,send:null,Construct:function(e){if(this instanceof l==0)return t(e);var r=s.config;this.route=r.page.route;var n=e;if(!n||!n.value)return void v.error("<httppage> current route value is unedefined");var i=this.data=n.value;this.query=n.current&&n.current.params,i.masterPath&&(this.masterPath=i.masterPath+"::Master"),i.templatePath&&(this.templatePath=i.templatePath+"::Template"),i.master&&(this.masterPath=r.$getMaster(i)+"::Master"),i.template&&(this.templatePath=r.$getTemplate(i)+"::Template"),i.compo&&(this.compoPath=r.$getCompo(i)+"::Compo"),null==this.template&&null==this.compoPath&&null==this.templatePath&&(this.templatePath=r.$getTemplate(i)+"::Template"),null==this.master&&null==this.masterPath&&(this.masterPath=r.$getMaster(i)+"::Master")},process:function(t,r){if(this.route){var n=d.parse(this.route,t.url).params;for(var i in n)null==this.query[i]&&(this.query[i]=n[i])}if(this.ctx=new e(this,t,r),"secure"in this.data){var o=t.user,a=this.data.secure,l=a&&a.role;if(null==o||(l&&o.isInRole(l))===!1)return this.ctx.redirect(s.config.page.urls.login),this}return this._load(),this},sendError:function(e,t,r){var n,a=s.config.page,l=a.errors,u=a.error;t instanceof Error?n=t:b(t)?n=new j(t,r):C(t)&&(n=new j(JSON.stringify(t),r));var c=l&&l[n.statusCode]||u;return null==c?void o(e,n)("No Error Page in Configuration"):(this.masterPath=s.config.$getMaster(c)+"::Master",this.templatePath=c.template+"::Template",this.compoPath=null,this.model=n,void this.defer().done(i(e,n)).fail(o(e,n))._load())},_load:function(){this.resource=h.instance().load(this.masterPath,this.templatePath).js(this.compoPath).done(n(this._response,this))},_response:function(e){var t=e.load.Master||this.master,i=e.load.Template||this.template,o=e.Compo;if(null==t)return void this.reject(j("Page: Masterpage not found"));if(null==i&&null==o)return void this.reject(j("Page: Template not found"));if("master"===this.query.debug)return void this.resolve(t);if("template"===this.query.debug)return void this.resolve(i);this.query.breakOn&&(this.ctx.debug={breakOn:this.query.breakOn}),t&&p.render(p.parse(t)),null!=o&&(i&&null==o.template&&(o.template=i),null==o.mode&&(o.mode="server"),this.nodes=new p.Dom.Component("",null,o)),w(this.onRenderStart)&&this.onRenderStart(this.model,this.ctx);var a=p.render(this.nodes||i,this.model,this.ctx,null,this);return null!=this.ctx._rewrite?void s.handlers.get(this.ctx._rewrite,r(this)):this.ctx.async?void this.ctx.done(n(this._doResolve,this)).fail(n(this.fail,this)):void this._doResolve(a)},_doResolve:function(e){null==this.ctx._redirect&&this.resolve(e)}});return l}(),m.HttpService=function(){function e(e,t){if(null==t)return!0;var r=e.user,n=t.role;return null!=r&&(null==n||r.isInRole(n))}function t(){var e,t,o,s=r(y.call(arguments)),a=new d.Collection,l=s.ruta||s;for(e in l)o=l[e],t=null,w(o)&&(t={process:o}),null==t&&_(o)&&(t={process:new n(o)}),null==t&&C(o)&&(t=o),null!=t&&_(t.process)&&(t.process=new n(t.process)),null!=t&&w(t.process)!==!1?a.add(e,t):v.warn("<HttpService> `process` is not a function"+e+typeof t.process);return s.routes=a,null==s.Extends?s.Extends=i:Array.isArray(s.Extends)?s.Extends.push(i):s.Extends=[i,s.Extends],f(s)}function r(e){if(1===e.length)return e[0];for(var t,r,n=e[0],i=n.ruta||n,o=e.length,s=0;++s<o;){t=e[s],r=t.ruta||t;for(var a in r)null!=r[a]&&(i[a]=r[a]);if(null!=t.ruta)for(var a in t)"ruta"!==a&&null!=t[a]&&(n[a]=t[a])}return n}var n=function(){function e(e,n,i,o,s,a){if(!(a>=e.length)){var l,u=e[a];l=u.call(n,i,o,s,t(e,n,i,o,s,a)),l&&r(n,l)}}function t(t,n,i,o,s,a){return function(l){return l?r(n,l):void e(t,n,i,o,s,++a)}}function r(e,t){"string"==typeof t&&(t=j(t)),e.reject(t)}var n=f.Collection(Function,{Base:f.Serializable,process:function(t,r,n,i){e(this,t,r,n,i,0)}});return function(e){var t,r=new n(e);return function(e,n,i){t=this,r.process(t,e,n,i)}}}();!function(){function e(e,t){t.done(e.resolveDelegate()).fail(e.rejectDelegate())}m.HttpCrudEndpoints={Single:function(t,r){var n={},i=t,o=m.HttpService.classParser(t,r),s=m.HttpService.classPatchParser(t,r),a=f.properties(r);return n["$get /"+t+"/:id"]={meta:{response:a},process:function(t,n,i){e(this,r.fetch({_id:i.id}))}},n["$put /"+t+"/:id"]={meta:{description:"Update existed entity",arguments:a,response:a},process:[o,function(t){e(this,t[i].save())}]},n["$post /"+t]={meta:{description:"Create new entity",arguments:a,response:a},process:[o,function(t){e(this,t[i].save())}]},n["$delete /"+t+"/:id"]={meta:{description:"Remove entity"},process:function(t,n,i){var o=new r({_id:i.id}).del();e(this,o)}},n["$patch /"+t+"/:id"]={meta:{description:"Modify existed entity. `patch object` syntax is similar to MongoDB's"},process:[s,function(t,n,i){var o=t.body,s=new r({_id:i.id}).patch(o);e(this,s)}]},n},Collection:function(t,r){var n={},i=t,o=m.HttpService.collectionParser(i,r),s=f.properties(r.prototype._ctor);n["$get /"+t]={meta:{response:[s]},process:function(){e(this,r.fetch({}))}};var a={meta:{description:"Create or update(if _id is present) entries",arguments:[s]},process:[o,function(t){e(this,t[i].save())}]};return n["$put /"+t]=a,n["$post /"+t]=a,n["$delete /"+t]={meta:{arguments:[{_id:"string"}]},process:[function(e,t,n,o){if(Array.isArray(e.body)===!1)return void o("Invalid arguments. Array expected");for(var s=e.body.length,a=-1;++a<s;)if(!e.body[a]._id)return void o("`_id` property expected at "+a);e[i]=new r(e.body)},function(t){e(this,t[i].del())}]},n["$patch /"+t]={meta:{description:"<is not supported>"},process:function(){this.reject(HttError("`PATCH` is not supported for collections"))}},n}}}(),function(){function e(e,t,r){var n,i;for(i in e){if(void 0===t[i])return r("Unexpected property "+i),!1;if(n=typeof e[i],"undefined"!==n&&n!==t[i])return r("Type mismatch "+n+"/"+t[i]),!1}return!0}t.classParser=function(t,r){var n=f.properties(r);return function(i,o,s,a){return null==i.body?void a("Body is not defined"):void(e(i.body,n,a)&&(i[t]=new r(i.body),a(f.validate(i[t]))))}},t.collectionParser=function(t,r){var n=f.properties(r.prototype._ctor);return function(i,o,s,a){if(Array.isArray(i.body)===!1)return void a("Array expected");for(var l,u=i.body.length,c=-1;++c<u;)if(!e(i.body[c],n,a))return;for(i[t]=new r(i.body),c=-1;++c<u;)if(l=f.validate(i[t][c]),null!=l)return void a(l);a()}},t.classPatchParser=function(e,t){var r=f.properties(t);return function(e,t,n,i){if(null==e.body)return i("Body is not defined");var o=e.body.$set;if(o){var s,a,l;for(a in o){if(l=a.indexOf("."),-1!==l&&(a=a.substring(0,l)),void 0===r[a])return i("Unexpected property "+a);if(s=typeof e.body[a],"undefined"!==s&&s!==r[a])return i("Type mismatch "+s+"/"+r[a])}}i()}}}();var i=f({Extends:f.Deferred,secure:null,Construct:function(e){if(null!=e){for(var t=e.path,r=0,n=t.length,i=0;n>r&&"string"==typeof t[r];r++)i+=t[r].length+1;this.rootCharCount=i,"secure"in e.value&&(this.secure=e.value.secure||{})}},help:function(){for(var e,t,r,n=this.routes.routes,i=[],o=-1,s=n.length;++o<s;)e=n[o],t={method:e.method||"*",path:e.definition},r=e.value.meta,r&&(t.description=r.description,t.arguments=r.arguments,t.response=r.response),i.push(t);return i},process:function(t,r){var n=t.url.indexOf("?");if(-1!==n&&/\bhelp\b/.test(t.url.substring(n)))return void this.resolve(this.help());if(e(t,this.secure)===!1)return this.reject(k("Access Denied"));var i=t.url.substring(this.rootCharCount),o=this.routes.get(i,t.method);return null==o?this.reject($("Service method not Found: <"+t.method+"> "+i)):(o.value.process.call(this,t,r,o.current.params),this)}});return t.Barricade=n,t}();var D=function(){function t(e,t){return function(e){new t(e,r)}}var r,n={},i=function(){},o={listen:function(o){this.listen=i,v.log("Web socket opened".green.bold);var s=e.io;delete e.io,r=require("socket.io").listen(o,{"log level":2}),e.io=s;for(var a in n)r.of(a).on("connection",t(a,n[a]))},getHandler:function(e){return n[e]},registerHandler:function(e,i){n[e]=i,null!=r&&r.of(e).on("connection",t(e,i))}};return o}();!function(){function e(r,n,i,o,s,a){if(a>=r.length)return o(n,i);var l=r[a];return null==l?e(r,n,i,o,s,++a):void l(n,i,t(r,n,i,o,s,a),s)}function t(t,r,n,i,o,s){return function(a){a&&v.error("<app:middleware:nextDelegate>",a),e(t,r,n,i,o,++s)}}function n(e){return function(t,r,n){e.autoreloadEnabled&&T.watch(t.url);var i=e.middleware?l(e.middleware):d;c(e,t,r,n,i)}}function l(e){return function(t,r,n,i){e.process(n,i,function(){d(t,r,n,i)})}}function c(e,t,r,n,i){y(e,function(){e.handlers.get(e,t,function(o){return null==o?n():void i(e,o,t,r)})})}function d(e,t,r,n){v(95).log("<request>",r.url),t.process(r,n,e.config),null!=t.done&&t.done(function(e,r,i,o){var s=t.send||H;s(n,e,r,i,o)}).fail(function(e,r){var i=t.sendError||E;i(n,e,r||500)})}function g(e){return function(){var t=e.config;return v(90).log("<app.config>",t),e.handlers.registerSubApps(t.subapps,t.subapp).registerHandlers(t.handlers,t.handler).registerServices(t.services,t.service).registerPages(t.pages),e.args.debug?void e.resolve(e):void y(e,function(){y=w,e.resolve(e)})}}function y(e,t){return h.instance().js(e.config.env.server.scripts).js(e.config.env.both.scripts).done(t)}function w(e,t){t()}function C(e,t){H(t,j("Request not processed "+e.url,422))}var _=function(){function e(e){e=e||{};var n="configs"in e?e.configs:t,i=n?e.buildDirectory||r:null,s=e.config?{config:e.config}:null,f=e.base||u.env.currentDir.toString(),d=[{config:a},{config:{base:f}},n?{path:n}:null,i?{path:i,optional:!0}:null,{config:o},{config:l},s];return Array.isArray(e.sources)&&($source=d.concat(e.sources)),require("appcfg").fetch(d).done(function(){var e=this,t=e.mask;t.compos&&p.compoDefinitions(t.compos,t.utils,t.attributes),e.env.both.routes&&h.routes(e.env.both.routes),e.env.both.include&&h.cfg(e.env.both.include.cfg),e.env.server.include&&h.cfg(e.env.server.include.cfg),e.env.server.routes&&h.routes(e.env.server.routes),c.prepair(e.env.server.scripts),c.prepair(e.env.client.scripts);var r=e.pages;if(r){var n,i;for(i in r)n=r[i],null==n.id&&(n.id=i.replace(/[^\w_-]/g,"_").replace(/[_]{2,}/g,"_")),null==n.route&&(n.route=i),r[n.id]&&r[n.id]!==n&&v.error("<page:register> overwrite existed ID",i.bold,r[n.id]===n),r[n.id]=n,delete r[i]}})}var t="server/config/**.yml",r="public/build/stats.json",n=function(){return{format:function(e,t){if(47===t.charCodeAt(0))return t;var r,n,i=t.split("/"),r=e.split(/[\{\}]/g);for(t=r[0],n=1;n<r.length;n++)if(n%2===0)t+=r[n];else{var o=r[n]<<0;if(o>i.length-1&&(o=i.length-1),t+=i[o],n===r.length-2)for(o++;o<i.length;o++)t+="/"+i[o]}return t}}}(),o={$formatPath:n.format},l=function(){function e(e,r){return null==r?e:"string"==typeof r?(e.src=r,e):(r.src&&(e.src=r.src),r.cfg&&(e.cfg=t(e.cfg,r.cfg,"loader"),r.cfg.loader&&(e.cfg.loader=t(e.cfg.loader,r.cfg.loader))),r.routes&&t(e.routes,r.routes),e)}function t(e,t,r){if(null==t)return e;null==e&&(e={});for(var n in t)n!==r&&(e[n]=t[n]);return e}var r={$getScripts:f.Fn.memoize(function(e){var t=n("scripts",this.env).slice();return e&&(t=t.concat(this.$getScriptsForPageOnly(e))),t}),$getScriptsForPageOnly:f.Fn.memoize(function(e){var t=this.pages[e],r=[];if(null==t)return v.error("<page:scripts> Page not defined",e),null;if(t.scripts&&(r=r.concat(n("page",this.env,t.scripts,t.routes))),t.view&&t.view.controller){var i=this.$formatPath(this.page.location.viewController,t.view.controller);r.push(i)}return r}),$getStyles:function(e){var t=this,r=n("styles",t.env).slice();return e&&(r=r.concat(this.$getStylesForPageOnly(e))),r},$getStylesForPageOnly:function(e){var t=this,r=t.pages[e],i=[];if(null==r)return v.error("<page:styles> Page not defined",e),null;if(r.styles&&(i=i.concat(n("page",t.env,r.styles,r.routes))),r.compo){var o=this.$getCompo(r),s=h.getResource(o);null!=s?s.includes.forEach(function(e){"css"===e.resource.type&&i.push(e.resource.url)}):v.error("<page:styles> compo resource is undefined",o)}if(r.view&&r.view.style){var o=this.$formatPath(this.page.location.viewStyle,r.view.style);i.push(o)}return i},$getInclude:function(){var t=this.env,r={src:"",routes:{},cfg:{}};return e(r,t.both.include),e(r,t.client.include),r.src||console.error('[FATAL ERROR] Include PATH is not specified, use in client.yml/json include: { src: "PATH" }'),e(r,{routes:t.both.routes}),e(r,{routes:t.client.routes}),r},$getIncludeForPageOnly:function(t){var r=this.pages[t],n={};return r&&r.include?e(n,r.include):n},$getTemplate:function(e){var t=e.template||this.page.index.template;return this.$formatPath(this.page.location.template,t)},$getMaster:function(e){var t=e.master||this.page.index.master;return this.$formatPath(this.page.location.master,t)},$getController:function(e){var t=e.controller||this.page.index.controller;return t?this.$formatPath(this.page.location.controller,t):null},$getCompo:function(e){var t=e.compo,r=this.page.location.compo||this.page.location.controller;return t?this.$formatPath(r,t):null}},n=f.Fn.memoize(function(e,t,r,n){function i(e){if(null!=e)for(var t in e)s.register(t,e[t])}function o(e){null!=e&&s.each("js",e,function(e,t){a.push(t.path)})}var s=new includeLib.Routes,a=[];switch(i(t.client.routes),i(t.both.routes),e){case"page":i(n),o(r);break;case"debug":o(t.client.debug);break;default:o(t.client[e]),o(t.both[e])}return a});return r}(),c=function(){function e(o){if(null!=o)if(i(o)){for(var s,a=o,l=o.length,u=0;l>u;u++)if(s=a[u],null!=s&&"string"!=typeof s){var c=r(s);if(null!=c)if(n(c)){var f=t(a,u,c.value);l+=f,u+=f}else a.splice(u,1),u--,l--;else e(s)}}else if("object"==typeof o)for(var d in o)e(o[d])}function t(e,t,r){return i(r)?(Array.prototype.splice.apply(e,[t,1].concat(r)),r.length):(e.splice(t,1,r),1)}function r(e){for(var t in e)return"if#"!==t.substring(0,3)?null:{key:t.substring(3),value:e[t]};return null}function n(e){return s.args[e.key]}return{prepair:function(t){e(t)}}}();return e}(),P=f.Collection(Function,{Base:f.Serializable,process:function(t,r,n,i){e(this,t,r,n,i,0)}});m.HttpSubApplication=function(){return f({_app:null,_res:null,Construct:function(e,t){if("/"!==e[0]&&(e="/"+e),"/"!==e[e.length-1]&&(e+="/"),this._path=e,t instanceof m.Application)return void(this._app=t);var r=t.controller||t,n=this;if(b(r))return void(this._res=h.instance().js(r+"::App").done(function(e){e.App instanceof m.Application&&(e.App.done(function(){n.process=n.pipe}),n._app=e.App),n._res=null}));var i=t.configs,o=t.config;null==o&&null==i&&(i=e),this._app=new m.Application({configs:i,config:o}).done(function(){n.process=n.pipe})},process:function(e,t){var r=this;return this._res?void this._res.done(function(){r._res=null,r.process(e,t)}):this._app?void this._app.done(function(){r.pipe(e,t)}):(t.writeHead(500,{"Content-Type":"text/plain"}),void t.end("<Invalid Sub Application> "+this._path))},pipe:function(e,t){return e.url.length<this._path.length?(t.writeHead(301,{Location:this._path}),void t.end()):(e.url=e.url.replace(this._path,"/"),void this._app.process(e,t))}})}(),m.Application=f({Extends:f.Deferred,_responder:null,_responders:null,middleware:null,Construct:function(e){return null==e&&(e={}),this instanceof m.Application==0?new m.Application(e):(null==s&&(s=this),this.isRoot=this===s,this.handlers=new q(this),this.args=r(e.args,o()),this._baseConfig=e,this._loadConfig(),this.isRoot&&this.args.debug!==!0&&v.cfg("color","none"),this)},responder:function(e){return this.middleware=new P(e&&e.middleware),this._responder=n(this)},respond:function(e,t,r){null==this._responder&&this.responder(),this._responder(e,t,r)},responders:function(e){this._responders=new P(e)},process:function(e,t,r){this._responders.process(e,t,r||C,this.config)},webSockets:D,autoreload:function(e){return D.listen(e),T.enableForApp(this)},autoreloadEnabled:!1,getSubApp:function(e){var t=this.handlers.subapps.get(e);return t&&t.value&&t.value._app},Self:{_loadConfig:function(){var e=this._baseConfig;return this.config=_(e),this.config.done(g(this)).fail(function(e){v.warn("Configuration Error").error(e)}),this}}})}(),h.cfg({loader:{coffee:{process:function(e){return require("coffee").compile(e)}}}}),h.cfg({loader:{less:{process:function(e,t,r){var n=t.path_getFile(),i=t.path_getDir(),o=require("less"),s=new o.Parser({filename:n,paths:[i]});s.parse(e,function(e,t){var i;if(e)return void v.error("<less:parse>",n,e);try{i=t.toCSS()}catch(e){v.error("<less:toCss>",n,e)}r(i)})}}}}),h.cfg({loader:{yml:{process:function(e){var t=require("yamljs");e=e.replace(/\t/g,"  ");try{return t.parse(e)}catch(r){return v.error("<yml parser>",r),null}}}}}),h.cfg({loader:{jsnext:{process:function(e,t){var r=require("traceur"),n=new r.syntax.SourceFile(t.url,content),i=new r.util.ErrorReporter,o=r.codegeneration.Compiler.compileFile(i,n),s=r.outputgeneration.TreeWriter.write(o);return s}}}});var T=function(){function e(e){return function(r){e.defer()._loadConfig().done(function(){t.fileChanged(r)})}}var t,r=function(){var e=c.Uri.combine(process.cwd(),"/").replace(/\\/g,"/"),t=f({Base:f.EventEmitter,Construct:function(e){this.active=!1,this.file=new u.File(e)},Self:{fileChanged:function(e){v.log("<watcher:changed>",e),this.trigger("fileChange",e,"filewatcher")}},bind:function(e){this.on("fileChange",e),this.active||(u.watcher.watch(this.file.uri.toLocalFile(),this.fileChanged),this.active=!0)},unbind:function(e){this.off("fileChange",e),0===this._listeners.length&&u.watcher.unwatch(this.file.uri.toLocalFile())}}),r={};return new new f({Base:f.EventEmitter,watch:function(e){var n=e.uri.toLocalFile();if(null==r[n]){var i;i=new t(n),i.bind(this.fileChanged),r[n]=i}},unwatch:function(e){var t=e.uri.toLocalFile();return null==r[t]?void v.log("<watcher> No watchers",t):(r[t].unbind(callback),void delete r[t])},isWatching:function(e){var t=e.uri.toLocalFile();return null!=r[t]},Self:{fileChanged:function(t,r){return"filewatcher"===r?(t="/"+t.replace(e,""),void(null==h.getResource(t)&&this.trigger("fileChange",t))):void this.trigger("fileChange",t)}},bind:function(e){return this.on("fileChange",e)},unbind:function(e){return this.off("fileChange",e)}})}(),n=f({Construct:function(e){v.log("<autoreload> Socket connected"),this.socket=e,e.on("disconnect",this.disconnected),r.bind(this.fileChanged)},Self:{fileChanged:function(e){v.log("<autoreload> path",e),this.socket.emit("filechange",e)},disconnected:function(){r.unbind(this.fileChanged)}}}),i=new c.Uri(process.cwd()+"/");return t={watch:function(e){var t="/"===e[0]?1:0,n=e.indexOf("?"),o=-1===n?e.length:n;e=e.substring(t,o);var s=i.combine(e),a=new u.File(s);a.uri.file&&(r.isWatching(a)||a.exists()!==!1&&r.watch(a))},unwatch:function(e){r.unwatch(new u.File(e))},fileChanged:function(e,t){r.fileChanged(e,t)},isWatching:function(e){return"string"==typeof e&&(e=new u.File(e)),r.isWatching(e)},listenDirectory:function(e,t){new u.Directory(e).watch(t)},enableForApp:function(t){D.registerHandler("/browser",n),t.autoreloadEnabled=!0;var r=new u.Directory("server/config/");return r.exists()&&r.watch(e(t)),h.cfg("autoreload",this),this},getWatcher:function(){return r}}}();return a=[{env:{server:{routes:{server:"/server/{0}.js",server_lib:"/server/lib/{0}.js",server_compo:"/server/compo/{0}/{1}.js",atma_server:"/node_modules/atma-server/lib/{0}.js"},scripts:{atma_server:["compos/scripts/scripts","compos/styles/styles"]}}},handler:{location:"/server/http/handler/{0}.js"},handlers:null,mask:{compos:{":scripts":{mode:"server:all"},":styles":{mode:"server:all"},":template":{mode:"server"},"layout:master":{mode:"server"},"layout:view":{mode:"server"},":animation":{mode:"client"}},attributes:null},page:{location:{controller:"/server/http/page/{0}/{1}.js",template:"/server/http/page/{0}/{1}.mask",master:"/server/http/master/{0}.mask",viewTemplate:"/public/view/{0}/{1}.mask",viewController:"/public/view/{0}/{1}.js",viewStyle:"/public/view/{0}/{1}.less"},extension:{javascript:"js",style:"less",template:"mask"},index:{template:"index",master:"default"},urls:{login:"/login"}},pages:{"/":{id:"index",title:"Default Title"}},service:{location:"/server/http/service/{0}.js"},services:null,view:{location:{template:"/public/view/{0}/{1}.mask",controller:"/public/view/{0}/{1}.js",style:"/public/view/{0}/{1}.less"}}}][0],null!=t.atma&&"object"==typeof t.atma?void r(t.atma,m):void(t.atma={server:m})});