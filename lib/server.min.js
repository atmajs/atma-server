(function(e,n){"use strict";var t,r;"undefined"==typeof exports||e!==exports&&null!=e&&e!==global||(t=r=global),null==t&&(t="undefined"==typeof window?global:window),null==r&&(r=e||t),n(t,r)})(this,function(e,n){"use strict";function t(e,n){if(null==e&&(e={}),null==n)return e;for(var t in n)e[t]=n[t];return e}function r(e,n){return function(){return e.apply(n,arguments)}}function i(e){return Array.isArray(e)}function o(){for(var e,n=process.argv,t=n.length,r=2,i={args:[]};t>r;r++)if(e=n[r],"-"!==e[0]){var o=e.indexOf("=");-1===o?i.args.push(e):i[e.substring(0,o)]=e.substring(o+1)}else i[e.replace(/^[\-]+/,"")]=!0;return i}var s,l,a,u,c={};e.include&&e.net&&e.net.Uri&&(l=e),null==l&&e.atma&&(l=e.atma),null==l&&(require("atma-libs/globals-dev"),l=e),e.logger&&(u=e.logger),null==u&&(require("atma-logger"),u=e.logger),e.io&&e.io.File&&(a=e.io),null==a&&(require("atma-io"),a=e.io);var f=l.net,h=l.Class,g=l.ruta,d=l.mask,v=l.include,p=g.Collection,u=e.logger,m=function(){function e(e,n){for(var t,r=e.handlers,i=0,o=r.length;o>i;i++)if(t=r[i],t.matcher.test(n))return t.handler;return null}function n(e,n){var t=e.services,r=t.get(n);return r}function t(e,n){if(47===e.charCodeAt(0))return e;var t=n&&n.location;if(null==t)return console.error("[Handler] Path is relative but no location. Set handler: {location: X} in config"),e;var r,i,o=e.split("/"),r=t.split(/[\{\}]/g);for(e=r[0],i=1;r.length>i;i++)if(0===i%2)e+=r[i];else{var s=r[i]<<0;if(s>o.length-1&&(s=o.length-1),e+=o[s],i===r.length-2)for(s++;o.length>s;s++)e+="/"+o[s]}return e}function r(e,n){return RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n)}return h({Construct:function(){this.handlers=[],this.services=new p,this.pages=new p},registerPages:function(e){var n,t;for(t in e)n=e[t],this.pages.add(n.path,n);return this},registerHandlers:function(e,n){for(var i in e)this.handlers.push({matcher:r(i),handler:t(e[i],n)});return this},registerServices:function(e,n){for(var r in e)this.services.add(r,t(e[r],n));return this},get:function(t,r){if(null!=r){var i=e(this,t);if(i)return"string"==typeof i?(v.instance().js(i+"::Handler").done(function(e){r(new e.Handler)}),void 0):(r(i),void 0);var o=n(this,t);if(o){var l=o.value;return"string"==typeof l?(v.instance().js(l+"::Service").done(function(e){r(new e.Service)}),void 0):(r(l),void 0)}var o=this.pages.get(t);if(o){var a=o.value,u=o.current.params,f=s.config.page.getController(a);return null==f?(r(new c.HttpPage(a,u)),void 0):(v.instance().js(f+"::Controller").done(function(e){r(new e.Controller(a,u))}),void 0)}r(null)}}})}();c.IHttpHandler=h({Extends:h.Deferred,process:function(){this.reject("Not Implemented",500)}}),c.HttpPage=function(){function e(e){for(var n=e;n.Base;)n=n.Base;return n.Base=i,h(e)}function n(e){var n=e.ctx;return null==n.rewriteCount&&(n.rewriteCount=1),++n.rewriteCount>5?(e.reject("Too much rewrites, last path: "+n.rewrite),void 0):function(t){return null==t?(e.reject("Rewritten Path is not valid",n.rewrite),void 0):(t.process(n.req,n.res).done(r(e.resolve,e)).fail(r(e.reject,e)),void 0)}}var t=function(){var e={getScripts:function(){return s.config.page.getScripts(this.data.id)},getStyles:function(){return s.config.page.getStyles(this.data.id)}};return e}(),i=h({Extends:[h.Deferred,t],template:null,master:null,route:null,Construct:function(n,t){if(this instanceof i==!1)return e(n);var r=s.config.page;this.template=r.getTemplate(n)+"::Template",this.master=r.getMaster(n)+"::Master",this.data=n,this.query=t},process:function(e,n){return this.ctx={req:e,res:n,page:this},this.load(),this},load:function(){v.instance().load(this.master,this.template).done(r(this.response,this))},response:function(e){var t=e.load.Master,i=e.load.Template;if("master"===this.query.debug)return this.resolve(t),void 0;if("template"===this.query.debug)return this.resolve(i),void 0;this.query.breakOn&&(this.ctx.debug={breakOn:this.query.breakOn}),t&&d.render(d.parse(t)),this.onRenderStart&&this.onRenderStart(this.ctx.req,this.ctx.res);var o=d.render(this.nodes||i,this.model,this.ctx);return this.ctx.rewrite?(s.handlers.get(this.ctx.rewrite,n(this)),void 0):this.ctx.async?(this.ctx.done(r(this.resolve,this)).fail(r(this.fail,this)),void 0):(this.resolve(o),void 0)}});return i}(),c.HttpService=function(){var e={Extends:h.Deferred,process:function(e,n){var t=e.url,r=this.routes.get(t);if(null==r)return this.reject("Service Endpoint not Found: "+t,404),this;var i=r.value;return i.call(this,e,n),this}};return function(n){var t,r,i=new g.Collection;for(t in n)r=t[0],("/"===r||"!"===r)&&i.add(t,n[t]);n.routes=i;for(t in e)n[t]=e[t];return h(n)}}(),function(){function n(e){return function(n,t,r){v.instance().js(e.config.env.server.scripts).js(e.config.env.both.scripts).done(function(){e.handlers.get(n.url,function(i){return e.autoreloadEnabled&&w.watch(n.url),null==i?(r(),void 0):(u(95).log("<request>",n.url),i.process(n,t).done(function(e,n,r,i){if(n&&(t.statusCode=n),"string"==typeof r&&t.setHeader("Content-Type",r),i)for(var o in i)t.setHeader(o,i[o]);t.end(e)}).fail(function(e,n){t.statusCode=n,t.end(e)}),void 0)})})}}function t(e){return function(){var n=e.config;u(90).log("<app.config>",n),e.handlers.registerHandlers(n.handlers,n.handler).registerServices(n.services,n.service).registerPages(n.pages),e.resolve(e)}}var r=function(){function n(e,n){var r={env:{client:{routes:null,scripts:null,styles:null},server:{routes:null,scripts:null},both:{routes:null,scripts:null}},page:{location:null,include:null},pages:null,handler:{location:null},handlers:null,service:{location:null},services:null,passport:{},app:{},build:{}};return t(r,e,n)}function t(e,n,t){return Array.isArray(n)===!1?(t("[Application.Config] should be an array of file names"),e):(n=n.map(function(e){return"/server/config/"+e+".yml::"+e.replace(/\//g,".")}),n.push("/public/build/stats.json::build"),v.instance().load(n).done(r(e,t)),e)}function r(e,n){function t(e,n,r){if(null!=r&&-1!==r.indexOf(".")){for(var i=r.split("."),o=i.length-1,s=0;o>s;s++)e=e[i[s]]||(e[i[s]]={});t(e,n)}else for(var l in n)e[l]=n[l]}return function(r){var i,s,a=r.load;for(i in a)s=a[i],null!=s&&t(e,s,i);e["compos-info"]&&d.compoDefinitions(e["compos-info"]),e.env.both.routes&&v.routes(e.env.both.routes),e.env.both.include&&v.cfg(e.env.both.include.cfg),e.env.server.include&&v.cfg(e.env.server.include.cfg),e.env.server.routes&&v.routes(e.env.server.routes),o.prepairIncludes(e.env.server.scripts),o.prepairIncludes(e.env.client.scripts);var u=e.pages;if(u){var c,f;for(c in u)f=u[c],f.path=c,null==f.id&&(f.id=c.substring(c.indexOf("/")+1)),""===f.id&&(f.id=f.view||"index"),null==f.view&&(f.view=f.id);for(c in u)f=u[c],u[f.id]=f,delete u[c]}l(e),n()}}var o=function(){function e(n,t){if(null!=n)for(var r in t)"object"!=typeof t[r]?"function"!=typeof t[r]||(n[r]=t[r]):e(n[r],t[r])}var n,t=function(){return{format:function(e,n){if(47===n.charCodeAt(0))return n;var t,r,i=n.split("/"),t=e.split(/[\{\}]/g);for(n=t[0],r=1;t.length>r;r++)if(0===r%2)n+=t[r];else{var o=t[r]<<0;if(o>i.length-1&&(o=i.length-1),n+=i[o],r===t.length-2)for(o++;i.length>o;o++)n+="/"+i[o]}return n}}}(),r=function(){function e(e,t){return null==t?e:"string"==typeof t?(e.src=t,e):(t.src&&(e.src=t.src),t.cfg&&(e.cfg=n(e.cfg,t.cfg,"loader"),t.cfg.loader&&(e.cfg.loader=n(e.cfg.loader,t.cfg.loader))),t.routes&&n(e.routes,t.routes),e)}function n(e,n,t){if(null==n)return e;null==e&&(e={});for(var r in n)r!==t&&(e[r]=n[r]);return e}var t={getScripts:h.Fn.memoize(function(e){var n=s.config,t=r("scripts",n.env).slice();return e&&(t=t.concat(this.getScriptsForPageOnly(e))),t}),getScriptsForPageOnly:h.Fn.memoize(function(e){var n=s.config,t=n.pages[e],i=[];if(null==t)return u.error("<page:scripts> Page not defined",e),null;if(t.scripts&&(i=i.concat(r("page",n.env,t.scripts,t.routes))),t.view&&t.view.controller){var o=n.formatPath(this.location.viewController,t.view.controller);i.push(o)}return i}),getStyles:function(e){var n=s.config,t=r("styles",n.env).slice();return e&&(t=t.concat(this.getStylesForPageOnly(e))),t},getStylesForPageOnly:function(e){var n=s.config,t=n.pages[e],i=[];if(null==t)return u.error("<page:styles> Page not defined",e),null;if(t.styles&&(i=i.concat(r("page",n.env,t.styles,t.routes))),t.view&&t.view.style){var o=n.formatPath(this.location.viewStyle,t.view.style);i.push(o)}return i},getInclude:function(){var n=s.config.env,t={src:"",routes:{},cfg:{}};return e(t,n.both.include),e(t,n.client.include),t.src||console.error('[FATAL ERROR] Include PATH is not specified, use in client.yml/json include: { src: "PATH" }'),e(t,{routes:n.both.routes}),e(t,{routes:n.client.routes}),t},getIncludeForPageOnly:function(n){var t=s.config.pages[n],r={};return t&&t.include?e(r,t.include):r},getTemplate:function(e){var n=e.template||e.id||this.index.template;return s.config.formatPath(this.location.template,n)},getMaster:function(e){var n=e.master||this.index.master;return s.config.formatPath(this.location.master,n)},getController:function(e){var n=e.controller||this.index.controller;return n?s.config.formatPath(this.location.controller,n):null}},r=h.Fn.memoize(function(e,n,t,r){function i(e){if(null!=e)for(var n in e)s.register(n,e[n])}function o(e){null!=e&&s.each("js",e,function(e,n){l.push(n.path)})}var s=new includeLib.Routes,l=[];switch(i(n.client.routes),i(n.both.routes),e){case"page":i(r),o(t);break;case"debug":o(n.client.debug);break;default:o(n.client[e]),o(n.both[e])}return l});return t}(),o=function(){function e(o){if(null!=o)if(i(o)){for(var s,l=o,a=o.length,u=0;a>u;u++)if(s=l[u],null!=s&&"string"!=typeof s){var c=t(s);if(null!=c)if(r(c)){var f=n(l,u,c.value);a+=f,u+=f}else l.splice(u,1),u--,a--;else e(s)}}else if("object"==typeof o)for(var h in o)e(o[h])}function n(e,n,t){return i(t)?(Array.prototype.splice.apply(e,[n,1].concat(t)),t.length):(e.splice(n,1,t),1)}function t(e){for(var n in e)return"if#"!==n.substring(0,3)?null:{key:n.substring(3),value:e[n]};return null}function r(e){return s.args[e.key]}return{prepair:function(n){e(n)}}}(),l={page:r,formatPath:t.format};return{attach:function(t){n=t,e(t,l)},prepairIncludes:o.prepair}}(),l=o.attach;return n.getList=function(n){if(null==e.io||null==a.Directory)return console.error("atma-io seems to be not loaded"),null;var t=a.env.currentDir.combine(n),r=new a.Directory(t).readFiles("**.yml").files.map(function(e){return e.uri.toRelativeString(t).replace(".yml","")});return r},n}();c.Application=h({Extends:h.Deferred,Construct:function(e){if(null==e&&(e={}),this instanceof c.Application==!1)return new c.Application(e);s=this,this.handlers=new m;var n=e.configs||"server/config/",i=e.configs;return null==i&&(i=r.getList(n)),this.config=r(i,t(this)),this.args=o(),this.args.debug!==!0&&u.cfg("color","none"),this},responder:function(){return n(this)},autoreload:function(e){this.autoreloadEnabled=!0,w.listen(e),v.cfg("autoreload",w)},autoreloadEnabled:!1})}(),v.cfg({loader:{coffee:{process:function(e){return require("coffee").compile(e)}}}}),v.cfg({loader:{less:{process:function(e,n,t){var r=n.path_getFile(),i=n.path_getDir(),o=require("less"),s=new o.Parser({filename:r,paths:[i]});s.parse(e,function(e,n){var i;if(e)return u.error("<less:parse>",r,e),void 0;try{i=n.toCSS()}catch(e){u.error("<less:toCss>",r,e)}t(i)})}}}}),v.cfg({loader:{yml:{process:function(e){var n=require("yamljs");e=e.replace(/\t/g,"  ");try{return n.parse(e)}catch(t){return u.error("<yml parser>",t),null}}}}});var w=function(){var n={},t=function(){var e=f.Uri.combine(process.cwd(),"/").replace(/\\/g,"/"),n=h({Base:h.EventEmitter,Construct:function(e){this.active=!1,this.file=new a.File(e)},Self:{fileChanged:function(e){u.log("<watcher:changed>",e),this.trigger("fileChange",e,"filewatcher")}},bind:function(e){this.on("fileChange",e),this.active||(a.File.watcher.watch(this.file,this.fileChanged),this.active=!0)},unbind:function(e){this.off("fileChange",e),0===this._listeners.length&&a.File.watcher.unwatch(this.file.uri.toLocalFile())}}),t={};return new new h({Base:h.EventEmitter,watch:function(e){var r=e.uri.toLocalFile();if(null==t[r]){var i;i=new n(r),i.bind(this.fileChanged),t[r]=i}},unwatch:function(e){var n=e.uri.toLocalFile();return null==t[n]?(u.log("<watcher> No watchers",n),void 0):(t[n].unbind(callback),delete t[n],void 0)},isWatching:function(e){var n=e.uri.toLocalFile();return null!=t[n]},Self:{fileChanged:function(n,t){if(n=n.replace(e,""),"filewatcher"!==t||!v.getResource(n)){var r=this;v.bin_tryReload(n,function(){r.trigger("fileChange",n)})}}},bind:function(e){return this.on("fileChange",e),this},unbind:function(e){return this.off("fileChange",e),this}})}();n["/browser"]=h({Construct:function(e){u.log("<socket> Connected"),this.socket=e,e.on("disconnect",this.disconnected),t.bind(this.fileChanged)},Self:{fileChanged:function(e){u.log("<autoreload> path",e),this.socket.emit("filechange",e)},disconnected:function(){t.unbind(this.fileChanged)}}});var r={listen:function(t){function r(e,n){return function(e){new n(e,o)}}u.log("<Autoreload> Socket opened".green.bold);var i=e.io;delete e.io;var o=require("socket.io").listen(t,{"log level":0});e.io=i;for(var s in n)o.of(s).on("connection",r(s,n[s]))},getConnectionHandler:function(e){return n[e]}},i=new f.Uri(process.cwd()+"/");return{watch:function(e){var n="/"===e[0]?1:0,r=e.indexOf("?"),o=-1===r?e.length:r;e=e.substring(n,o);var s=i.combine(e),l=new a.File(s);l.uri.file&&(t.isWatching(l)||l.exists()!==!1&&t.watch(l))},unwatch:function(e){t.unwatch(new a.File(e))},listen:function(e){r.listen(e)},fileChanged:function(e){t.fileChanged(e)},isWatching:function(e){return"string"==typeof e&&(e=new a.File(e)),t.isWatching(e)}}}();return null!=n.atma&&"object"==typeof n.atma?(t(n.atma,c),void 0):(n.atma={server:c},void 0)});