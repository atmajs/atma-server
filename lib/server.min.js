!function(t,e){"use strict";e(global,global),module.exports=global.atma.server}(0,function(t,e){"use strict";function n(t){return Array.isArray(t)}function r(){for(var t,e=process.argv,n=e.length,r=2,i={args:[]};r<n;r++)if(t=e[r],"-"!==t[0]){var s=t.indexOf("=");-1===s?i.args.push(t):i[t.substring(0,s)]=t.substring(s+1)}else i[t.replace(/^[\-]+/,"")]=!0;return i}function i(t){i=function(){};var e=t.config.$is("debug"),n="/public/build/";!function(){var r,i;!function(){function t(t){var e=t.data&&t.data.id;return null==e&&m.error("<page-resources> PageData and the ID is not defined"),e}function s(t,e){if(null==e.build)return m.error("<Application is not built>").warn("To execute the DEV version use `--debug` flag: `node index --debug`".bold).warn("To build the application run `atma custom node_modules/atma-server/tools/build`"),null;var n=e.build[t];return null==n?(m.error("<page-resources> No page info",t,"Build could be faily"),null):n}function o(t,e){return t=a(n,t),e.buildVersion&&(t+="?v="+e.buildVersion),t}i=function(n,r,i){var a=t(n);if(e)return!0!==i?r.$getStyles(a):r.$getStylesForPageOnly(a);var u=!0!==i?[o("styles.css",r)]:[],l=s(a,r);return null==l?u:(l.styles&&u.push(o(a+"/styles.css",r)),u)},r=function(r,i,u,l){var c=t(r),f={scripts:[],templates:"",include:{src:"",cfg:null,routes:null},mask:i.env.client.mask,buildVersion:i.buildVersion};if(e){var h=i.$getInclude();return h&&(f.include=h),f.scripts=!0!==u?i.$getScripts(c):i.$getScriptsForPageOnly(c),l&&l(f),f}var d=i.static||i.base,v=[];!0!==u&&(f.scripts.push(o("scripts.js",i)),v.push(a(d,n,"load.html::App")));var g=s(c,i);return null!=g&&(!0===g.load&&v.push(a(d,g,c,"load.html::Page")),g.scripts&&f.scripts.push(o(c+"/scripts.js",i))),p.instance().load(v).done(function(t){f.templates=(t.load.App||"")+(t.load.Page||""),l&&l(f)}),f};var a=F.combine}();var s=h({meta:{mode:"server:all"},nodes:c.parse("each (.) > link type='text/css' rel='stylesheet' href='~[.]';"),cache:e?{byProperty:"ctx.page.id"}:null,renderStart:function(t,e){this.model=i(e.page,e.config,!1)}});s.getModel=i,c.registerHandler("atma:styles",s),function(){var e=h({template:["\t\tif (templates) {\n\n\t\t\t:html > '~[templates]'\n\n\t\t}\n\n\t\t\n\n\t\teach(scripts){\n\n\t\t\tscript type='text/javascript' src='~[.]';\n\n\t\t}\n\n\t\t\n\n\t\tscript {\t\n\n\t\t\tinclude.allDone(function(){\n\n\t\t\t\twindow.app = Compo.bootstrap(document.body);\n\n\t\t\t});\n\n\t\t}"][0],mode:"server:all",cache:{byProperty:"ctx.page.id"},onRenderStart:function(t,e){var n=h.pause(this,e),i=this;r(e.page,e.config,!1,function(t){i.model=t,n()})}});e.getModel=r;var n=h({template:["\t\tscript type='text/javascript' src='~[include.src]';\n\n\t\tif (mask.src) {\n\n\t\t\tscript type='text/javascript' src='~[mask.src]';\n\n\t\t}\n\n\t\tscript type='text/javascript' > <:html>\n\n\t\t\twindow.DEBUG = true;\n\n\t\t\n\n\t\t\tinclude\n\n\t\t\t\t.cfg(~[include.config])\n\n\t\t\t\t.routes(~[include.routes])\n\n\t\t\t\t.js(~[scripts])\n\n\t\t\n\n\t\t\t\t~[imports || '']\n\n\t\t\n\n\t\t\t\t.done(function(){\n\n\t\t\t\t\twindow.app =  mask.Compo.bootstrap(document.body);\n\n\t\t\t\t});\n\n\t\t</:html>"][0],meta:{mode:"server"},onRenderStart:function(t,e){t=r(e.page,e.config);var n,i=e.config.$getImports("client");i.length&&(n=i.map(function(t){return"script"===t.type?".js('"+t.path+"')":"style"===t.type?".css('"+t.path+"')":"mask"===t.type?".mask('"+t.path+"')":void 0}).join("\n")),this.model={include:{src:t.include.src,routes:JSON.stringify(t.include.routes,null,4),config:JSON.stringify(t.include.cfg,null,4),maskSrc:t.mask.src},scripts:t.scripts.map(function(t){return"'"+t+"'"}).join(",\n"),imports:n,mask:t.mask}}});n.getModel=r;var i=t.config.$is("debug")?n:e;c.registerHandler("atma:scripts",i)}()}()}var s,o,a,u,l,c,f,h,p,d,v,g,m,b={};!function(){var e;!function(){function t(t,r,i,s){e[t]=!0===n?i||"/lib/"+r+".js":s||"/lib/"+r+".min.js"}e={},t("atma-io","io"),t("maskjs","mask"),t("includejs","include"),t("atma-class","class"),t("atma-logger","","/lib/logger-dev.js","/lib/logger.js");var n=!1}(),m=require("atma-logger"),a=t.io&&t.io.File?t.io:require("atma-io"),u=t.Class||require("atma-class"),l=t.ruta||require("ruta"),c=t.mask||require("maskjs"),f=c.jmask,h=c.Compo,v=l.Collection,g=m("atma-server"),null==t.include&&require("includejs"),p=t.include,d=t.includeLib}();var y,w,P,C,x;!function(){y=function(t){return"string"==typeof t},w=function(t){return"function"==typeof t},P=function(t){return void 0!==t&&"object"==typeof t},C=Array.isArray,x=function(){var t;return function(){return m.warn("@obsolete: is_Debug for app_isDebug"),null==t&&(t=Boolean(s.args.debug||s.config.debug)),t}}()}();var j,_,S;!function(){j=function(t,e){if(null==t&&(t={}),null==e)return t;for(var n in e)t[n]=e[n];return t},_=function(t,e){if(null==t&&(t={}),null==e)return t;for(var n in e)null==t[n]&&(t[n]=e[n]);return t},S=function(t,e,n){for(var r,i=e.split("."),s=i.length-1,o=-1;++o<s;)r=i[o],null==t[r]&&(t[r]={}),t=t[r];r=i[s],Object.defineProperty(t,r,{enumerable:!0,configurable:!0,get:function(){var e=n();return Object.defineProperty(t,r,{enumerable:!0,writable:!0,value:e}),e},set:function(e){Object.defineProperty(t,r,{enumerable:!0,writable:!0,value:e})}})}}();var k,E;!function(){k=function(t,e){return function(){return t.apply(e,arguments)}},E=function(t){var e=B.call(arguments,1);return function(){t.apply(null,e.concat(B.call(arguments)))}}}();var $,A,H;!function(){function t(){n="file://"+A(process.cwd()+"/")}function e(t){return"/"===t[0]||/^[A-Za-z]:[\/\\]/.test(t)}$=function(t){return/^(file|https?):/.test(t)},A=function(t){return t.replace(/\\/g,"/").replace(/([^:\/])\/{2,}/g,"$1/")},H=function(r,i){return r=A(r),$(r)?r:("."===r[0]&&"/"===r[1]&&(r=r.substring(2)),e(r)?"file://"+r:(null==n&&t(),F.combine(i||n,r)))};var n}();var O;!function(){O=function(){if(null==s)return!1;var t=Boolean(s.args.debug||s.config.debug);if(!0!==t){var e=process.env.NODE_ENV||process.env.ENV;e&&(t=/^(test|debug)$/i.test(e))}return O=function(){return t},t}}();var D,T,q;!function(){D=function(t,e,n,r){var i;try{i=JSON.stringify(e)}catch(e){return T(t,G("Json Serialization"))}q(t,i,n||200,M,r)},T=function(t,e,n){e instanceof W==!1&&(e=W.create(e)),q(t,JSON.stringify(e),e.statusCode||500,M,n)},q=function(t,e,n,r,i){if("string"!=typeof e&&e instanceof Buffer==!1)return P(e)?void D(t,e,n,i):e instanceof Error?void T(t,e,i):void T(t,G("Unexpected content response"));if(t.setHeader("Content-Type",r||I),t.statusCode=n||200,null!=i)for(var s in i)t.setHeader(s,i[s]);t.end(e)}}(),RegExp.prototype.toJSON=RegExp.prototype.toString;var F;!function(){function t(t){return t&&"object"==typeof t&&"function"==typeof t.combine}function e(){for(var t,e="",n=0,r=arguments.length;n<r;n++)(t=arguments[n])&&(e?("/"!==e[e.length-1]&&(e+="/"),e+="/"===t[0]?t.substring(1):t):e=t);return e}function n(t){return"/"===t[t.length-1]?t.substring(0,t.length-1):t}function r(t){var e,n=new F;for(e in t)"string"==typeof t[e]&&(n[e]=t[e]);return n}function i(t){return t.replace(/\\/g,"/").replace(/^\.\//,"").replace(/^(\w+):\/([^\/])/,"/$1:/$2")}function s(t){return p.test(t)&&"/"===t[0]?t.substring(1):t}function o(t){var e=f.exec(t.value);null==e&&"/"===t.value[0]&&(t.protocol="file"),null!=e&&(t.protocol=e[1],t.value=t.value.substring(e[0].length))}function a(t){if(null!=t.protocol){if("file"===t.protocol){var e=p.exec(t.value);return void(e&&(t.host=e[1],t.value=t.value.substring(t.host.length)))}var n=t.value.indexOf("/",2);t.host=~n?t.value.substring(0,n):t.value,t.value=t.value.replace(t.host,"")}}function u(t){var e=t.value.indexOf("?");-1!==e&&(t.search=t.value.substring(e),t.value=t.value.substring(0,e))}function l(t){var e=d.exec(t.value),r=null==e?null:e[1];null!=r&&(t.file=r,t.value=t.value.substring(0,t.value.length-r.length),t.value=n(t.value),e=h.exec(r),t.extension=null==e?null:e[1])}F=c.class.create({protocol:null,value:null,path:null,file:null,extension:null,constructor:function(e){return null==e?this:t(e)?e.combine(""):(e=i(e),this.value=e,o(this),a(this),u(this),l(this),this.path=n(this.value),/^[\w]+:\//.test(this.path)&&(this.path="/"+this.path),this)},cdUp:function(){var t=this.path;return null==t||""===t||"/"===t?this:/^\/?[a-zA-Z]+:\/?$/.test(t)?this:(this.path=t.replace(/\/?[^\/]+\/?$/i,""),this)},combine:function(i){if(t(i)&&(i=i.toString()),!i)return r(this);if(p.test(i))return new F(i);var s=r(this);if(s.value=i,u(s),l(s),!s.value)return s;if(i=s.value.replace(/^\.\//i,""),"/"===i[0])return s.path=i,s;for(;/^(\.\.\/?)/gi.test(i);)s.cdUp(),i=i.substring(3);return s.path=n(e(s.path,i)),s},toString:function(){var t=this.protocol?this.protocol+"://":"",n=e(this.host,this.path,this.file)+(this.search||""),r=t+n;return this.file||this.search||(r+="/"),r},toPathAndQuery:function(){return e(this.path,this.file)+(this.search||"")},toRelativeString:function(t){if("string"==typeof t&&(t=new F(t)),0===this.path.indexOf(t.path)){var n=this.path?this.path.replace(t.path,""):"";return"/"===n[0]&&(n=n.substring(1)),e(n,this.file)+(this.search||"")}for(var r=this.path.split("/"),i=t.path.split("/"),s="",o=0,a=Math.min(r.length,i.length);o<a&&r[o]===i[o];o++);if(o>0&&(s=r.splice(0,o).join("/")),s){for(var u,l="",c=t.path;c;){if(0===this.path.indexOf(c)){u=this.path.replace(c,"");break}c=c.replace(/\/?[^\/]+\/?$/i,""),l+="../"}return e(l,u,this.file)}return this.toString()},toLocalFile:function(){return s(e(this.host,this.path,this.file))},toLocalDir:function(){return s(e(this.host,this.path,"/"))},toDir:function(){return(this.protocol?this.protocol+"://":"")+e(this.host,this.path,"/")},isRelative:function(){return!(this.protocol||this.host)},getName:function(){return this.file.replace("."+this.extension,"")}});var f=/^([a-zA-Z]+):\/\//,h=/\.([\w\d]+)$/i,p=/(^\/?\w{1}:)(\/|$)/,d=/([^\/]+(\.[\w\d]+)?)$/i;F.combinePathes=e,F.combine=e}();var R;!function(){function t(t,n,i,s,o){null==i.route&&(i.route=n),null==i.id&&(i.id=n),e(i,r(i.pattern||o.pattern)).forEach(function(e){t[e.route]=e})}function e(t,r,i){if(0===r.length)return[t];var s=r.shift(),o=t[s];if(null==o)return[t];var a=[];for(var u in o){var l=n(t,u,o[u],i,s),c=e(l,r.slice(),s);c&&(a=a.concat(c))}return a}function n(t,e,n,r,i){var s=Object.create(t),o=e;"/"!==o[0]&&(o=t.route+"/"+o),s[i]=n.view,s.route=s.id=o;for(var a in n)"view"!==a&&"route"!==a&&"id"!==a&&(s[a]=n[a]);return s}function r(t){return t.split("/").filter(function(t){return""!==t}).map(function(t){return t.replace(":","")}).slice(1)}R=function(e,n){var r,i,s={};for(r in e)i=e[r],t(s,r,i,e,n);return s}}();var M,I,N,B=Array.prototype.slice,U=new F("file://"+__dirname+"/");!function(){var t=";charset=utf-8";M="application/json"+t,I="text/html"+t,N="text/plain"+t}();var L;!function(){function t(n,r,i,s,o,a){if(a>=n.arr.length)return s(null,r,i);var u=n.arr[a];if(null==u)return t(n,r,i,s,o,++a);u(r,i,e(n,r,i,s,o,a),o)}function e(e,n,r,i,s,o){return function(a){if(a)return m.debug("<app:middleware:nextDelegate>".red,a),void i(a,n,r);t(e,n,r,i,s,++o)}}L=u({Construct:function(t){this.arr=t},process:function(e,n,r,i){t(this,e,n,r,i,0)},add:function(t){return null==t?this:"function"==typeof t?(this.arr.push(t),this):C(t)?(this.arr=this.arr.concat(t),this):this},Static:{create:function(t){return null==t?null:new L(t)}}})}();var W,z,J,V,G;!function(){function t(t,e){var n=b[t]=u({Base:W,Construct:function(){if(this instanceof n==!1){var t=[null].concat(B.call(arguments));return new(n.bind.apply(n,t))}},statusCode:e,name:t});return n}b.HttpError=W=u({Base:Error,_error:null,_json:null,Construct:function(t,e){if(this instanceof W==!1)return new W(t,e);this._error=Error(t),this.message=String(t),null!=e&&(this.statusCode=e)},name:"HttpError",statusCode:500,get stack(){if(null!=this._error){for(var t=this._error.stack.split("\n"),e=t.length,n=1,r=1,i=/\[as \w+Error\]/;++r<e&&!i.test(t[r]););return t.splice(1,r-n+1),t.join("\n")}},toString:function(){return this.message?this.name+": "+this.message:this.name},toJSON:function(){return null!=this._json?this._json:{name:this.name,error:this.message,code:this.statusCode}},Static:{create:function(t,n){if(y(t))return W(t,n);if(null!=t._error)return t;if(t instanceof Error){var r=W(t.message,n||500);return r._error=t,r}if(P(t)){if(t.toString!==e)return W(t.toString(),n||t.statusCode||t.status);var r,i=t.message,s=n||t.statusCode||t.status;return r=W(i,s),r._json=t,r}return G("Invalid error object: "+t)}}}),J=t("RequestError",400),V=t("SecurityError",403),z=t("NotFoundError",404),G=t("RuntimeError",500);var e=Object.prototype.toString}();var Z=function(){function e(t,e,r,i,s,o){var a=e.get(r,i);if(null==a)return!1;var u=a.value.controller||a.value;if(null==u)return m.error("<routing> no controller",r),!1;if(w(u))return o(new u(a,t.app)),!0;if(y(u)){return n(t,$(u)?u:F.combine(s,u),a,o),!0}return w(u.process)?(o(u),!0):(m.error("<routing> invalid controller",u),!1)}function n(t,e,n,r){if(i(e))return void o(t,e,n,r);t.app.resources.js(e+"::Handler").done(function(i){var s=i.Handler;return null==s?(m.error("<handler> invalid route",e),void r(new f("Invalid route: "+e))):w(s.prototype.process)?(!1===O()&&(n.value.controller=s),P(s)&&w(s.process)?void r(s):void r(new s(n,t.app))):(m.error("<handler> invalid interface - process function not implemented"),void r(new f("Invalid interface")))})}function r(t,e){if(47===t.charCodeAt(0))return t;if(-1!==t.indexOf("://"))return t;var n=e&&e.location;if(null==n)return m.error("<Handler> Path is relative but no location. Set handler: {location: X} in config").error(t,e),t;var r,i,s=t.split("/"),r=n.split(/[\{\}]/g);for(t=r[0],i=1;i<r.length;i++)if(i%2==0)t+=r[i];else{var o=r[i]<<0;if(o>s.length-1&&(o=s.length-1),t+=s[o],i===r.length-2)for(o++;o<s.length;o++)t+="/"+s[o]}return t}var i,o,a=["subapps","handlers","services","pages"],l=u({Construct:function(t){this.app=t;for(var e=a.length;--e>-1;)this[a[e]]=new v},registerPages:function(t,e){var n,r,i=R(t,e);for(n in i)r=i[n],null==r.controller?r.controller=b.HttpPage:y(r.controller)&&(r.controller=this.app.config.$getController(r)),this.pages.add(r.route,r);return this},registerHandlers:function(t,e){for(var n in t)this.registerHandler(n,t[n],e);return this},registerHandler:function(t,e,n){y(e)&&(e={controller:r(e,n)}),this.handlers.add(t,e)},registerSubApps:function(t,e){for(var n in t)this.registerSubApp(n,t[n],e);return this},registerSubApp:function(t,e,n){var r=t;"^"!==r[0]&&("/"!==r[0]&&(r="/"+r),r="^"+r),this.subapps.add(r,new b.HttpSubApplication(t,e,this.app))},registerServices:function(t,e){for(var n in t)this.registerService(n,t[n],e);return this},registerService:function(t,e,n){w(e)?e={controller:e}:y(e)&&(e={controller:e}),y(e.controller)&&(e.controller=r(e.controller,n)),this.services.add(t,e)},registerWebsockets:function(t){for(var e in t)this.registerWebsocket(e,t[e]);return this},registerWebsocket:function(t,e,n){var i=this.app.webSockets;if(y(e)){r(e,n);return void p.instance().js(e+"::Handler").done(function(e){i.registerHandler(t,e.Handler)})}i.registerHandler(t,e)},get:function(t,n,r){var i=n.url,o=n.method,u=t.config.base;"POST"===o&&n.body&&n.body._method&&(o=n.body._method);for(var l,c=a.length,f=-1;++f<c;)if(l=a[f],e(this,this[l],i,o,u,r))return;if(this.app!==s){var h=s.handlers,p=s.config;if(e(h,h.handlers,i,o,p.base||u,r))return}r(null)},has:function(t,e){for(var n=a.length,r=-1;++r<n;)if(null!=this[a[r]].get(t,e))return!0;return!1},Static:{Handlers:{}}});!function(){function e(e){switch(e.toLowerCase()){case"self":return l.Handlers;case"global":return t}return null}var n=/\/\{(self|global)\}.?/;i=function(t){return n.test(t)},o=function(t,r,i,s){var o=n.exec(r),a=(o[0],o[1]),u=r.substring(o.index+o[0].length),l=e(a),h=c.obj.get(l,u);return null==h?(m.error("<handler> invalid route",r),void s(new f("Invalid route: "+r))):P(h)?void s(h):void s(new h(i,t.app))}}();var f=u({Base:u.Deferred,process:function(){return this.reject("Invalid Routing")}});return l}();b.IHttpHandler=u({Extends:u.Deferred,process:function(t,e){this.reject("Not Implemented",500)}}),b.HttpPage=function(){function t(t,e,n,r){this.config=e,this.page=t,this.req=n,this.res=r,this._rewrite=null,this._redirect=null}var e,n,r,i,o,a,h,d,v,g;!function(){e=function(t){return t.middleware&&(t.middleware=new L(t.middleware)),null==t.Base?t.Base=x:null==t.Extends?t.Extends=x:Array.isArray(t)?t.Extends.push(x):t.Extends=[x,t.Extends],u(t)},n=function(t){var e=t.ctx;return null==e.rewriteCount&&(e.rewriteCount=1),++e.rewriteCount>5?void t.reject("Too much rewrites, last path: "+e._rewrite):function(n){if(null==n)return void t.reject("Rewritten Path is not valid: "+e._rewrite);n.process(e.req,e.res,e.config).done(t.resolveDelegate()).fail(t.rejectDelegate())}},i=function(t,e,n,i){return function(s){if(s)return void t.reject(s);r(t,e,n,i)}},r=function(e,r,i,o){if(e.pattern){var a=l.parse(e.pattern,r.url).params;for(var u in a)null==e.query[u]&&(e.query[u]=a[u])}if(e.ctx=new t(e,o,r,i),"redirect"in e.data)return e.ctx.redirect(e.data.redirect),e;if("rewrite"in e.data)return r.url=e.data.rewrite,e.app.handlers.get(e.app,r,n(e)),e;if("secure"in e.data){var c=r.user,f=e.data.secure,h=f&&f.role;if(null==c||!1===(h&&c.isInRole(h)))return e.ctx.redirect(s.config.page.urls.login),e}return e._load()},o=function(t,e){null==t.ctx._redirect&&t.resolve(e)},a=function(t,e){if(null==t||""===t)return null;var n=t.indexOf("::");return-1!==n&&(t=t.slice(0,-n)),t+"::"+e},h=function(t,e,r){c.renderAsync(e,t.model,t.ctx,null,t).done(function(e){if(null!=t.ctx._rewrite)return void s.handlers.get(t.ctx._rewrite,n(t));r(e)}).fail(t.rejectDelegate())},function(){function t(t,e,n){for(var r,i=[],s=n.split(";"),o=s.length,a=-1;++a<o;)""!==(n=s[a])&&(r=f(e).find(n),null!=r?i.push(r):m.warn("<HttpPage.partial> Not found `%s`",s[a]));return i}function e(t,e,i){null==n&&(n=c.getHandler("atma:scripts")),null==r&&(r=c.getHandler("atma:styles"));var s=r.getModel(t,e,!0);n.getModel(t,e,!0,function(t){i({scripts:t.scripts,styles:s})})}d=function(n,r,i){r=t(n,r,i),e(n,n.ctx.config,function(t){if(t.templates){var e=f(":html").text(t.templates);r.push(e)}h(n,r,function(e){var r={type:"partial",html:e,scripts:t.scripts,styles:t.styles};o(n,r,"application/json",200)})})};var n,r}(),v=function(t,e){return function(n){q(t,n,e.statusCode||500,I)}},g=function(t,e){return function(n){var r=P(n)?JSON.stringify(n):n;r+="\nError: "+e.message,q(t,"ErrorPage Failed: "+r,500,N)}}}();var y=function(){return{getScripts:function(t){return t.$getScripts(this.data.id)},getStyles:function(t){return t.$getStyles(this.data.id)}}}();t.prototype={redirect:function(t,e){null==e&&(e=302),this.res.statusCode=e,this.res.setHeader("Location",t),this.res.setHeader("Content-Length","0"),this.res.end(),this._redirect=t},rewrite:function(t){this._rewrite=t}};var C=b.HttpErrorPage=u({Extends:[u.Deferred,y],template:null,master:null,ctx:null,templatePath:null,masterPath:null,route:null,query:null,model:null,Construct:function(t,e,n){this._setPageData(e,n),this.model=t},_setPageData:function(t,e){this.data=t,null!=t.masterPath&&(this.masterPath=t.masterPath),null!=t.templatePath&&(this.templatePath=t.templatePath),t.master&&(this.masterPath=e.$getMaster(t)),t.template&&(this.templatePath=e.$getTemplate(t)),t.compo&&(this.compoPath=e.$getCompo(t)),null==this.template&&null==this.compoPath&&null==this.templatePath&&(this.templatePath=e.$getTemplate(t)),null==this.master&&null==this.masterPath&&(this.masterPath=e.$getMaster(t))},Static:{send:function(t,e,n,r){var i=r.page,s=i.errors,o=i.error,a=s&&s[t.statusCode]||o;return null==a&&(a={masterPath:"",templatePath:U.combine("../pages/error/error.mask").toString()}),new C(t,a,r).process(e,n,r)}},process:function(t,e,n){this.done(v(e,this.model)).fail(g(e,this.model)),r(this,t,e,n)},_load:function(){return this.resource=p.instance().load(a(this.masterPath,"Master"),a(this.templatePath,"Template")).js(a(this.compoPath,"Compo")).done(k(this._response,this)),this},_response:function(t){var e=t.load.Master||this.master,n=t.load.Template||this.template,r=this.nodes||n;return null==e&&""!==this.masterPath?void this.reject(W("Page: Masterpage not found")):null==r?void this.reject(W("Page: Template not found")):(e&&c.render(c.parse(e)),void h(this,r,E(o,this)))}}),x=u({Extends:[u.Deferred,y],template:null,master:null,app:null,ctx:null,middleware:null,templatePath:null,masterPath:null,compoPath:null,route:null,query:null,model:null,send:null,data:{id:null},Construct:function(t,n){if(this instanceof x==!1)return e(t);if(null==t)return this;var r=t;if(null==r.value)return m.error("<HttpPage> Route value is undefined"),this;var i=n.config,s=r.value;return this.app=n,this.route=i.page.route,this.query=r.current&&r.current.params,this._setPageData(s,i),this},_setPageData:function(t,e){this.data=t,null!=t.masterPath&&(this.masterPath=t.masterPath),null!=t.templatePath&&(this.templatePath=t.templatePath),t.master&&(this.masterPath=e.$getMaster(t)),t.template&&(this.templatePath=e.$getTemplate(t)),t.compo&&(this.compoPath=e.$getCompo(t)),null==this.template&&null==this.compoPath&&null==this.templatePath&&(this.templatePath=e.$getTemplate(t))},process:function(t,e,n){return null==this.middleware?r(this,t,e,n):(this.middleware.process(t,e,i(this,t,e,n),n),this)},sendError:function(t,e,n,r){C.send(t,e,n,r)},_load:function(){var t,e,n=this.data.env;null!=n&&(e=n.both,t=n.server);var r=this.ctx.config.base,i=this.app.resources;return this.resource=p.instance(r,i).setBase(r).load(a(this.masterPath,"Master"),a(this.templatePath,"Template")).js(a(this.compoPath,"Compo")).js(e).js(t).done(k(this._response,this)),this},_response:function(t){var e=t.load.Master||this.master,n=t.load.Template||this.template,r=t.Compo;if(null==e&&this.masterPath)return void this.reject(W("Page: Masterpage not found"));if(null==n&&null==r)return void this.reject(W("Page: Template not found"));if("master"===this.query.debug)return void this.resolve(e);if("template"===this.query.debug)return void this.resolve(n);this.query.breakOn&&(this.ctx.debug={breakOn:this.query.breakOn}),e&&c.render(c.parse(e)),null!=r&&(n&&null==r.template&&(r.template=n),null==r.mode&&(r.mode="server"),this.nodes=new c.Dom.Component("",null,r)),w(this.onRenderStart)&&this.onRenderStart(this.model,this.ctx);var i=this.nodes||n;if(this.query.partial)return void d(this,i,this.query.partial);h(this,i,E(o,this))}});return x}(),b.HttpService=function(){function t(t){var n,r;"string"==typeof t?(n=t,r=B.call(arguments,1)):r=B.call(arguments);var o,a,c,f=e(r),h=new l.Collection,p=f.ruta||f;for(o in p)c=p[o],a=null,w(c)&&(a={process:c}),null==a&&C(c)&&(a={process:new i(c)}),null==a&&P(c)&&(a=c),null!=a&&C(a.process)&&(a.process=new i(a.process)),null!=a&&!1!==w(a.process)?h.add(o,a):m.warn("<HttpService> `process` is not a function"+o+typeof a.process);return f.routes=h,null!=n&&(f.name=n),null==f.Extends?f.Extends=s:Array.isArray(f.Extends)?f.Extends.push(s):f.Extends=[s,f.Extends],u(f)}function e(t){if(1===t.length)return t[0];for(var e,n,r=t[0],i=r.ruta||r,s=t.length,o=0;++o<s;){e=t[o],n=e.ruta||e;for(var a in n)null!=n[a]&&(i[a]=n[a]);if(null!=e.ruta)for(var a in e)"ruta"!==a&&null!=e[a]&&(r[a]=e[a])}return r}var n,r;!function(){n=function(t,e){if(null==e)return!0;if(!0===e||null==e.role)return null!=t.session||null!=t.user;var n=t.user,r=e.role;return null!=n&&(null==r||n.isInRole(r))},r=function(t,e,n){return null==t?"Message Body is not defined":u.validate(t,e,n)}}();var i=function(){function t(t,r,i,s,o,a){if(!(a>=t.length)){var u,l=t[a];u=l.call(r,i,s,o,e(t,r,i,s,o,a)),u&&n(r,u)}}function e(e,r,i,s,o,a){return function(u){if(u)return n(r,u);t(e,r,i,s,o,++a)}}function n(t,e){"string"==typeof e&&(e=W(e)),t.reject(e)}var r=u.Collection(Function,{Base:u.Serializable,process:function(e,n,r,i){t(this,e,n,r,i,0)}});return function(t){var e,n=new r(t);return function(t,r,i){e=this,n.process(e,t,r,i)}}}();!function(){function t(t,e){e.done(t.resolveDelegate()).fail(t.rejectDelegate())}b.HttpCrudEndpoints={Single:function(e,n){var r={},i=e,s=b.HttpService.classParser(e,n),o=b.HttpService.classPatchParser(e,n),a=u.properties(n);return Object.keys(a).forEach(function(t){a["?"+t]=a[t],delete a[t]}),r["$get /"+e+"/:id"]={meta:{response:a},process:function(e,r,i){t(this,n.fetch({_id:i.id}))}},r["$put /"+e+"/:id"]={meta:{description:"Update existed entity",arguments:a,response:a},process:[s,function(e,n,r){var i=e[a];i._id=r.id,t(this,i.save())}]},r["$post /"+e]={meta:{description:"Create new entity",arguments:a,response:a},process:[s,function(e){var n=e[i];delete n._id,t(this,n.save())}]},r["$delete /"+e+"/:id"]={meta:{description:"Remove entity"},process:function(e,r,i){t(this,new n({_id:i.id}).del())}},r["$patch /"+e+"/:id"]={meta:{description:"Modify existed entity. `patch object` syntax is similar to MongoDB's"},process:[o,function(e,r,i){var s=e.body;t(this,new n({_id:i.id}).patch(s))}]},r},Collection:function(e,n){var r={},i=e,s=b.HttpService.collectionParser(i,n),o=u.properties(n.prototype._ctor);r["$get /"+e]={meta:{response:[o]},process:function(){t(this,n.fetch({}))}};var a={meta:{description:"Create or update(if _id is present) entries",arguments:[o]},process:[s,function(e){t(this,e[i].save())}]};return r["$put /"+e]=a,r["$post /"+e]=a,r["$delete /"+e]={meta:{arguments:[{_id:"string"}]},process:[function(t,e,r,s){if(!1===Array.isArray(t.body))return void s("Invalid arguments. Array expected");for(var o=t.body.length,a=-1;++a<o;)if(!t.body[a]._id)return void s("`_id` property expected at "+a);t[i]=new n(t.body)},function(e){t(this,e[i].del())}]},r["$patch /"+e]={meta:{description:"<is not supported>"},process:function(){this.reject(W("`PATCH` is not supported for collections"))}},r}}}(),function(){function e(t,e){var n,r;for(r in t){if(void 0===e[r])return"Unexpected property "+r;if("undefined"!==(n=typeof t[r])&&n!==e[r])return"Type mismatch "+n+"/"+e[r]}return null}var n="<service> Model deserialization: ";t.classParser=function(t,r){var i=u.properties(r);return function(s,o,a,l){if(null==s.body)return void l("Body is not defined");var c=e(s.body,i);if(null!=c)return void l(n+c);s[t]=new r(s.body),c=u.validate(s[t]),null!=c&&(c=n+c),l(c)}},t.collectionParser=function(t,r){var i=u.properties(r.prototype._ctor);return function(s,o,a,l){if(!1===Array.isArray(s.body))return void l("Array expected");for(var c,c,f=s.body.length,h=-1;++h<f;)if(null!=(c=e(s.body[h],i)))return void l(n+c);for(s[t]=new r(s.body),h=-1;++h<f;)if(null!=(c=u.validate(s[t][h])))return void l(n+c);l()}},t.classPatchParser=function(t,e){var n=u.properties(e);return function(t,e,r,i){if(null==t.body)return i("Body is not defined");var s=t.body.$set;if(s){var o,a,u;for(a in s){if(u=a.indexOf("."),-1!==u&&(a=a.substring(0,u)),void 0===n[a])return i("Unexpected property "+a);if("undefined"!==(o=typeof t.body[a])&&o!==n[a])return i("Type mismatch "+o+"/"+n[a])}}i()}}}();var s=u({Extends:u.Deferred,secure:null,Construct:function(t){if(null!=t){for(var e=t.path,n=0,r=e.length,i=0;n<r&&"string"==typeof e[n];n++)i+=e[n].length+1;this.rootCharCount=i,"secure"in t.value&&(this.secure=t.value.secure||{})}},help:function(){for(var t,e,n,r=this.routes.routes,i=[],s=-1,o=r.length;++s<o;)t=r[s],e={method:t.method||"*",path:t.definition},n=t.value.meta,n&&(e.description=n.description,e.arguments=n.arguments,e.response=n.response,"secure"in t.value&&(e.secure=t.value.secure||!0)),i.push(e);return i},process:function(t,e){var i=t.url.indexOf("?");if(-1!==i&&/\bhelp\b/.test(t.url.substring(i)))return this.resolve(this.help());if(!1===n(t,this.secure))return this.reject(V("Access Denied"));var s=t.url.substring(this.rootCharCount),o=this.routes.get(s,t.method);if(null==o&&"OPTIONS"===t.method){var a=this.getOptions(s,t,e);if(a)return e.writeHead(200,a),void e.end()}if(null==o){var u=this.name||"<service>",l=s||"/";return this.reject(z(u+": endpoint not Found: <"+t.method+"> "+l))}var c=o.value,f=c.meta,h=f&&f.arguments;if(null!=f&&!1===n(t,f.secure))return this.reject(V("Access Denied"));if(null!=h){var p="GET"===t.method,d=!1===p&&f.strict,v=p?o.current.params:t.body,g=r(v,h,d);if(g)return this.reject(J(g))}return c.process.call(this,t,e,o.current.params),this},getOptions:function(){var t=["GET","POST","PUT","PATCH","HEAD","DELETE"];return function(e,n,r){for(var i=null,s=[],o=t.length;--o>-1;){var a=t[o],u=this.routes.get(e,a);null!=u&&(s.push(a),u.meta&&u.meta.headers&&(i=j(i,u.meta.headers)))}if(0===s.length)return null;this.meta&&this.meta.headers&&(i=j(i,this.meta.headers));var l=s.join(",");return i.Allow=l,i["Access-Control-Allow-Methods"]=l,void 0===i["Content-Type"]&&(i["Content-Type"]="application/json;charset=utf-8"),i}}()});return t.Barricade=i,t}();var Q;!function(){function t(){}Q=function(n){var s,o={};return{listen:function(n){this.listen=t,m.log("Web socket opened".green.bold),s=e(n,o)},hasHandlers:function(){return 0!==Object.keys(o).length},getHandler:function(t){return o[t]},registerHandler:function(t,e){if(o[t]=e,null==s)return void(null!=n&&n._server&&this.listen(n._server));r(s,t,e)},clients:function(t){if(null==s)return[];var e=s.of(t),n=[];for(var r in e.connected)n.push(e.connected[r]);return n},of:function(t){return null==s?null:s.of(t)},emit:function(t){var e=B.call(arguments,1),n=e[e.length-1];if(null==s)return console.error("Emitting to the websockets (%s), but server is not started",t),void(n&&n({message:"Server is not started"}));if(null==o[t])return console.error("No handlers are bound to the namespace",t),void(n&&n({message:"No handlers"}));if("function"==typeof n)return e.pop(),void i(this.clients(t),e,n);var r=s.of(t);r.emit.apply(r,e)}}};var e,n,r,i;!function(){e=function(t,e){var n=require("socket.io")(t,{"log level":2});for(var i in e)r(n,i,e[i]);return n},r=function(t,e,r){t.of(e).on("connection",n(t,e,r))},n=function(t,e,n){return function(e){new n(e,t)}},i=function(t,e,n){function r(t){s.push(t),--i<1&&n(null,s)}var i=t.length,s=[];if(0===i)return void n(null,s);var o,a=-1;for(e.push(r);++a<i;)o=t[a],o.emit.apply(o,e)}}()}(),function(){function t(t){return function(e,n,r){X.enabled&&X.watch(e.url,t.config);var i=null!=t._innerPipe?l(t._innerPipe):h;null==r&&(r=t._404),f(t,e,n,r,i)}}function e(t,e,n){f(t,e,n,function(){n.writeHead(500),n.end("Not Found")},g)}function l(t){return function(e,n,r,i){function s(t){if(t)return void T(i,t);h(e,n,r,i)}t.process(r,i,s,e.config)}}function f(t,e,n,r,i){t.handlers.get(t,e,function(s){if(null==s)return void r();x(t,function(){i(t,s,e,n)})})}function h(t,e,n,r){if(m(95).log("<request>",n.url),e.process(n,r,t.config),null!=e.done){var i=v(t,e);e.done(function(t,n,s,o){var a=e.send||q;null!=i&&(o=_(o,i)),a(r,t,n,s,o)}).fail(function(s,o){if(s=W.create(s,o),e.sendError)return void e.sendError(s,n,r,t.config);T(r,s,i)})}}function v(t,e){var n=e.meta&&e.meta.headers,r=t.config.headers;if(null==n&&null==r)return null;var i;return i=n?Object.create(n):null,i=_(i,r)}function g(t,e,n,r){if(e instanceof b.HttpSubApplication)return void e.execute(n,r);e.process(n,r,t.config),null!=e.done&&e.pipe(r)}function P(t){return function(){k.trigger("configurate",t),i(t);var e=t.config;t.handlers.registerPages(e.pages,e.page).registerSubApps(e.subapps,e.subapp).registerHandlers(e.handlers,e.handler).registerServices(e.services,e.service).registerWebsockets(e.websockets,e.websocket),O()&&p.cfg("autoreload",!0),x(t,function(){t.resolve(t)})}}function x(t,e){if(!0!==O()&&null!=t.resources)return void e();var n=t.config,r=n.base,i=n.env;t.resources=p.instance(r).setBase(r).js(i.server.scripts).js(i.both.scripts),n.$getImports("server").forEach(function(e){return"script"===e.type?void t.resources.js(e.path):"mask"===e.type?void t.resources.mask(e.path):void 0}),t.resources.done(function(r){t.lib=r;var i=n.projects;if(i)for(var s in i){var o=r[s];null!=o&&"function"==typeof o.attach&&o.attach(t)}e()})}var S,k=new u.EventEmitter;!function(){var t,e="server/config/**.yml",r="public/build/stats.json";!function(){t={format:function(t,e){if(47===e.charCodeAt(0))return!1===/\.\w{1,7}$/.test(e)&&(e+=".mask"),e;var n,r,i=e.split("/"),n=t.split(/[\{\}]/g);for(e=n[0],r=1;r<n.length;r++)if(r%2==0)e+=n[r];else{var s=n[r]<<0;if(s>i.length-1&&(s=i.length-1),e+=i[s],r===n.length-2)for(s++;s<i.length;s++)e+="/"+i[s]}return e}}}();var i,l,f,h,v,g,b,w={$formatPath:t.format};!function(){i=function(t,e,n){function r(e){return"string"!=typeof e?{config:e}:{path:$(e)?e:F.combine(t,e)}}return null==e&&void 0!==e?null:void 0===e?[r(n)]:"string"==typeof e?[r(e)]:e.map(r)},l=function(t){var e=p.instance(t.base);t.env.both.routes&&e.routes(t.env.both.routes),t.env.both.include&&e.cfg(t.env.both.include.cfg),t.env.server.include&&e.cfg(t.env.server.include.cfg),t.env.server.routes&&e.routes(t.env.server.routes),x.prepair(t.env.server.scripts),x.prepair(t.env.client.scripts)},f=function(t){var e=t.mask;null!=e&&c.compoDefinitions(e.compos,e.utils,e.attributes)},h=function(t){var e=t.pages;if(null!=e){var n,r;for(r in e)n=e[r],null==n.id&&(n.id=r),null==n.route&&(n.route=r)}},v=function(t,e){var n=t.page.location.pageFiles,r=t.$get("base");return console.log(n),a.Directory.readFilesAsync(F.combine(r,n)).then(function(t){console.log("DIR",t)})},g=function(t,e){if(null==t.plugins)return null;if(!1===e.isRoot)return null;var n=new u.Await,r=t.plugins.map(function(e){for(var n,r=new F(t.base),i="node_modules/"+e+"/index.js";;){if(n=r.combine(i),a.File.exists(n)){i=n.toString();break}if(r=r.combine("../"),""===r.path||"/"===r.path)break}return i+"::"+e});return p.instance(t.base).js(r).done(function(t){for(var r in t)t[r]&&"function"==typeof t[r].attach&&t[r].attach(e);n.resolve()}),n},function(){function t(t,n){return new u.Await(e(t,n,"scripts"),e(t,n,"styles"))}function e(t,e,r){return new u.Await(n(t,e,r,"client"),n(t,e,r,"server"),n(t,e,r,"both"))}function n(t,e,n,i){var s=t.env[i],o=s[n],a=o&&o[e];if(null==a)return null;var l=new u.Deferred;return r(t,n,e,a,function(t){for(var n,r=o[e],i=r.length,s=-1;++s<i;)n=t[r[s]],y(n)?r[s]=n:C(n)?(r.splice.apply(r,[s,1].concat(n)),s+=n.length-1,i+=n.length-1):m.error("Module path mapping is not defined",r[s]);l.resolve()}),l}function r(t,e,n,r,l){var h=new F(t.base),p={},d=c[n];if(null==d)throw Error("Support:"+Object.keys(c)+" Got:"+n);var v=new u.Await,g=d.dir,b=d.package;r.forEach(function(t){if(null!=t){var n=t,r=t.indexOf("::"),u="";if(-1!==r&&(u=t.substring(r),t=t.substring(0,r)),-1!==t.indexOf("/"))return!1===/\.\w+$/.test(t)&&(t+="."+f[e]),void(p[n]="/"+g+"/"+t+u);var l=o(h,g+"/"+t+"/"+b);if(null==l&&(d.alternate&&(l=o(h,g+"/"+t+"/"+d.alternate)),null==l))return void m.error("<Module is not resolved>",t);a.File.readAsync(l).done(function(r){var o="/"+g+"/"+t+"/",a=r.main;return null==a&&(a="index.js"),y(a)?void s(p,n,a,o,u):C(a)?void i(p,n,a,o,u,e):void m.error("Main is not defined",l)}).fail(m.error).always(v.delegate(t,!1))}}),v.always(function(){l(p)})}function i(t,e,n,r,i,s){for(var o,a=n.length,u=-1,c=[];++u<a;)o=l(n[u]),h[o]===s&&c.push(r+n[u]+i);t[e]=c}function s(t,e,n,r,i){t[e]=r+n+i}function o(t,e){for(var n;;){if(n=t.combine(e),a.File.exists(n)){e=n.toString();break}if(t=t.combine("../"),""===t.path||"/"===t.path)return null}return e}function l(t){var e=t.lastIndexOf(".");return-1===e?"":t.substring(e+1)}b=function(e,n){return new u.Await(t(e,"npm"),t(e,"bower"))};var c={bower:{dir:"bower_components",package:"bower.json",alternate:"component.json"},npm:{dir:"node_modules",package:"package.json"}},f={scripts:"js",styles:"css"},h={js:"scripts",css:"styles"}}()}();var P=function(){function t(t,n){return null==n?t:"string"==typeof n?(t.src=n,t):(n.src&&(t.src=n.src),n.cfg&&(t.cfg=e(t.cfg,n.cfg,"loader"),n.cfg.loader&&(t.cfg.loader=e(t.cfg.loader,n.cfg.loader))),n.routes&&e(t.routes,n.routes),t)}function e(t,e,n){if(null==e)return t;null==t&&(t={});for(var r in e)r!==n&&(t[r]=e[r]);return t}var n,r={$getScripts:u.Fn.memoize(function(t){var e=i("scripts",this.env).slice();return t&&(e=e.concat(this.$getScriptsForPageOnly(t))),e}),$getScriptsForPageOnly:u.Fn.memoize(function(t){var e=this.pages[t],n=[];if(null==e)return m.error("<page:scripts> Page not defined",t),null;if(null!=e.scripts&&(n=n.concat(i("page",this.env,e.scripts,e.routes))),null!=e.env&&(n=n.concat(i("scripts",this.env,e.env))),e.view&&e.view.controller){var r=this.$formatPath(this.page.location.viewController,e.view.controller);n.push(r)}return n}),$getStyles:function(t){var e=this,n=i("styles",e.env).slice();return t&&(n=n.concat(this.$getStylesForPageOnly(t))),n},$getStylesForPageOnly:function(t){var e=this,n=e.pages[t],r=[];if(null==n)return m.error("<page:styles> Page not defined",t),null;if(n.styles&&(r=r.concat(i("page",e.env,n.styles,n.routes))),n.env&&(r=r.concat(i("styles",e.env,n.env))),n.compo){var s=this.$getCompo(n),o=p.getResource(s);null!=o?o.includes.forEach(function(t){"css"===t.resource.type&&r.push(t.resource.url)}):m.error("<page:styles> compo resource is undefined",s)}if(n.view&&n.view.style){var s=this.$formatPath(this.page.location.viewStyle,n.view.style);r.push(s)}return r},$getInclude:function(){var e=this.env,n={src:"",routes:{},cfg:{}};return t(n,e.both.include),t(n,e.client.include),n.src||(console.error("[CLIENT CONFIGURATION ERROR]"),console.error("- Include PATH is not specified in `env:client:include:src`")),t(n,{routes:e.both.routes}),t(n,{routes:e.client.routes}),n},$getIncludeForPageOnly:function(e){var n=this.pages[e],r={};return n&&n.include?t(r,n.include):r},$getTemplate:function(t){var e=t.template||this.page.index.template,n=this.page.location.template,r=this.$formatPath(n,e);return F.combine(this.base,r)},$getMaster:function(t){var e=t.master||this.page.index.master,n=this.page.location.master,r=this.$formatPath(n,e);return F.combine(this.base,r)},$getController:function(t){var e=t.controller||this.page.index.controller;if(null==e)return null;var n=this.page.location.controller,r=this.$formatPath(n,e);return F.combine(this.base,r)},$getCompo:function(t){var e=t.compo;if(null==e)return null;var n=this.page.location.compo||this.page.location.controller,r=this.$formatPath(n,e);return F.combine(this.base,r)},$getImports:function(t){function e(t){var e=/\w+$/.exec(t);if(null==e)return m.error("Not parsable extension",t),"unknown";for(var n in s)if(s[n].indexOf(e)>-1)return n;return m.error("Unknown extension",t),"uknown"}var r=this.env.both.imports,i=this.env[t].imports,s={mask:" mask ",script:" js es6 jsx ",style:" css less sass scss "};return n(r).concat(n(i)).map(function(t){return{path:t,type:e(t)}})}},i=u.Fn.memoize(function(t,e,n,r){function i(t){if(null!=t)for(var e in t)o.register(e,t[e])}function s(t){null!=t&&o.each("js",t,function(t,e){a.push(e.path)})}var o=new d.Routes,a=[];switch(i(e.client&&e.client.routes),i(e.both&&e.both.routes),i(r),t){case"page":s(n);break;case"debug":s(e.client.debug);break;case"scripts":case"styles":var u=n||e;s(u.client&&u.client[t]),s(u.both&&u.both[t]);break;default:m.error("Unsupported type",t)}return a});return function(){function t(t,e){var i=[];for(var s in t)i=i.concat(n(t[s],r(e,s)));return i}function e(t,e){for(var r=[],i=t.length,s=-1;++s<i;)r=r.concat(n(t[s],e));return r}function r(t,e){return null==t||null==e?t||e:F.combine(t,e)}n=function(n,i){return null==n?[]:"string"==typeof n?r(i,n):c.is.Array(n)?e(n,i):c.is.Object(n)?t(n,i):void 0}}(),r}(),x=function(){function t(s){if(null!=s)if(n(s)){for(var o,a=s,u=s.length,l=0;l<u;l++)if(null!=(o=a[l])&&"string"!=typeof o){var c=r(o);if(null!=c)if(i(c)){var f=e(a,l,c.value);u+=f,l+=f}else a.splice(l,1),l--,u--;else t(o)}}else if("object"==typeof s)for(var h in s)t(s[h])}function e(t,e,r){return n(r)?(Array.prototype.splice.apply(t,[e,1].concat(r)),r.length):(t.splice(e,1,r),1)}function r(t){for(var e in t)return"if#"!==e.substring(0,3)?null:{key:e.substring(3),value:t[e]};return null}function i(t){return s.args[t.key]}return{prepair:function(e){t(e)}}}();S=function(t,n,s,a){t=t||{};var c,p,d=t.base,m=t.configs,y=!0===t.disablePackageJson;d=null==d?"file://"+A(process.cwd())+"/":H(d+"/"),m=i(d,m,e),m&&(c=d+(t.buildDirectory||r)),t.config&&(p={config:t.config});var C=[{config:JSON.parse(o)},c?{path:c,optional:!0}:null,{config:w},y?null:{path:d+"package.json",getterProperty:"atma",optional:!0},{config:P},p];return m&&(C=C.concat(m)),Array.isArray(t.sources)&&(C=C.concat(t.sources)),C.push({config:{base:d}}),require("appcfg").fetch(C).fail(function(t){throw new Error("<app:configuration>",t)}).done(function(){var t=this;new u.Await(f(t),l(t),h(t,n),v(t,n),g(t,n),b(t,n)).always(function(){null!=s&&process.nextTick(s)})})}}(),b.HttpSubApplication=function(){function t(t,e){t.url=t.url.replace(e.path_,"/")}var n="loading",r="loaded";return u({status:"",app_:null,Construct:function(t,e,i){if("/"!==t[0]&&(t="/"+t),"/"!==t[t.length-1]&&(t+="/"),this.path_=t,this.dfr=new u.Deferred,e instanceof b.Application)return this.app_=e,void(this.status=r);var s=e.controller||e,o=this;if(y(s)){this.status=n;var a=i.config.base||i.base||"/";return void p.instance(a).setBase(a).js(s+"::App").done(function(t){if(t.App instanceof b.Application)return void t.App.done(function(t){o.app_=t,o.process=o.pipe,o.status=r,o.dfr.resolve()});o.status="error"})}var l=e.configs,c=e.config;null==c&&null==l&&(l=t),this.status=n,b.Application({configs:l,config:c}).done(function(t){o.app_=t,o.process=o.pipe,o.status=r,o.dfr.resolve()})},process:function(t,e){return this.status===n?void this.dfr.done(this.pipe.bind(this,t,e)):this.status===r?void this.pipe(t,e):(e.writeHead(500,{"Content-Type":"text/plain"}),void e.end("<Sub Application Errored> "+this.path_))},pipe:function(e,n){if(e.url.length<this.path_.length)return n.writeHead(301,{Location:this.path_}),void n.end();t(e,this),this.app_.process(e,n)},execute:function(n,r){t(n,this),e(this.app_,n,r)}})}();var E={};!function(){E.Request=u({Construct:function(t,e,n,r){this.url=t,this.method=(e||"GET").toUpperCase(),this.body=n,this.headers=r}}),E.Response=u({Extends:[u.EventEmitter,u.Deferred],writable:!0,finished:!1,statusCode:null,Construct:function(){this.body="",this.headers={}},Override:{resolve:function(t,e,n,r){this.super(t||this.body,e||this.statusCode||200,n,r||this.headers)},reject:function(t,e){this.super(t||this.body,e||t.statusCode||this.statusCode||500)}},writeHead:function(t){if(!1!==this.writable){var e;3===arguments.length&&(arguments[1],e=arguments[2]),2===arguments.length&&(e=arguments[1]),this.statusCode=t,j(this.headers,e)}},setHeader:function(){},end:function(t){!0!==this.finished&&(this.write(t),this.finished=!0,this.writable=!1,this.resolve(this.body,this.statusCode,null,this.headers))},write:function(t){if(!1!==this.writable&&null!=t)return null==this.body?void(this.body=t):w(this.body.concat)?void(this.body=this.body.concat(t)):void(this.body=[this.body,t])}})}(),b.Application=u({Extends:u.Deferred,isRoot:!1,handlers:null,_server:null,_innerPipe:null,_outerPipe:null,_responder:null,_responders:null,middleware:null,resources:null,lib:null,webSockets:null,Construct:function(t){return null==t&&(t={}),this instanceof b.Application==!1?new b.Application(t):(null==s&&(s=this),this.isRoot=this===s,this.handlers=new Z(this),this.webSockets=Q(this),this.args=j(t.args,r()),this._baseConfig=t,this._loadConfig(),this.isRoot&&!0!==O()&&m.cfg("color","none"),this.process=this.process.bind(this),this)},respond:function(t,e,n){this.process(t,e,n)},responder:function(e){return this._innerPipe=L.create(e&&e.middleware),t(this)},responders:function(t){this._outerPipe=new L(t)},processor:function(e){e=e||{};var n=e.before,r=e.after,i=e.middleware;return this._outerPipe=L.create(n||[]),this._innerPipe=L.create(i),this._outerPipe.add(t(this)),this._outerPipe.add(r),this},process:function(t,e,n){null==this._outerPipe&&this.processor(),this._outerPipe.process(t,e,n||this._404,this.config)},execute:function(t,n,r,i){var s=new E.Request(t,n,r,i),o=new E.Response;return e(this,s,o),o},autoreload:function(t){this._server=this._server||t,null!=this._server&&X.enable(this)},listen:function(){for(var t,e,n,r=arguments.length;--r>-1;)if(null!=(n=arguments[r]))switch(typeof n){case"number":case"string":t=n;break;default:n.listen&&(e=n)}if(null==t&&(t=this.config.$get("port")),null==t)throw Error("Port number is not defined");return null==e&&(e=require("http").createServer()),this._server=e.on("request",this.process).listen(t),this.webSockets.hasHandlers()&&this.webSockets.listen(this._server),O()&&this.autoreload(),k.trigger("listen",this),this._server},getSubApp:function(t){var e=this.handlers.subapps.get(t);return e&&e.value&&e.value.app_},Self:{_loadConfig:function(){var t=this._baseConfig;return this.config=S(t,this,P(this),function(t){m.warn("Configuration Error").error(t)}),this},_404:function(t,e,n){t=null==t?W("Endpoint not found: "+e.url,404):W.create(t);var r=e.headers.accept;if(null==r||-1!==r.indexOf("text/html"))return void b.HttpErrorPage.send(t,e,n,this.config);T(n,t)}},Static:{on:k.on.bind(k),off:k.off.bind(k),once:k.once.bind(k),trigger:k.trigger.bind(k),Config:S}})}(),p.cfg({loader:{coffee:{process:function(t,e){return require("coffee").compile(t)}}}}),p.cfg({loader:{less:{process:function(t,e,n){var r=e.path_getFile(),i=e.path_getDir();new(require("less").Parser)({filename:r,paths:[i]}).parse(t,function(t,e){var i;if(t)return void m.error("<less:parse>",r,t);try{i=e.toCSS()}catch(t){m.error("<less:toCss>",r,t)}n(i)})}}}}),p.cfg({loader:{yml:{process:function(t,e){var n=require("yamljs");t=t.replace(/\t/g,"  ");try{return n.parse(t)}catch(t){return m.error("<yml parser>",t),null}}}}});var X;!function(){function t(t){return function(e){t.defer()._loadConfig().done(function(){X.fileChanged(e)})}}X={enabled:!1,enable:function(e){this.enabled=!0,e.webSockets.registerHandler("/browser",n);var r=new a.Directory("server/config/");return r.exists()&&r.watch(t(e)),p.cfg("autoreload",this),c.cfg("allowCache",!1),this.base=e.config.base,this},watch:function(t,e){if(!1!==/\.[\w]+$/.test(t)){var n=t.indexOf("?");-1!==n&&(t=t.substring(0,n));var r=e.static||e.base||"/",i=F.combine(r,t),s=new a.File(i);s.requestedUrl=t,this.watchFile(s)}},watchFile:function(t){t.uri&&t.uri.file&&(/\.map$/.test(t.uri.file)||e.isWatching(t)||!1!==a.File.prototype.exists.call(t)&&e.watch(t))},unwatch:function(t){e.unwatch(new a.File(t))},fileChanged:function(t,n){e.fileChanged(t,n,null,this.base)},isWatching:function(t){return"string"==typeof t&&(t=new a.File(t)),e.isWatching(t)},listenDirectory:function(t,e){new a.Directory(t).watch(e)},getWatcher:function(){return e}};var e;!function(){e=new(u({Base:u.EventEmitter,watch:function(t){var e=t.uri.toString();if(null==r[e]){var i;i=new n(t),i.bind(this.fileChanged),r[e]=i}},unwatch:function(t,e){var n=t.uri.toString();if(null==r[n])return void m.log("<watcher> No watchers",n);r[n].unbind(e),delete r[n]},isWatching:function(t){var e=t.uri.toString();return null!=r[e]},Self:{fileChanged:function(e,n,r,i){if(c.Module.clearCache&&c.Module.clearCache(),"filewatcher"===n){var s=r||"/"+e.replace(t,"");return void(null==p.getResource(s)&&this.trigger("fileChange",s,e))}this.isWatching(new a.File(e))||(i&&(i=new F(i).toLocalFile(),e=e.replace(i,"")),this.trigger("fileChange",e))}},bind:function(t){return this.on("fileChange",t)},unbind:function(t){return this.off("fileChange",t)}}));var t=A(process.cwd()+"/"),n=u({Base:u.EventEmitter,Construct:function(t){this.active=!1,this.file=t},Self:{fileChanged:function(t){m.log("<watcher:changed>",t),this.trigger("fileChange",t,"filewatcher",this.file.requestedUrl)}},bind:function(t){this.on("fileChange",t),this.active||(a.watcher.watch(this.file.uri.toLocalFile(),this.fileChanged),this.active=!0)},unbind:function(t){this.off("fileChange",t),0===this._listeners.length&&a.watcher.unwatch(this.file.uri.toLocalFile())}}),r={}}();var n=u({Construct:function(t){m.log("<autoreload> Socket connected"),this.socket=t,t.on("disconnect",this.disconnected),e.on("fileChange",this.fileChanged)},Self:{fileChanged:function(t){var e=this.socket;setTimeout(function(){m.log("<autoreload sockets> path",t),e.emit("filechange",t)},50)},disconnected:function(){e.off("fileChange",this.fileChanged)}}});H("/")}();if(function(){!function(){function t(){return e=require("static-content"),O()&&e.on("file",function(t){X.watchFile(t)}),e}S(b,"StaticContent",function(){return t()});var e;X.getWatcher().on("fileChange",function(t,n){null!=e&&e.Cache.remove(n)})}()}(),b.middleware={},function(){b.middleware.query=function(e,n,r){var i=e.url,s=i.indexOf("?");e.query=-1===s?{}:t(i.substring(s+1)),r()};var t=l.$utils.query.deserialize}(),function(){function t(t,n,r,i){null==e&&(e=b.StaticContent.respond),e(t,n,r,i)}b.middleware.static=t,t.config=function(t){return e=b.StaticContent.create(t)};var e=null}(),function(){Z.Handlers.MaskRunner=u({Extends:b.IHttpHandler,app:null,Construct:function(t,e){this.app=e,this.route=t},process:function(t,e,n){var r=t.url.replace(/\.\w+$/,""),i={current:this.route.current,value:{template:r,master:null}};return new b.HttpPage(i,this.app).process(t,e,n).pipe(this),this}})}(),o=['{"env":{"both":{"include":{"cfg":null},"routes":null,"scripts":null},"client":{"include":{"cfg":null,"src":"/bower_components/includejs/lib/include.js"},"mask":{"cfg":null,"src":null},"scripts":null,"styles":null,"routes":null},"server":{"routes":null,"scripts":null}},"handler":{"location":"/server/http/handler/{0}.js"},"handlers":{"(\\\\.mr$|\\\\.mr\\\\?.+)":"/{self}.MaskRunner"},"mask":{"compos":{":scripts":{"mode":"server:all"},":styles":{"mode":"server:all"},":template":{"mode":"server"},"layout:master":{"mode":"server"},"layout:view":{"mode":"server"},":animation":{"mode":"client"}},"attributes":null},"page":{"location":{"controller":"/server/http/page/{0}/{1}.js","template":"/server/http/page/{0}/{1}.mask","master":"/server/http/master/{0}.mask","viewTemplate":"/public/view/{0}/{1}.mask","viewController":"/public/view/{0}/{1}.js","viewStyle":"/public/view/{0}/{1}.less","pageFiles":"/public/pages/"},"extension":{"javascript":"js","style":"less","template":"mask"},"index":{"template":"index","master":"default"},"urls":{"login":"/login"},"pattern":"/:view/:category/:section"},"pages":{"/":{"id":"index","title":"Default Title"}},"service":{"location":"/server/http/service/{0}.js"},"services":null,"view":{"location":{"template":"/public/view/{0}/{1}.mask","controller":"/public/view/{0}/{1}.js","style":"/public/view/{0}/{1}.less"}},"websocket":{"location":"/server/http/websocket/{0}.js"},"websockets":null}'][0],null!=e.atma&&"object"==typeof e.atma)return e.atma.server?void j(e.atma.server,b):void(e.atma.server=b);e.atma={server:b}});
//# sourceMappingURL=server.min.js.map