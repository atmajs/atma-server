(function(e,r){"use strict";var t,n;"undefined"==typeof exports||e!==exports&&null!=e&&e!==global||(t=n=global),null==t&&(t="undefined"==typeof window?global:window),null==n&&(n=e||t),r(t,n)})(this,function(e,r){"use strict";function t(e,r){if(null==e&&(e={}),null==r)return e;for(var t in r)e[t]=r[t];return e}function n(){for(var e,r=process.argv,t=r.length,n=2,i={args:[]};t>n;n++)if(e=r[n],"-"!==e[0]){var o=e.indexOf("=");-1===o?i.args.push(e):i[e.substring(0,o)]=e.substring(o+1)}else i[e.replace(/^[\-]+/,"")]=!0;return i}var i,o,s,l,u={};e.include&&e.net&&e.net.Uri&&(o=e),null==o&&e.atma&&(o=e.atma),null==o&&(require("atma-libs/globals-dev"),o=e),e.logger&&(l=e.logger),null==l&&(require("atma-logger"),l=e.logger),e.io&&e.io.File&&(s=e.io),null==s&&(require("atma-io"),s=e.io);var a=(o.net,o.Class),c=o.ruta,f=o.mask,g=o.include,d=c.Collection,l=e.logger,v=function(){function e(e,r){for(var t,n=e.handlers,i=0,o=n.length;o>i;i++)if(t=n[i],t.matcher.test(r))return t.handler;return null}function r(e,r){var t=e.services,n=t.get(r);return n}function t(e,r){if(47===e.charCodeAt(0))return e;var t=r&&r.location;if(null==t)return console.error("[Handler] Path is relative but no location. Set handler: {location: X} in config"),e;var n,i,o=e.split("/"),n=t.split(/[\{\}]/g);for(e=n[0],i=1;n.length>i;i++)if(0===i%2)e+=n[i];else{var s=n[i]<<0;if(s>o.length-1&&(s=o.length-1),e+=o[s],i===n.length-2)for(s++;o.length>s;s++)e+="/"+o[s]}return e}function n(e,r){return RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),r)}return a({Construct:function(){this.handlers=[],this.services=new d,this.pages=new d},registerPages:function(e){var r,t;for(t in e)r=e[t],this.pages.add(r.path,r);return this},registerHandlers:function(e,r){for(var i in e)this.handlers.push({matcher:n(i),handler:t(e[i],r)});return this},registerServices:function(e,r){for(var n in e)this.services.add(n,t(e[n],r));return this},get:function(t,n){var i=e(this,t.url);if(i)return"string"==typeof i?(g.instance().js(i+"::Handler").done(function(e){n(new e.Handler)}),void 0):(n(i),void 0);var o=r(this,t.url);if(o){var s=o.value;return"string"==typeof s?(g.instance().js(s+"::Service").done(function(e){n(new e.Service)}),void 0):(n(s),void 0)}var o=this.pages.get(t.url);if(o){var l=o.value;return n(new u.HttpPage(l)),void 0}n(null)}})}();return u.IHttpHandler=a({Extends:a.Deferred,process:function(){this.reject("Not Implemented",500)}}),u.HttpPage=function(){var e=function(){var e={getScripts:function(e){var t=r("scripts",e).slice();return this.data.controller&&t.push("/public/view/"+this.data.view+"/"+this.data.controller+".js"),t},getStyles:function(e){var t=r("styles",e);return t}},r=a.Fn.memoize(function(e,r){function t(e){if(null!=e)for(var r in e)i.register(r,e[r])}function n(e){null!=e&&i.each("js",e,function(e,r){o.push(r.path)})}var i=new includeLib.Routes,o=[];return t(r.client.routes),t(r.both.routes),n(r.client[e]),n(r.both[e]),o});return e}(),r=a({Extends:[a.Deferred,e],template:null,master:null,route:null,Construct:function(e){var r=app.config.page;this.template=r.getTemplate(e)+"::Template",this.master=r.getMaster(e)+"::Master",this.route=r.route,this.data=e},process:function(e,r){return this.onRenderStart&&this.onRenderStart(e,r),this.query=c.parse(this.route,e.url).params,this.cntx={req:e,res:r,page:this},this.load(this.response),this},load:function(){g.instance().load(this.master,this.template).done(this.response)},Self:{response:function(e){var r=e.load.Master,t=e.load.Template;if("master"===this.query.debug)return this.resolve(r),void 0;if("template"===this.query.debug)return this.resolve(t),void 0;this.query.breakOn&&(this.cntx.debug={breakOn:this.query.breakOn}),r&&f.render(f.parse(r));var n=f.render(t,this.model,this.cntx);return this.cntx.async?(this.cntx.done(this.resolve.bind(this)).fail(this.fail.bind(this)),void 0):(this.resolve(n),void 0)}}});return r}(),u.HttpService=function(){var e={Extends:a.Deferred,process:function(e,r){var t=e.url,n=this.routes.get(t);if(null==n)return this.reject("Service Endpoint not Found: "+t,404),this;var i=n.value;return i.call(this,e,r),this}};return function(r){var t,n,i=new c.Collection;for(t in r)n=t[0],("/"===n||"!"===n)&&i.add(t,r[t]);r.routes=i;for(t in e)r[t]=e[t];return a(r)}}(),function(){function r(e){return function(r,t,n){g.instance().js(e.config.env.server.scripts).js(e.config.env.both.scripts).done(function(){e.handlers.get(r,function(e){return null==e?(n(),void 0):(l(95).log("<request>",r.url),e.process(r,t).done(function(e,r,n,i){if(r&&(t.statusCode=r),"string"==typeof n&&t.setHeader("Content-Type",n),i)for(var o in i)t.setHeader(o,i[o]);t.end(e)}).fail(function(e,r){t.statusCode=r,t.end(e)}),void 0)})})}}function t(e){return function(){var r=e.config;l(90).log("<app.config>",r),e.handlers.registerHandlers(r.handlers,r.handler).registerServices(r.services,r.service).registerPages(r.pages),e.resolve(e)}}var o=function(){function r(e,r){var n={env:{client:{routes:null,scripts:null,styles:null},server:{routes:null,scripts:null},both:{routes:null,scripts:null}},page:{location:null,include:null},pages:null,handler:{location:null},handlers:null,service:{location:null},services:null,passport:{},app:{}};return t(n,e,r)}function t(e,r,t){return Array.isArray(r)===!1?(t("[Application.Config] should be an array of file names"),e):(r=r.map(function(e){return"/server/config/"+e+".yml::"+e.replace(/\//g,".")}),g.instance().load(r).done(n(e,t)),e)}function n(e,r){function t(e,r,n){if(null!=n&&-1!==n.indexOf(".")){for(var i=n.split("."),o=i.length-1,s=0;o>s;s++)e=e[i[s]]||(e[i[s]]={});t(e,r)}else for(var l in r)e[l]=r[l]}return function(n){var i,o,s=n.load;for(i in s)o=s[i],null!=o&&t(e,o,i);e["compos-info"]&&f.compoDefinitions(e["compos-info"]),e.env.both.routes&&g.routes(e.env.both.routes),e.env.both.include&&g.cfg(e.env.both.include.cfg),e.env.server.include&&g.cfg(e.env.server.include.cfg),e.env.server.routes&&g.routes(e.env.server.routes);var l=e.pages;if(l){var a,c;for(a in l)c=l[a],c.path=a,null==c.id&&(c.id=a.substring(a.indexOf("/")+1)),""===c.id&&(c.id=c.view||"index"),null==c.view&&(c.view=c.id);for(a in l)c=l[a],l[c.id]=c,delete l[a]}u(e),r()}}var o=function(){function e(r,t){if(null!=r)for(var n in t)"object"!=typeof t[n]?"function"!=typeof t[n]||(r[n]=t[n]):e(r[n],t[n])}var r,t=function(){return{format:function(e,r){if(47===r.charCodeAt(0))return r;var t,n,i=r.split("/"),t=e.split(/[\{\}]/g);for(r=t[0],n=1;t.length>n;n++)if(0===n%2)r+=t[n];else{var o=t[n]<<0;if(o>i.length-1&&(o=i.length-1),r+=i[o],n===t.length-2)for(o++;i.length>o;o++)r+="/"+i[o]}return r}}}(),n=function(){function e(e,t){return null==t?e:"string"==typeof t?(e.src=t,e):(t.src&&(e.src=t.src),t.cfg&&(e.cfg=r(e.cfg,t.cfg,"loader"),t.cfg.loader&&(e.cfg.loader=r(e.cfg.loader,t.cfg.loader))),t.routes&&r(e.routes,t.routes),e)}function r(e,r,t){if(null==r)return e;null==e&&(e={});for(var n in r)n!==t&&(e[n]=r[n]);return e}var t={getScripts:a.Fn.memoize(function(e){var r=i.config,t=n("scripts",r.env).slice();return e&&(t=t.concat(this.getScriptsForPageOnly(e))),t}),getScriptsForPageOnly:a.Fn.memoize(function(e){var r=i.config,t=r.pages[e],o=[];if(null==t)return l.error("<page:scripts> Page not defined",e),null;if(t.scripts&&(o=o.concat(n("page",r.env,t.scripts,t.routes))),t.view&&t.view.controller){var s=r.formatPath(this.location.viewController,t.view.controller);o.push(s)}return o}),getStyles:function(e){var r=i.config,t=n("styles",r.env).slice(),o=r.pages[e];if(null==o)return e&&console.error("[404] Page is not defined",e),t;if(o.styles){var s=n("page",r.env,o.styles,o.routes);Array.prototype.push.apply(t,s)}return t},getStylesForPageOnly:function(e){var r=i.config,t=r.pages[e];return t&&t.styles?n("page",r.env,t.styles,t.routes).slice():[]},getInclude:function(){var r=i.config.env,t={src:"",routes:{},cfg:{}};return e(t,r.both.include),e(t,r.client.include),t.src||console.error('[FATAL ERROR] Include PATH is not specified, use in client.yml/json include: { src: "PATH" }'),e(t,{routes:r.both.routes}),e(t,{routes:r.client.routes}),t},getIncludeForPageOnly:function(r){var t=i.config.pages[r],n={};return t&&t.include?e(n,t.include):n},getTemplate:function(e){var r=e.template||this.index.template;return i.config.formatPath(this.location.template,r)},getMaster:function(e){var r=e.master||this.index.master;return i.config.formatPath(this.location.master,r)}},n=a.Fn.memoize(function(e,r,t,n){function i(e){if(null!=e)for(var r in e)s.register(r,e[r])}function o(e){null!=e&&s.each("js",e,function(e,r){l.push(r.path)})}var s=new includeLib.Routes,l=[];return i(r.client.routes),i(r.both.routes),"page"===e?(i(n),o(t),l):(o(r.client[e]),o(r.both[e]),l)});return t}(),o={page:n,formatPath:t.format};return{attach:function(t){r=t,e(t,o)}}}(),u=o.attach;return r.getList=function(r){if(null==e.io||null==s.Directory)return console.error("atma-io seems to be not loaded"),null;var t=s.env.currentDir.combine(r),n=new s.Directory(t).readFiles("**.yml").files.map(function(e){return e.uri.toRelativeString(t).replace(".yml","")});return n},r}();u.Application=a({Extends:a.Deferred,Construct:function(e){if(null==e&&(e={}),this instanceof u.Application==!1)return new u.Application(e);i=this,this.handlers=new v;var r=e.configs||"server/config/",s=e.configs;return null==s&&(s=o.getList(r)),this.config=o(s,t(this)),this.args=n(),this},responder:function(){return r(this)}})}(),g.cfg({loader:{coffee:{process:function(e){return require("coffee").compile(e)}}}}),g.cfg({loader:{less:{process:function(e,r,t){var n=r.path_getFile(),i=r.path_getDir(),o=require("less"),s=new o.Parser({filename:n,paths:[i]});s.parse(e,function(e,r){var i;if(e)return l.error("<less:parse>",n,e),void 0;try{i=r.toCSS()}catch(e){l.error("<less:toCss>",n,e)}t(i)})}}}}),g.cfg({loader:{yml:{process:function(e){var r=require("yamljs");e=e.replace(/\t/g,"  ");try{return r.parse(e)}catch(t){return l.error("<yml parser>",t),null}}}}}),null!=r.atma&&"object"==typeof r.atma?(t(r.atma,u),void 0):(r.atma={server:u},void 0)});