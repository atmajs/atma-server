(function(e,n){"use strict";var r,t;"undefined"==typeof exports||e!==exports&&null!=e&&e!==global||(r=t=global),null==r&&(r="undefined"==typeof window?global:window),null==t&&(t=e||r),n(r,t)})(this,function(e,n){"use strict";function r(e,n){if(null==e&&(e={}),null==n)return e;for(var r in n)e[r]=n[r];return e}function t(){for(var e,n=process.argv,r=n.length,t=2,i={args:[]};r>t;t++)if(e=n[t],"-"!==e[0]){var o=e.indexOf("=");-1===o?i.args.push(e):i[e.substring(0,o)]=e.substring(o+1)}else i[e.replace(/^[\-]+/,"")]=!0;return i}var i,o,l,o={};e.include&&e.net&&e.net.URI&&(i=e),null==i&&e.atma&&(i=e.atma),null==i&&(require("atma-libs/globals"),i=e),e.logger&&(l=e.logger),null==l&&(require("atma-logger"),l=e.logger),e.io&&e.io.File&&(o=e.io),null==o&&(require("atma-io"),o=e.io);var s=(i.net,i.Class),u=i.ruta,a=u.Collection,l=e.logger,c={};return function(){function n(e){return function(n,r,t){include.instance().js(e.config.env.server.scripts).js(e.config.env.both.scripts).done(function(){e.handlers.get(n,function(e){return null==e?(t(),void 0):(e.process(n,r).done(function(e,n,t,i){if(n&&(r.statusCode=n),"string"==typeof t&&r.setHeader("Content-Type",t),i)for(var o in i)r.setHeader(o,i[o]);r.end(e)}).fail(function(e,n){r.statusCode=n,r.end(e)}),void 0)})})}}function r(e){return function(){var n=e.config;e.handlers.registerHandlers(n.handlers,n.handler).registerServices(n.services,n.service).registerPages(n.pages),e.resolve(e)}}var i=function(){function e(e,n){for(var r,t=e.handlers,i=0,o=t.length;o>i;i++)if(r=t[i],r.matcher.test(n))return r.handler;return null}function n(e,n){var r=e.services,t=r.get(n);return t}function r(e,n){if(47===e.charCodeAt(0))return e;var r=n&&n.location;if(null==r)return console.error("[Handler] Path is relative but no location. Set handler: {location: X} in config"),e;var t,i,o=e.split("/"),t=r.split(/[\{\}]/g);for(e=t[0],i=1;t.length>i;i++)if(0===i%2)e+=t[i];else{var l=t[i]<<0;if(l>o.length-1&&(l=o.length-1),e+=o[l],i===t.length-2)for(l++;o.length>l;l++)e+="/"+o[l]}return e}function t(e,n){return RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n)}return s({Construct:function(){this.handlers=[],this.services=new a,this.pages=new a},registerPages:function(e){var n,r;for(r in e)n=e[r],this.pages.add(n.path,n);return this},registerHandlers:function(e,n){for(var i in e)this.handlers.push({matcher:t(i),handler:r(e[i],n)});return this},registerServices:function(e,n){for(var t in e)this.services.add(t,r(e[t],n));return this},get:function(r,t){var i=e(this,r.url);if(i)return"string"==typeof i?(include.instance().js(i+"::Handler").done(function(e){t(new e.Handler)}),void 0):(t(i),void 0);var o=n(this,r.url);if(o){var l=o.value;return"string"==typeof l?(include.instance().js(l+"::Service").done(function(e){t(new e.Service)}),void 0):(t(l),void 0)}var o=this.pages.get(r.url);if(o){var s=o.value;return t(new c.Page(s)),void 0}t(null)}})}(),l=function(){function n(e,n){var t={env:{client:{routes:null,scripts:null,styles:null},server:{routes:null,scripts:null},both:{routes:null,scripts:null}},page:{location:null,include:null},pages:null,handler:{location:null},handlers:null,service:{location:null},services:null,passport:{}};return r(t,e,n)}function r(e,n,r){return Array.isArray(n)===!1?(r("[Application.Config] should be an array of file names"),e):(n=n.map(function(e){return"/server/config/"+e+".yml::"+e.replace(/\//g,".")}),include.instance().load(n).done(t(e,r)),e)}function t(e,n){function r(e,n,t){if(null!=t&&-1!==t.indexOf(".")){for(var i=t.split("."),o=i.length-1,l=0;o>l;l++)e=e[i[l]]||(e[i[l]]={});r(e,n)}else for(var s in n)e[s]=n[s]}return function(t){var i,o,s=t.load;for(i in s)o=s[i],null!=o&&r(e,o,i);e["compos-info"]&&mask.compoDefinitions(e["compos-info"]),e.env.both.routes&&include.routes(e.env.both.routes),e.env.both.include&&include.cfg(e.env.both.include.cfg),e.env.server.include&&include.cfg(e.env.server.include.cfg),e.env.server.routes&&include.routes(e.env.server.routes);var u=e.pages;if(u){var a,c;for(a in u)c=u[a],c.path=a,null==c.id&&(c.id=a.substring(a.indexOf("/")+1)),""===c.id&&(c.id=c.view||"index"),null==c.view&&(c.view=c.id);for(a in u)c=u[a],u[c.id]=c,delete u[a]}l(e),n()}}var i=function(){function e(n,r){if(null!=n)for(var t in r)"object"!=typeof r[t]?"function"!=typeof r[t]||(n[t]=r[t]):e(n[t],r[t])}var n,r=function(){return{format:function(e,n){if(47===n.charCodeAt(0))return n;var r,t,i=n.split("/"),r=e.split(/[\{\}]/g);for(n=r[0],t=1;r.length>t;t++)if(0===t%2)n+=r[t];else{var o=r[t]<<0;if(o>i.length-1&&(o=i.length-1),n+=i[o],t===r.length-2)for(o++;i.length>o;o++)n+="/"+i[o]}return n}}}(),t=function(){function e(e,r){return null==r?e:"string"==typeof r?(e.src=r,e):(r.src&&(e.src=r.src),r.cfg&&(e.cfg=n(e.cfg,r.cfg,"loader"),r.cfg.loader&&(e.cfg.loader=n(e.cfg.loader,r.cfg.loader))),r.routes&&n(e.routes,r.routes),e)}function n(e,n,r){if(null==n)return e;null==e&&(e={});for(var t in n)t!==r&&(e[t]=n[t]);return e}var r={getScripts:function(e){var n=app.config,r=t("scripts",n.env).slice(),i=n.pages[e];if(null==i)return e&&console.error("[404] Page is not defined",e),r;if(i.scripts){var o=t("page",n.env,i.scripts,i.routes);Array.prototype.push.apply(r,o)}return r},getScriptsForPageOnly:function(e){var n=app.config,r=n.pages[e],i=[];if(null==r)return i;var o=r.scripts;return o&&(i=t("page",n.env,o,r.routes).slice()),i},getStyles:function(e){var n=app.config,r=t("styles",n.env).slice(),i=n.pages[e];if(null==i)return e&&console.error("[404] Page is not defined",e),r;if(i.styles){var o=t("page",n.env,i.styles,i.routes);Array.prototype.push.apply(r,o)}return r},getStylesForPageOnly:function(e){var n=app.config,r=n.pages[e];return r&&r.styles?t("page",n.env,r.styles,r.routes).slice():[]},getInclude:function(){var n=app.config.env,r={src:"",routes:{},cfg:{}};return e(r,n.both.include),e(r,n.client.include),r.src||console.error('[FATAL ERROR] Include PATH is not specified, use in client.yml/json include: { src: "PATH" }'),e(r,{routes:n.both.routes}),e(r,{routes:n.client.routes}),r},getIncludeForPageOnly:function(n){var r=app.config.pages[n],t={};return r&&r.include?e(t,r.include):t},getTemplate:function(e){var n=e.template||this.index.template;return app.config.formatPath(this.location.template,n)},getMaster:function(e){var n=e.master||this.index.master;return app.config.formatPath(this.location.master,n)}},t=s.Fn.memoize(function(e,n,r,t){function i(e){if(null!=e)for(var n in e)l.register(n,e[n])}function o(e){null!=e&&l.each("js",e,function(e,n){s.push(n.path)})}var l=new includeLib.Routes,s=[];return i(n.client.routes),i(n.both.routes),"page"===e?(i(t),o(r),s):(o(n.client[e]),o(n.both[e]),s)});return r}(),i={page:t,formatPath:r.format};return{attach:function(r){n=r,e(r,i)}}}(),l=i.attach;n.getList=function(n){if(null==e.io||null==o.Directory)return console.error("atma-io seems to be not loaded"),null;var r=o.env.currentDir.combine(n),t=new o.Directory(r).readFiles("**.yml").files.map(function(e){return e.uri.toRelativeString(r).replace(".yml","")});return t}}();c.Application=s({Extends:s.Deferred,Construct:function(e){if(null==e&&(e={}),this instanceof c.Application==!1)return new c.Application(e);this.handlers=new i;var n=e.configs||"server/config/",o=e.configs;return null==o&&(o=l.getList(n)),this.config=l(o,r(this)),this.args=t(),this},responder:function(){return n(this)}})}(),null!=n.atma&&"object"==typeof n.atma?(r(n.atma,i),void 0):(n.atma=i,void 0)});